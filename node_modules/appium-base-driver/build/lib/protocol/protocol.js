"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.routeConfiguringFunction = routeConfiguringFunction;
exports.isSessionCommand = isSessionCommand;
exports.driverShouldDoJwpProxy = driverShouldDoJwpProxy;
exports.IMAGE_ELEMENT_PREFIX = exports.W3C_ELEMENT_KEY = exports.MJSONWP_ELEMENT_KEY = exports.Protocol = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _validators = require("./validators");

var _errors = require("./errors");

var _routes = require("./routes");

var _helpers = require("../basedriver/helpers");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _driver = _interopRequireDefault(require("../basedriver/driver"));

var _lruCache = _interopRequireDefault(require("lru-cache"));

const GENERIC_PROTOCOL = 'GENERIC';

const mjsonwpLog = _appiumSupport.logger.getLogger('MJSONWP');

const w3cLog = _appiumSupport.logger.getLogger('W3C');

const genericProtocolLog = _appiumSupport.logger.getLogger(GENERIC_PROTOCOL);

const JSONWP_SUCCESS_STATUS_CODE = 0;
const LOG_OBJ_LENGTH = 1024;
const MJSONWP_ELEMENT_KEY = 'ELEMENT';
exports.MJSONWP_ELEMENT_KEY = MJSONWP_ELEMENT_KEY;
const W3C_ELEMENT_KEY = 'element-6066-11e4-a52e-4f735466cecf';
exports.W3C_ELEMENT_KEY = W3C_ELEMENT_KEY;
const IMAGE_ELEMENT_PREFIX = 'appium-image-element-';
exports.IMAGE_ELEMENT_PREFIX = IMAGE_ELEMENT_PREFIX;
const CREATE_SESSION_COMMAND = 'createSession';
const DELETE_SESSION_COMMAND = 'deleteSession';
const IMG_EL_BODY_RE = new RegExp(`"(${W3C_ELEMENT_KEY}|${MJSONWP_ELEMENT_KEY})":\s*` + `"${IMAGE_ELEMENT_PREFIX}[^"]+"`);
const IMG_EL_URL_RE = new RegExp(`/(element|screenshot)` + `/${IMAGE_ELEMENT_PREFIX}[^/]+`);

class Protocol {}

exports.Protocol = Protocol;

class SessionsCache {
  constructor(max) {
    this._cache = new _lruCache.default({
      max
    });
  }

  getLogger(sessionId, protocol) {
    if (sessionId) {
      if (this._cache.has(sessionId)) {
        const value = this._cache.get(sessionId);

        if (value.logger) {
          return value.logger;
        }

        protocol = protocol || value.protocol;
      }

      return _appiumSupport.logger.getLogger(`${protocol || GENERIC_PROTOCOL} ` + `(${sessionId.substring(0, Math.min(sessionId.length, 8))})`);
    }

    switch (protocol) {
      case _driver.default.DRIVER_PROTOCOL.W3C:
        return w3cLog;

      case _driver.default.DRIVER_PROTOCOL.MJSONWP:
        return mjsonwpLog;

      default:
        return genericProtocolLog;
    }
  }

  getProtocol(sessionId) {
    return (this._cache.get(sessionId) || {}).protocol;
  }

  putSession(sessionId, value) {
    if (sessionId && value) {
      this._cache.set(sessionId, {
        protocol: value,
        logger: this.getLogger(sessionId, value)
      });
    }

    return value;
  }

  resetLogger(sessionId) {
    if (this._cache.has(sessionId)) {
      this._cache.get(sessionId).logger = null;
    }
  }

}

const SESSIONS_CACHE = new SessionsCache(100);

function extractProtocol(driver, sessionId = null) {
  const dstDriver = _lodash.default.isFunction(driver.driverForSession) ? driver.driverForSession(sessionId) : driver;

  if (dstDriver === driver) {
    return driver.protocol;
  }

  return dstDriver ? dstDriver.protocol : SESSIONS_CACHE.getProtocol(sessionId);
}

function isSessionCommand(command) {
  return !_lodash.default.includes(_routes.NO_SESSION_ID_COMMANDS, command);
}

function wrapParams(paramSets, jsonObj) {
  let res = jsonObj;

  if (_lodash.default.isArray(jsonObj) || !_lodash.default.isObject(jsonObj)) {
    res = {};
    res[paramSets.wrap] = jsonObj;
  }

  return res;
}

function unwrapParams(paramSets, jsonObj) {
  let res = jsonObj;

  if (_lodash.default.isObject(jsonObj)) {
    if (jsonObj[paramSets.unwrap]) {
      res = jsonObj[paramSets.unwrap];
    }
  }

  return res;
}

function checkParams(paramSets, jsonObj, protocol) {
  let requiredParams = [];
  let optionalParams = [];

  let receivedParams = _lodash.default.keys(jsonObj);

  if (paramSets) {
    if (paramSets.required) {
      if (!_lodash.default.isArray(_lodash.default.first(paramSets.required))) {
        requiredParams = [paramSets.required];
      } else {
        requiredParams = paramSets.required;
      }
    }

    if (paramSets.optional) {
      optionalParams = paramSets.optional;
    }

    if (paramSets.validate) {
      let message = paramSets.validate(jsonObj, protocol);

      if (message) {
        throw new _errors.errors.BadParametersError(message, jsonObj);
      }
    }
  }

  if (requiredParams.length === 0) {
    return;
  }

  if (optionalParams.indexOf('sessionId') === -1) {
    optionalParams.push('sessionId');
  }

  if (optionalParams.indexOf('id') === -1) {
    optionalParams.push('id');
  }

  for (let params of requiredParams) {
    if (_lodash.default.difference(receivedParams, params, optionalParams).length === 0 && _lodash.default.difference(params, receivedParams).length === 0) {
      return;
    }
  }

  throw new _errors.errors.BadParametersError(paramSets, receivedParams);
}

function makeArgs(requestParams, jsonObj, payloadParams, protocol) {
  let urlParams = _lodash.default.keys(requestParams).reverse();

  let requiredParams = payloadParams.required;

  if (_lodash.default.isArray(_lodash.default.first(payloadParams.required))) {
    let keys = _lodash.default.keys(jsonObj);

    for (let params of payloadParams.required) {
      if (_lodash.default.without(params, ...keys).length === 0) {
        requiredParams = params;
        break;
      }
    }
  }

  let args;

  if (_lodash.default.isFunction(payloadParams.makeArgs)) {
    args = payloadParams.makeArgs(jsonObj, protocol);
  } else {
    args = _lodash.default.flatten(requiredParams).map(p => jsonObj[p]);

    if (payloadParams.optional) {
      args = args.concat(_lodash.default.flatten(payloadParams.optional).map(p => jsonObj[p]));
    }
  }

  args = args.concat(urlParams.map(u => requestParams[u]));
  return args;
}

function routeConfiguringFunction(driver) {
  if (!driver.sessionExists) {
    throw new Error('Drivers used with MJSONWP must implement `sessionExists`');
  }

  if (!(driver.executeCommand || driver.execute)) {
    throw new Error('Drivers used with MJSONWP must implement `executeCommand` or `execute`');
  }

  return function (app) {
    for (let [path, methods] of _lodash.default.toPairs(_routes.METHOD_MAP)) {
      for (let [method, spec] of _lodash.default.toPairs(methods)) {
        buildHandler(app, method, path, spec, driver, isSessionCommand(spec.command));
      }
    }
  };
}

function buildHandler(app, method, path, spec, driver, isSessCmd) {
  let asyncHandler = async (req, res) => {
    let jsonObj = req.body;
    let httpResBody = {};
    let httpStatus = 200;
    let newSessionId;
    let currentProtocol = extractProtocol(driver, req.params.sessionId);

    try {
      if (isSessCmd && !driver.sessionExists(req.params.sessionId)) {
        throw new _errors.errors.NoSuchDriverError();
      }

      if (isSessCmd && driverShouldDoJwpProxy(driver, req, spec.command)) {
        await doJwpProxy(driver, req, res);
        return;
      }

      if (!spec.command) {
        throw new _errors.errors.NotImplementedError();
      }

      if (spec.payloadParams && spec.payloadParams.wrap) {
        jsonObj = wrapParams(spec.payloadParams, jsonObj);
      }

      if (spec.payloadParams && spec.payloadParams.unwrap) {
        jsonObj = unwrapParams(spec.payloadParams, jsonObj);
      }

      if (spec.command === CREATE_SESSION_COMMAND) {
        currentProtocol = _driver.default.determineProtocol(...makeArgs(req.params, jsonObj, spec.payloadParams || {}));
      }

      checkParams(spec.payloadParams, jsonObj, currentProtocol);
      let args = makeArgs(req.params, jsonObj, spec.payloadParams || {}, currentProtocol);
      let driverRes;

      if (_validators.validators[spec.command]) {
        _validators.validators[spec.command](...args);
      }

      SESSIONS_CACHE.getLogger(req.params.sessionId, currentProtocol).debug(`Calling ` + `${driver.constructor.name}.${spec.command}() with args: ` + _lodash.default.truncate(JSON.stringify(args), {
        length: LOG_OBJ_LENGTH
      }));

      if (driver.executeCommand) {
        driverRes = await driver.executeCommand(spec.command, ...args);
      } else {
        driverRes = await driver.execute(spec.command, ...args);
      }

      currentProtocol = extractProtocol(driver, req.params.sessionId) || currentProtocol;

      if (_lodash.default.isPlainObject(driverRes) && _lodash.default.has(driverRes, 'protocol')) {
        currentProtocol = driverRes.protocol || currentProtocol;

        if (driverRes.error) {
          throw driverRes.error;
        }

        driverRes = driverRes.value;
      }

      if (spec.command === CREATE_SESSION_COMMAND) {
        newSessionId = driverRes[0];
        SESSIONS_CACHE.putSession(newSessionId, currentProtocol);
        SESSIONS_CACHE.getLogger(newSessionId, currentProtocol).debug(`Cached the protocol value '${currentProtocol}' for the new session ${newSessionId}`);

        if (currentProtocol === _driver.default.DRIVER_PROTOCOL.MJSONWP) {
          driverRes = driverRes[1];
        } else if (currentProtocol === _driver.default.DRIVER_PROTOCOL.W3C) {
          driverRes = {
            capabilities: driverRes[1]
          };
        }
      }

      if (driverRes) {
        driverRes = (0, _helpers.duplicateKeys)(driverRes, MJSONWP_ELEMENT_KEY, W3C_ELEMENT_KEY);
      }

      if (_lodash.default.isUndefined(driverRes)) {
        driverRes = null;
      }

      if (spec.command === DELETE_SESSION_COMMAND) {
        SESSIONS_CACHE.getLogger(req.params.sessionId, currentProtocol).debug(`Received response: ${_lodash.default.truncate(JSON.stringify(driverRes), {
          length: LOG_OBJ_LENGTH
        })}`);
        SESSIONS_CACHE.getLogger(req.params.sessionId, currentProtocol).debug('But deleting session, so not returning');
        driverRes = null;
      }

      if (_appiumSupport.util.hasValue(driverRes)) {
        if (_appiumSupport.util.hasValue(driverRes.status) && !isNaN(driverRes.status) && parseInt(driverRes.status, 10) !== 0) {
          throw (0, _errors.errorFromMJSONWPStatusCode)(driverRes.status, driverRes.value);
        } else if (_lodash.default.isPlainObject(driverRes.value) && driverRes.value.error) {
          throw (0, _errors.errorFromW3CJsonCode)(driverRes.value.error, driverRes.value.message, driverRes.value.stacktrace);
        }
      }

      if (currentProtocol !== _driver.default.DRIVER_PROTOCOL.W3C) {
        httpResBody.status = _lodash.default.isNil(driverRes) || _lodash.default.isUndefined(driverRes.status) ? JSONWP_SUCCESS_STATUS_CODE : driverRes.status;
      }

      httpResBody.value = driverRes;
      SESSIONS_CACHE.getLogger(req.params.sessionId || newSessionId, currentProtocol).debug(`Responding ` + `to client with driver.${spec.command}() result: ${_lodash.default.truncate(JSON.stringify(driverRes), {
        length: LOG_OBJ_LENGTH
      })}`);

      if (spec.command === DELETE_SESSION_COMMAND) {
        SESSIONS_CACHE.resetLogger(req.params.sessionId);
      }
    } catch (err) {
      let actualErr = err;
      currentProtocol = currentProtocol || extractProtocol(driver, req.params.sessionId || newSessionId);
      let errMsg = err.stacktrace || err.stack;

      if (!_lodash.default.includes(errMsg, err.message)) {
        errMsg = `${err.message}${errMsg ? '\n' + errMsg : ''}`;
      }

      SESSIONS_CACHE.getLogger(req.params.sessionId || newSessionId, currentProtocol).debug(`Encountered ` + `internal error running command: ${errMsg}`);

      if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
        actualErr = err.getActualError();
      }

      if (currentProtocol === _driver.default.DRIVER_PROTOCOL.W3C) {
        [httpStatus, httpResBody] = (0, _errors.getResponseForW3CError)(actualErr);
      } else if (currentProtocol === _driver.default.DRIVER_PROTOCOL.MJSONWP) {
        [httpStatus, httpResBody] = (0, _errors.getResponseForJsonwpError)(actualErr);
      } else {
        let jsonwpRes = (0, _errors.getResponseForJsonwpError)(actualErr);
        let w3cRes = (0, _errors.getResponseForW3CError)(actualErr);
        httpResBody = (0, _objectSpread2.default)({}, jsonwpRes[1], w3cRes[1]);
        httpStatus = jsonwpRes[0];
      }
    }

    if (_lodash.default.isString(httpResBody)) {
      res.status(httpStatus).send(httpResBody);
    } else {
      if (newSessionId) {
        if (currentProtocol === _driver.default.DRIVER_PROTOCOL.W3C) {
          httpResBody.value.sessionId = newSessionId;
        } else {
          httpResBody.sessionId = newSessionId;
        }
      } else {
        httpResBody.sessionId = req.params.sessionId || null;
      }

      if (currentProtocol === _driver.default.DRIVER_PROTOCOL.W3C) {
        delete httpResBody.sessionId;
      }

      res.status(httpStatus).json(httpResBody);
    }
  };

  app[method.toLowerCase()](path, (req, res) => {
    _bluebird.default.resolve(asyncHandler(req, res)).done();
  });
}

function driverShouldDoJwpProxy(driver, req, command) {
  if (!driver.proxyActive(req.params.sessionId)) {
    return false;
  }

  if (command === 'deleteSession') {
    return false;
  }

  if (driver.proxyRouteIsAvoided(req.params.sessionId, req.method, req.originalUrl)) {
    return false;
  }

  if (IMG_EL_URL_RE.test(req.originalUrl)) {
    return false;
  }

  const stringBody = JSON.stringify(req.body);

  if (stringBody && IMG_EL_BODY_RE.test(stringBody)) {
    return false;
  }

  return true;
}

async function doJwpProxy(driver, req, res) {
  SESSIONS_CACHE.getLogger(req.params.sessionId, extractProtocol(driver, req.params.sessionId)).info('Driver proxy active, passing request on via HTTP proxy');

  if (!driver.canProxy(req.params.sessionId)) {
    throw new Error('Trying to proxy to a JSONWP server but driver is unable to proxy');
  }

  try {
    const proxiedRes = await driver.executeCommand('proxyReqRes', req, res, req.params.sessionId);
    if (proxiedRes && proxiedRes.error) throw proxiedRes.error;
  } catch (err) {
    if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
      throw err;
    } else {
      throw new Error(`Could not proxy. Proxy error: ${err.message}`);
    }
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9wcm90b2NvbC9wcm90b2NvbC5qcyJdLCJuYW1lcyI6WyJHRU5FUklDX1BST1RPQ09MIiwibWpzb253cExvZyIsImxvZ2dlciIsImdldExvZ2dlciIsInczY0xvZyIsImdlbmVyaWNQcm90b2NvbExvZyIsIkpTT05XUF9TVUNDRVNTX1NUQVRVU19DT0RFIiwiTE9HX09CSl9MRU5HVEgiLCJNSlNPTldQX0VMRU1FTlRfS0VZIiwiVzNDX0VMRU1FTlRfS0VZIiwiSU1BR0VfRUxFTUVOVF9QUkVGSVgiLCJDUkVBVEVfU0VTU0lPTl9DT01NQU5EIiwiREVMRVRFX1NFU1NJT05fQ09NTUFORCIsIklNR19FTF9CT0RZX1JFIiwiUmVnRXhwIiwiSU1HX0VMX1VSTF9SRSIsIlByb3RvY29sIiwiU2Vzc2lvbnNDYWNoZSIsImNvbnN0cnVjdG9yIiwibWF4IiwiX2NhY2hlIiwiTFJVIiwic2Vzc2lvbklkIiwicHJvdG9jb2wiLCJoYXMiLCJ2YWx1ZSIsImdldCIsInN1YnN0cmluZyIsIk1hdGgiLCJtaW4iLCJsZW5ndGgiLCJCYXNlRHJpdmVyIiwiRFJJVkVSX1BST1RPQ09MIiwiVzNDIiwiTUpTT05XUCIsImdldFByb3RvY29sIiwicHV0U2Vzc2lvbiIsInNldCIsInJlc2V0TG9nZ2VyIiwiU0VTU0lPTlNfQ0FDSEUiLCJleHRyYWN0UHJvdG9jb2wiLCJkcml2ZXIiLCJkc3REcml2ZXIiLCJfIiwiaXNGdW5jdGlvbiIsImRyaXZlckZvclNlc3Npb24iLCJpc1Nlc3Npb25Db21tYW5kIiwiY29tbWFuZCIsImluY2x1ZGVzIiwiTk9fU0VTU0lPTl9JRF9DT01NQU5EUyIsIndyYXBQYXJhbXMiLCJwYXJhbVNldHMiLCJqc29uT2JqIiwicmVzIiwiaXNBcnJheSIsImlzT2JqZWN0Iiwid3JhcCIsInVud3JhcFBhcmFtcyIsInVud3JhcCIsImNoZWNrUGFyYW1zIiwicmVxdWlyZWRQYXJhbXMiLCJvcHRpb25hbFBhcmFtcyIsInJlY2VpdmVkUGFyYW1zIiwia2V5cyIsInJlcXVpcmVkIiwiZmlyc3QiLCJvcHRpb25hbCIsInZhbGlkYXRlIiwibWVzc2FnZSIsImVycm9ycyIsIkJhZFBhcmFtZXRlcnNFcnJvciIsImluZGV4T2YiLCJwdXNoIiwicGFyYW1zIiwiZGlmZmVyZW5jZSIsIm1ha2VBcmdzIiwicmVxdWVzdFBhcmFtcyIsInBheWxvYWRQYXJhbXMiLCJ1cmxQYXJhbXMiLCJyZXZlcnNlIiwid2l0aG91dCIsImFyZ3MiLCJmbGF0dGVuIiwibWFwIiwicCIsImNvbmNhdCIsInUiLCJyb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24iLCJzZXNzaW9uRXhpc3RzIiwiRXJyb3IiLCJleGVjdXRlQ29tbWFuZCIsImV4ZWN1dGUiLCJhcHAiLCJwYXRoIiwibWV0aG9kcyIsInRvUGFpcnMiLCJNRVRIT0RfTUFQIiwibWV0aG9kIiwic3BlYyIsImJ1aWxkSGFuZGxlciIsImlzU2Vzc0NtZCIsImFzeW5jSGFuZGxlciIsInJlcSIsImJvZHkiLCJodHRwUmVzQm9keSIsImh0dHBTdGF0dXMiLCJuZXdTZXNzaW9uSWQiLCJjdXJyZW50UHJvdG9jb2wiLCJOb1N1Y2hEcml2ZXJFcnJvciIsImRyaXZlclNob3VsZERvSndwUHJveHkiLCJkb0p3cFByb3h5IiwiTm90SW1wbGVtZW50ZWRFcnJvciIsImRldGVybWluZVByb3RvY29sIiwiZHJpdmVyUmVzIiwidmFsaWRhdG9ycyIsImRlYnVnIiwibmFtZSIsInRydW5jYXRlIiwiSlNPTiIsInN0cmluZ2lmeSIsImlzUGxhaW5PYmplY3QiLCJlcnJvciIsImNhcGFiaWxpdGllcyIsImlzVW5kZWZpbmVkIiwidXRpbCIsImhhc1ZhbHVlIiwic3RhdHVzIiwiaXNOYU4iLCJwYXJzZUludCIsInN0YWNrdHJhY2UiLCJpc05pbCIsImVyciIsImFjdHVhbEVyciIsImVyck1zZyIsInN0YWNrIiwiUHJveHlSZXF1ZXN0RXJyb3IiLCJnZXRBY3R1YWxFcnJvciIsImpzb253cFJlcyIsInczY1JlcyIsImlzU3RyaW5nIiwic2VuZCIsImpzb24iLCJ0b0xvd2VyQ2FzZSIsIkIiLCJyZXNvbHZlIiwiZG9uZSIsInByb3h5QWN0aXZlIiwicHJveHlSb3V0ZUlzQXZvaWRlZCIsIm9yaWdpbmFsVXJsIiwidGVzdCIsInN0cmluZ0JvZHkiLCJpbmZvIiwiY2FuUHJveHkiLCJwcm94aWVkUmVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBQUcsU0FBekI7O0FBQ0EsTUFBTUMsVUFBVSxHQUFHQyxzQkFBT0MsU0FBUCxDQUFpQixTQUFqQixDQUFuQjs7QUFDQSxNQUFNQyxNQUFNLEdBQUdGLHNCQUFPQyxTQUFQLENBQWlCLEtBQWpCLENBQWY7O0FBQ0EsTUFBTUUsa0JBQWtCLEdBQUdILHNCQUFPQyxTQUFQLENBQWlCSCxnQkFBakIsQ0FBM0I7O0FBRUEsTUFBTU0sMEJBQTBCLEdBQUcsQ0FBbkM7QUFFQSxNQUFNQyxjQUFjLEdBQUcsSUFBdkI7QUFFQSxNQUFNQyxtQkFBbUIsR0FBRyxTQUE1Qjs7QUFDQSxNQUFNQyxlQUFlLEdBQUcscUNBQXhCOztBQUNBLE1BQU1DLG9CQUFvQixHQUFHLHVCQUE3Qjs7QUFFQSxNQUFNQyxzQkFBc0IsR0FBRyxlQUEvQjtBQUNBLE1BQU1DLHNCQUFzQixHQUFHLGVBQS9CO0FBRUEsTUFBTUMsY0FBYyxHQUFHLElBQUlDLE1BQUosQ0FDcEIsS0FBSUwsZUFBZ0IsSUFBR0QsbUJBQW9CLFFBQTVDLEdBQ0MsSUFBR0Usb0JBQXFCLFFBRkosQ0FBdkI7QUFJQSxNQUFNSyxhQUFhLEdBQUcsSUFBSUQsTUFBSixDQUNuQix1QkFBRCxHQUNDLElBQUdKLG9CQUFxQixPQUZMLENBQXRCOztBQUtBLE1BQU1NLFFBQU4sQ0FBZTs7OztBQUVmLE1BQU1DLGFBQU4sQ0FBb0I7QUFDbEJDLEVBQUFBLFdBQVcsQ0FBRUMsR0FBRixFQUFPO0FBQ2hCLFNBQUtDLE1BQUwsR0FBYyxJQUFJQyxpQkFBSixD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QyxFQUE2QztBQUMzQ2QsRUFBQUEsY0FBYyxDQUFDcEMsU0FBZixDQUF5Qm1HLEdBQUcsQ0FBQzdCLE1BQUosQ0FBV25ELFNBQXBDLEVBQStDa0IsZUFBZSxDQUFDQyxNQUFELEVBQVM2RCxHQUFHLENBQUM3QixNQUFKLENBQVduRCxTQUFwQixDQUE5RCxFQUNHaUksSUFESCxDQUNRLHdEQURSOztBQUlBLE1BQUksQ0FBQzlHLE1BQU0sQ0FBQytHLFFBQVAsQ0FBZ0JsRCxHQUFHLENBQUM3QixNQUFKLENBQVduRCxTQUEzQixDQUFMLEVBQTRDO0FBQzFDLFVBQU0sSUFBSW1FLEtBQUosQ0FBVSxrRUFBVixDQUFOO0FBQ0Q7O0FBQ0QsTUFBSTtBQUNGLFVBQU1nRSxVQUFVLEdBQUcsTUFBTWhILE1BQU0sQ0FBQ2lELGNBQVAsQ0FBc0IsYUFBdEIsRUFBcUNZLEdBQXJDLEVBQTBDakQsR0FBMUMsRUFBK0NpRCxHQUFHLENBQUM3QixNQUFKLENBQVduRCxTQUExRCxDQUF6QjtBQUNBLFFBQUltSSxVQUFVLElBQUlBLFVBQVUsQ0FBQ2hDLEtBQTdCLEVBQW9DLE1BQU1nQyxVQUFVLENBQUNoQyxLQUFqQjtBQUNyQyxHQUhELENBR0UsT0FBT1UsR0FBUCxFQUFZO0FBQ1osUUFBSSx5QkFBWUEsR0FBWixFQUFpQjlELGVBQU9rRSxpQkFBeEIsQ0FBSixFQUFnRDtBQUM5QyxZQUFNSixHQUFOO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsWUFBTSxJQUFJMUMsS0FBSixDQUFXLGlDQUFnQzBDLEdBQUcsQ0FBQy9ELE9BQVEsRUFBdkQsQ0FBTjtBQUNEO0FBQ0Y7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBsb2dnZXIsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyB2YWxpZGF0b3JzIH0gZnJvbSAnLi92YWxpZGF0b3JzJztcbmltcG9ydCB7IGVycm9ycywgaXNFcnJvclR5cGUsIGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlLCBlcnJvckZyb21XM0NKc29uQ29kZSxcbiAgICAgICAgIGdldFJlc3BvbnNlRm9yVzNDRXJyb3IsIGdldFJlc3BvbnNlRm9ySnNvbndwRXJyb3IgfSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgeyBNRVRIT0RfTUFQLCBOT19TRVNTSU9OX0lEX0NPTU1BTkRTIH0gZnJvbSAnLi9yb3V0ZXMnO1xuaW1wb3J0IHsgZHVwbGljYXRlS2V5cyB9IGZyb20gJy4uL2Jhc2Vkcml2ZXIvaGVscGVycyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgQmFzZURyaXZlciBmcm9tICcuLi9iYXNlZHJpdmVyL2RyaXZlcic7XG5pbXBvcnQgTFJVIGZyb20gJ2xydS1jYWNoZSc7XG5cbmNvbnN0IEdFTkVSSUNfUFJPVE9DT0wgPSAnR0VORVJJQyc7XG5jb25zdCBtanNvbndwTG9nID0gbG9nZ2VyLmdldExvZ2dlcignTUpTT05XUCcpO1xuY29uc3QgdzNjTG9nID0gbG9nZ2VyLmdldExvZ2dlcignVzNDJyk7XG5jb25zdCBnZW5lcmljUHJvdG9jb2xMb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKEdFTkVSSUNfUFJPVE9DT0wpO1xuXG5jb25zdCBKU09OV1BfU1VDQ0VTU19TVEFUVVNfQ09ERSA9IDA7XG4vLyBUT0RPOiBNYWtlIHRoaXMgdmFsdWUgY29uZmlndXJhYmxlIGFzIGEgc2VydmVyIHNpZGUgY2FwYWJpbGl0eVxuY29uc3QgTE9HX09CSl9MRU5HVEggPSAxMDI0OyAvLyBNQVggTEVOR1RIIExvZ2dlZCB0byBmaWxlIC8gY29uc29sZVxuXG5jb25zdCBNSlNPTldQX0VMRU1FTlRfS0VZID0gJ0VMRU1FTlQnO1xuY29uc3QgVzNDX0VMRU1FTlRfS0VZID0gJ2VsZW1lbnQtNjA2Ni0xMWU0LWE1MmUtNGY3MzU0NjZjZWNmJztcbmNvbnN0IElNQUdFX0VMRU1FTlRfUFJFRklYID0gJ2FwcGl1bS1pbWFnZS1lbGVtZW50LSc7XG5cbmNvbnN0IENSRUFURV9TRVNTSU9OX0NPTU1BTkQgPSAnY3JlYXRlU2Vzc2lvbic7XG5jb25zdCBERUxFVEVfU0VTU0lPTl9DT01NQU5EID0gJ2RlbGV0ZVNlc3Npb24nO1xuXG5jb25zdCBJTUdfRUxfQk9EWV9SRSA9IG5ldyBSZWdFeHAoXG4gIGBcIigke1czQ19FTEVNRU5UX0tFWX18JHtNSlNPTldQX0VMRU1FTlRfS0VZfSlcIjpcXHMqYCArIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdXNlbGVzcy1lc2NhcGVcbiAgYFwiJHtJTUFHRV9FTEVNRU5UX1BSRUZJWH1bXlwiXStcImBcbik7XG5jb25zdCBJTUdfRUxfVVJMX1JFID0gbmV3IFJlZ0V4cChcbiAgYC8oZWxlbWVudHxzY3JlZW5zaG90KWAgK1xuICBgLyR7SU1BR0VfRUxFTUVOVF9QUkVGSVh9W14vXStgXG4pO1xuXG5jbGFzcyBQcm90b2NvbCB7fVxuXG5jbGFzcyBTZXNzaW9uc0NhY2hlIHtcbiAgY29uc3RydWN0b3IgKG1heCkge1xuICAgIHRoaXMuX2NhY2hlID0gbmV3IExSVSh7IG1heCB9KTtcbiAgfVxuXG4gIGdldExvZ2dlciAoc2Vzc2lvbklkLCBwcm90b2NvbCkge1xuICAgIGlmIChzZXNzaW9uSWQpIHtcbiAgICAgIGlmICh0aGlzLl9jYWNoZS5oYXMoc2Vzc2lvbklkKSkge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2NhY2hlLmdldChzZXNzaW9uSWQpO1xuICAgICAgICBpZiAodmFsdWUubG9nZ2VyKSB7XG4gICAgICAgICAgcmV0dXJuIHZhbHVlLmxvZ2dlcjtcbiAgICAgICAgfVxuICAgICAgICBwcm90b2NvbCA9IHByb3RvY29sIHx8IHZhbHVlLnByb3RvY29sO1xuICAgICAgfVxuICAgICAgLy8gQWx3YXlzIGNyZWF0ZSBhIG5ldyBsb2dnZXIgaW5zdGFuY2UgZm9yIGlkc1xuICAgICAgLy8gdGhhdCBhcmUgbm90IGluIHRoZSBjdXJyZW50IHNlc3Npb25zIGxpc3QsXG4gICAgICAvLyBzbyB3ZSBjYW4gc3RpbGwgc2VlIHN1Y2ggaWRzIGFzIHByZWZpeGVzXG4gICAgICByZXR1cm4gbG9nZ2VyLmdldExvZ2dlcihgJHtwcm90b2NvbCB8fCBHRU5FUklDX1BST1RPQ09MfSBgICtcbiAgICAgICAgYCgke3Nlc3Npb25JZC5zdWJzdHJpbmcoMCwgTWF0aC5taW4oc2Vzc2lvbklkLmxlbmd0aCwgOCkpfSlgKTtcbiAgICB9XG5cbiAgICAvLyBGYWxsIGJhY2sgdG8gcHJvdG9jb2wgbmFtZS1vbmx5IGxvZ2dlciBpZiBzZXNzaW9uIGlkIGlzIHVua25vd25cbiAgICBzd2l0Y2ggKHByb3RvY29sKSB7XG4gICAgICBjYXNlIEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MLlczQzpcbiAgICAgICAgcmV0dXJuIHczY0xvZztcbiAgICAgIGNhc2UgQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuTUpTT05XUDpcbiAgICAgICAgcmV0dXJuIG1qc29ud3BMb2c7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gZ2VuZXJpY1Byb3RvY29sTG9nO1xuICAgIH1cbiAgfVxuXG4gIGdldFByb3RvY29sIChzZXNzaW9uSWQpIHtcbiAgICByZXR1cm4gKHRoaXMuX2NhY2hlLmdldChzZXNzaW9uSWQpIHx8IHt9KS5wcm90b2NvbDtcbiAgfVxuXG4gIHB1dFNlc3Npb24gKHNlc3Npb25JZCwgdmFsdWUpIHtcbiAgICBpZiAoc2Vzc2lvbklkICYmIHZhbHVlKSB7XG4gICAgICB0aGlzLl9jYWNoZS5zZXQoc2Vzc2lvbklkLCB7XG4gICAgICAgIHByb3RvY29sOiB2YWx1ZSxcbiAgICAgICAgLy8gV2UgZG9uJ3Qgd2FudCB0byBjYWNoZSB0aGUgbG9nZ2VyIGluc3RhbmNlIGZvciBlYWNoIHJhbmRvbSBzZXNzaW9uIGlkIGluIHRoZSBjYWNoZVxuICAgICAgICAvLyBpbiBvcmRlciB0byBzYXZlIG1lbW9yeS4gSW5zdGVhZCB3ZSBvbmx5IGNhY2hlIGxvZ2dlcnMgZm9yIHZhbGlkIGlkcyB0aGF0XG4gICAgICAgIC8vIGFyZSByZXR1cm5lZCBieSBgY3JlYXRlU2Vzc2lvbmAgY2FsbCBhbmQgcmVzZXQgdGhlbSBhZnRlciBgZGVsZXRlU2Vzc2lvbmAgaXMgY2FsbGVkXG4gICAgICAgIGxvZ2dlcjogdGhpcy5nZXRMb2dnZXIoc2Vzc2lvbklkLCB2YWx1ZSksXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgcmVzZXRMb2dnZXIgKHNlc3Npb25JZCkge1xuICAgIGlmICh0aGlzLl9jYWNoZS5oYXMoc2Vzc2lvbklkKSkge1xuICAgICAgdGhpcy5fY2FjaGUuZ2V0KHNlc3Npb25JZCkubG9nZ2VyID0gbnVsbDtcbiAgICB9XG4gIH1cbn1cblxuLy8gVGhpcyBjYWNoZSBpcyB1c2VmdWwgd2hlbiBhIHNlc3Npb24gZ2V0cyB0ZXJtaW5hdGVkXG4vLyBhbmQgcmVtb3ZlZCBmcm9tIHRoZSBzZXNzaW9ucyBsaXN0IGluIHRoZSB1bWJyZWxsYSBkcml2ZXIsXG4vLyBidXQgdGhlIGNsaWVudCBzdGlsbCB0cmllcyB0byBzZW5kIGEgY29tbWFuZCB0byB0aGlzIHNlc3Npb24gaWQuXG4vLyBTbyB3ZSBrbm93IGhvdyB0byBwcm9wZXJseSB3cmFwIHRoZSBlcnJvciBtZXNzYWdlIGZvciBpdFxuY29uc3QgU0VTU0lPTlNfQ0FDSEUgPSBuZXcgU2Vzc2lvbnNDYWNoZSgxMDApO1xuXG5cbmZ1bmN0aW9uIGV4dHJhY3RQcm90b2NvbCAoZHJpdmVyLCBzZXNzaW9uSWQgPSBudWxsKSB7XG4gIGNvbnN0IGRzdERyaXZlciA9IF8uaXNGdW5jdGlvbihkcml2ZXIuZHJpdmVyRm9yU2Vzc2lvbilcbiAgICA/IGRyaXZlci5kcml2ZXJGb3JTZXNzaW9uKHNlc3Npb25JZClcbiAgICA6IGRyaXZlcjtcbiAgaWYgKGRzdERyaXZlciA9PT0gZHJpdmVyKSB7XG4gICAgLy8gU2hvcnRjaXJjdWl0IGlmIHRoZSBkcml2ZXIgaW5zdGFuY2UgaXMgbm90IGFuIHVtYnJlbGxhIGRyaXZlclxuICAgIC8vIG9yIGl0IGlzIEZha2UgZHJpdmVyIGluc3RhbmNlLCB3aGVyZSBgZHJpdmVyLmRyaXZlckZvclNlc3Npb25gXG4gICAgLy8gYWx3YXlzIHJldHVybnMgc2VsZiBpbnN0YW5jZVxuICAgIHJldHVybiBkcml2ZXIucHJvdG9jb2w7XG4gIH1cblxuICAvLyBFeHRyYWN0IHRoZSBwcm90b2NvbCBmb3IgdGhlIGN1cnJlbnQgc2Vzc2lvbiBpZiB0aGUgZ2l2ZW4gZHJpdmVyIGlzIHRoZSB1bWJyZWxsYSBvbmVcbiAgcmV0dXJuIGRzdERyaXZlciA/IGRzdERyaXZlci5wcm90b2NvbCA6IFNFU1NJT05TX0NBQ0hFLmdldFByb3RvY29sKHNlc3Npb25JZCk7XG59XG5cbmZ1bmN0aW9uIGlzU2Vzc2lvbkNvbW1hbmQgKGNvbW1hbmQpIHtcbiAgcmV0dXJuICFfLmluY2x1ZGVzKE5PX1NFU1NJT05fSURfQ09NTUFORFMsIGNvbW1hbmQpO1xufVxuXG5mdW5jdGlvbiB3cmFwUGFyYW1zIChwYXJhbVNldHMsIGpzb25PYmopIHtcbiAgLyogVGhlcmUgYXJlIGNvbW1hbmRzIGxpa2UgcGVyZm9ybVRvdWNoIHdoaWNoIHRha2UgYSBzaW5nbGUgcGFyYW1ldGVyIChwcmltaXRpdmUgdHlwZSBvciBhcnJheSkuXG4gICAqIFNvbWUgZHJpdmVycyBjaG9vc2UgdG8gcGFzcyB0aGlzIHBhcmFtZXRlciBhcyBhIHZhbHVlIChlZy4gW2FjdGlvbjEsIGFjdGlvbjIuLi5dKSB3aGlsZSBvdGhlcnMgdG9cbiAgICogd3JhcCBpdCB3aXRoaW4gYW4gb2JqZWN0KGVnJyB7Z2VzdHVyZTogIFthY3Rpb24xLCBhY3Rpb24yLi4uXX0pLCB3aGljaCBtYWtlcyBpdCBoYXJkIHRvIHZhbGlkYXRlLlxuICAgKiBUaGUgd3JhcCBvcHRpb24gaW4gdGhlIHNwZWMgZW5mb3JjZSB3cmFwcGluZyBiZWZvcmUgdmFsaWRhdGlvbiwgc28gdGhhdCBhbGwgcGFyYW1zIGFyZSB3cmFwcGVkIGF0XG4gICAqIHRoZSB0aW1lIHRoZXkgYXJlIHZhbGlkYXRlZCBhbmQgbGF0ZXIgcGFzc2VkIHRvIHRoZSBjb21tYW5kcy5cbiAgICovXG4gIGxldCByZXMgPSBqc29uT2JqO1xuICBpZiAoXy5pc0FycmF5KGpzb25PYmopIHx8ICFfLmlzT2JqZWN0KGpzb25PYmopKSB7XG4gICAgcmVzID0ge307XG4gICAgcmVzW3BhcmFtU2V0cy53cmFwXSA9IGpzb25PYmo7XG4gIH1cbiAgcmV0dXJuIHJlcztcbn1cblxuZnVuY3Rpb24gdW53cmFwUGFyYW1zIChwYXJhbVNldHMsIGpzb25PYmopIHtcbiAgLyogVGhlcmUgYXJlIGNvbW1hbmRzIGxpa2Ugc2V0TmV0d29ya0Nvbm5lY3Rpb24gd2hpY2ggc2VuZCBwYXJhbWV0ZXJzIHdyYXBwZWQgaW5zaWRlIGEga2V5IHN1Y2ggYXNcbiAgICogXCJwYXJhbWV0ZXJzXCIuIFRoaXMgZnVuY3Rpb24gdW53cmFwcyB0aGVtIChlZy4ge1wicGFyYW1ldGVyc1wiOiB7XCJ0eXBlXCI6IDF9fSBiZWNvbWVzIHtcInR5cGVcIjogMX0pLlxuICAgKi9cbiAgbGV0IHJlcyA9IGpzb25PYmo7XG4gIGlmIChfLmlzT2JqZWN0KGpzb25PYmopKSB7XG4gICAgLy8gc29tZSBjbGllbnRzLCBsaWtlIHJ1YnksIGRvbid0IHdyYXBcbiAgICBpZiAoanNvbk9ialtwYXJhbVNldHMudW53cmFwXSkge1xuICAgICAgcmVzID0ganNvbk9ialtwYXJhbVNldHMudW53cmFwXTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlcztcbn1cblxuZnVuY3Rpb24gY2hlY2tQYXJhbXMgKHBhcmFtU2V0cywganNvbk9iaiwgcHJvdG9jb2wpIHtcbiAgbGV0IHJlcXVpcmVkUGFyYW1zID0gW107XG4gIGxldCBvcHRpb25hbFBhcmFtcyA9IFtdO1xuICBsZXQgcmVjZWl2ZWRQYXJhbXMgPSBfLmtleXMoanNvbk9iaik7XG5cbiAgaWYgKHBhcmFtU2V0cykge1xuICAgIGlmIChwYXJhbVNldHMucmVxdWlyZWQpIHtcbiAgICAgIC8vIHdlIG1pZ2h0IGhhdmUgYW4gYXJyYXkgb2YgcGFyYW1ldGVycyxcbiAgICAgIC8vIG9yIGFuIGFycmF5IG9mIGFycmF5cyBvZiBwYXJhbWV0ZXJzLCBzbyBzdGFuZGFyZGl6ZVxuICAgICAgaWYgKCFfLmlzQXJyYXkoXy5maXJzdChwYXJhbVNldHMucmVxdWlyZWQpKSkge1xuICAgICAgICByZXF1aXJlZFBhcmFtcyA9IFtwYXJhbVNldHMucmVxdWlyZWRdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVxdWlyZWRQYXJhbXMgPSBwYXJhbVNldHMucmVxdWlyZWQ7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIG9wdGlvbmFsIHBhcmFtZXRlcnMgYXJlIGp1c3QgYW4gYXJyYXlcbiAgICBpZiAocGFyYW1TZXRzLm9wdGlvbmFsKSB7XG4gICAgICBvcHRpb25hbFBhcmFtcyA9IHBhcmFtU2V0cy5vcHRpb25hbDtcbiAgICB9XG5cbiAgICAvLyBJZiBhIGZ1bmN0aW9uIHdhcyBwcm92aWRlZCBhcyB0aGUgJ3ZhbGlkYXRlJyBrZXksIGl0IHdpbGwgaGVyZSBiZSBjYWxsZWQgd2l0aFxuICAgIC8vIGpzb25PYmogYXMgdGhlIHBhcmFtLiBJZiBpdCByZXR1cm5zIHNvbWV0aGluZyBmYWxzeSwgdmVyaWZpY2F0aW9uIHdpbGwgYmVcbiAgICAvLyBjb25zaWRlcmVkIHRvIGhhdmUgcGFzc2VkLiBJZiBpdCByZXR1cm5zIHNvbWV0aGluZyBlbHNlLCB0aGF0IHdpbGwgYmUgdGhlXG4gICAgLy8gYXJndW1lbnQgdG8gYW4gZXJyb3Igd2hpY2ggaXMgdGhyb3duIHRvIHRoZSB1c2VyXG4gICAgaWYgKHBhcmFtU2V0cy52YWxpZGF0ZSkge1xuICAgICAgbGV0IG1lc3NhZ2UgPSBwYXJhbVNldHMudmFsaWRhdGUoanNvbk9iaiwgcHJvdG9jb2wpO1xuICAgICAgaWYgKG1lc3NhZ2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5CYWRQYXJhbWV0ZXJzRXJyb3IobWVzc2FnZSwganNvbk9iaik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gaWYgd2UgaGF2ZSBubyByZXF1aXJlZCBwYXJhbWV0ZXJzLCBhbGwgaXMgd2VsbFxuICBpZiAocmVxdWlyZWRQYXJhbXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gc29tZSBjbGllbnRzIHBhc3MgaW4gdGhlIHNlc3Npb24gaWQgaW4gdGhlIHBhcmFtc1xuICBpZiAob3B0aW9uYWxQYXJhbXMuaW5kZXhPZignc2Vzc2lvbklkJykgPT09IC0xKSB7XG4gICAgb3B0aW9uYWxQYXJhbXMucHVzaCgnc2Vzc2lvbklkJyk7XG4gIH1cblxuICAvLyBzb21lIGNsaWVudHMgcGFzcyBpbiBhbiBlbGVtZW50IGlkIGluIHRoZSBwYXJhbXNcbiAgaWYgKG9wdGlvbmFsUGFyYW1zLmluZGV4T2YoJ2lkJykgPT09IC0xKSB7XG4gICAgb3B0aW9uYWxQYXJhbXMucHVzaCgnaWQnKTtcbiAgfVxuXG4gIC8vIGdvIHRocm91Z2ggdGhlIHJlcXVpcmVkIHBhcmFtZXRlcnMgYW5kIGNoZWNrIGFnYWluc3Qgb3VyIGFyZ3VtZW50c1xuICBmb3IgKGxldCBwYXJhbXMgb2YgcmVxdWlyZWRQYXJhbXMpIHtcbiAgICBpZiAoXy5kaWZmZXJlbmNlKHJlY2VpdmVkUGFyYW1zLCBwYXJhbXMsIG9wdGlvbmFsUGFyYW1zKS5sZW5ndGggPT09IDAgJiZcbiAgICAgICAgXy5kaWZmZXJlbmNlKHBhcmFtcywgcmVjZWl2ZWRQYXJhbXMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgLy8gd2UgaGF2ZSBhIHNldCBvZiBwYXJhbWV0ZXJzIHRoYXQgaXMgY29ycmVjdFxuICAgICAgLy8gc28gc2hvcnQtY2lyY3VpdFxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgZXJyb3JzLkJhZFBhcmFtZXRlcnNFcnJvcihwYXJhbVNldHMsIHJlY2VpdmVkUGFyYW1zKTtcbn1cblxuLypcbiAqIFRoaXMgbWV0aG9kIHRha2VzIDMgcGllY2VzIG9mIGRhdGE6IHJlcXVlc3QgcGFyYW1ldGVycyAoJ3JlcXVlc3RQYXJhbXMnKSxcbiAqIGEgcmVxdWVzdCBKU09OIGJvZHkgKCdqc29uT2JqJyksIGFuZCAncGF5bG9hZFBhcmFtcycsIHdoaWNoIGlzIHRoZSBzZWN0aW9uXG4gKiBmcm9tIHRoZSByb3V0ZSBkZWZpbml0aW9uIGZvciBhIHBhcnRpY3VsYXIgZW5kcG9pbnQgd2hpY2ggaGFzIGluc3RydWN0aW9uc1xuICogb24gaGFuZGxpbmcgcGFyYW1ldGVycy4gVGhpcyBtZXRob2QgcmV0dXJucyBhbiBhcnJheSBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbFxuICogYmUgYXBwbGllZCB0byBhIGNvbW1hbmQuXG4gKi9cbmZ1bmN0aW9uIG1ha2VBcmdzIChyZXF1ZXN0UGFyYW1zLCBqc29uT2JqLCBwYXlsb2FkUGFyYW1zLCBwcm90b2NvbCkge1xuICAvLyBXZSB3YW50IHRvIHBhc3MgdGhlIFwidXJsXCIgcGFyYW1ldGVycyB0byB0aGUgY29tbWFuZHMgaW4gcmV2ZXJzZSBvcmRlclxuICAvLyBzaW5jZSB0aGUgY29tbWFuZCB3aWxsIHNvbWV0aW1lcyB3YW50IHRvIGlnbm9yZSwgc2F5LCB0aGUgc2Vzc2lvbklkLlxuICAvLyBUaGlzIGhhcyB0aGUgZWZmZWN0IG9mIHB1dHRpbmcgc2Vzc2lvbklkIGxhc3QsIHdoaWNoIG1lYW5zIGluIEpTIHdlIGNhblxuICAvLyBvbWl0IGl0IGZyb20gdGhlIGZ1bmN0aW9uIHNpZ25hdHVyZSBpZiB3ZSdyZSBub3QgZ29pbmcgdG8gdXNlIGl0LlxuICBsZXQgdXJsUGFyYW1zID0gXy5rZXlzKHJlcXVlc3RQYXJhbXMpLnJldmVyc2UoKTtcblxuICAvLyBJbiB0aGUgc2ltcGxlIGNhc2UsIHRoZSByZXF1aXJlZCBwYXJhbWV0ZXJzIGFyZSBhIGJhc2ljIGFycmF5IGluXG4gIC8vIHBheWxvYWRQYXJhbXMucmVxdWlyZWQsIHNvIHN0YXJ0IHRoZXJlLiBJdCdzIHBvc3NpYmxlIHRoYXQgdGhlcmUgYXJlXG4gIC8vIG11bHRpcGxlIG9wdGlvbmFsIHNldHMgb2YgcmVxdWlyZWQgcGFyYW1zLCB0aG91Z2gsIHNvIGhhbmRsZSB0aGF0IGNhc2VcbiAgLy8gdG9vLlxuICBsZXQgcmVxdWlyZWRQYXJhbXMgPSBwYXlsb2FkUGFyYW1zLnJlcXVpcmVkO1xuICBpZiAoXy5pc0FycmF5KF8uZmlyc3QocGF5bG9hZFBhcmFtcy5yZXF1aXJlZCkpKSB7XG4gICAgLy8gSWYgdGhlcmUgYXJlIG9wdGlvbmFsIHNldHMgb2YgcmVxdWlyZWQgcGFyYW1zLCB0aGVuIHdlIHdpbGwgaGF2ZSBhblxuICAgIC8vIGFycmF5IG9mIGFycmF5cyBpbiBwYXlsb2FkUGFyYW1zLnJlcXVpcmVkLCBzbyBsb29wIHRocm91Z2ggZWFjaCBzZXQgYW5kXG4gICAgLy8gcGljayB0aGUgb25lIHRoYXQgbWF0Y2hlcyB3aGljaCBKU09OIHBhcmFtcyB3ZXJlIGFjdHVhbGx5IHNlbnQuIFdlJ3ZlXG4gICAgLy8gYWxyZWFkeSBiZWVuIHRocm91Z2ggdmFsaWRhdGlvbiBzbyB3ZSdyZSBndWFyYW50ZWVkIHRvIGZpbmQgYSBtYXRjaC5cbiAgICBsZXQga2V5cyA9IF8ua2V5cyhqc29uT2JqKTtcbiAgICBmb3IgKGxldCBwYXJhbXMgb2YgcGF5bG9hZFBhcmFtcy5yZXF1aXJlZCkge1xuICAgICAgaWYgKF8ud2l0aG91dChwYXJhbXMsIC4uLmtleXMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXF1aXJlZFBhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gTm93IHdlIGNvbnN0cnVjdCBvdXIgbGlzdCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGNvbW1hbmRcbiAgbGV0IGFyZ3M7XG4gIGlmIChfLmlzRnVuY3Rpb24ocGF5bG9hZFBhcmFtcy5tYWtlQXJncykpIHtcbiAgICAvLyBJbiB0aGUgcm91dGUgc3BlYywgYSBwYXJ0aWN1bGFyIHJvdXRlIG1pZ2h0IGRlZmluZSBhICdtYWtlQXJncycgZnVuY3Rpb25cbiAgICAvLyBpZiBpdCB3YW50cyBmdWxsIGNvbnRyb2wgb3ZlciBob3cgdG8gdHVybiBKU09OIHBhcmFtZXRlcnMgaW50byBjb21tYW5kXG4gICAgLy8gYXJndW1lbnRzLiBTbyB3ZSBwYXNzIGl0IHRoZSBKU09OIHBhcmFtZXRlcnMgYW5kIGl0IHJldHVybnMgYW4gYXJyYXlcbiAgICAvLyB3aGljaCB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIGhhbmRsaW5nIGNvbW1hbmQuIEZvciBleGFtcGxlIGlmIGl0IHJldHVybnNcbiAgICAvLyBbMSwgMiwgM10sIHdlIHdpbGwgY2FsbCBgY29tbWFuZCgxLCAyLCAzLCAuLi4pYCAodXJsIHBhcmFtcyBhcmUgc2VwYXJhdGVcbiAgICAvLyBmcm9tIEpTT04gcGFyYW1zIGFuZCBnZXQgY29uY2F0ZW5hdGVkIGJlbG93KS5cbiAgICBhcmdzID0gcGF5bG9hZFBhcmFtcy5tYWtlQXJncyhqc29uT2JqLCBwcm90b2NvbCk7XG4gIH0gZWxzZSB7XG4gICAgLy8gT3RoZXJ3aXNlLCBjb2xsZWN0IGFsbCB0aGUgcmVxdWlyZWQgYW5kIG9wdGlvbmFsIHBhcmFtcyBhbmQgZmxhdHRlbiB0aGVtXG4gICAgLy8gaW50byBhbiBhcmd1bWVudCBhcnJheVxuICAgIGFyZ3MgPSBfLmZsYXR0ZW4ocmVxdWlyZWRQYXJhbXMpLm1hcCgocCkgPT4ganNvbk9ialtwXSk7XG4gICAgaWYgKHBheWxvYWRQYXJhbXMub3B0aW9uYWwpIHtcbiAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChfLmZsYXR0ZW4ocGF5bG9hZFBhcmFtcy5vcHRpb25hbCkubWFwKChwKSA9PiBqc29uT2JqW3BdKSk7XG4gICAgfVxuICB9XG4gIC8vIEZpbmFsbHksIGdldCBvdXIgdXJsIHBhcmFtcyAoc2Vzc2lvbiBpZCwgZWxlbWVudCBpZCwgZXRjLi4uKSBvbiB0aGUgZW5kIG9mXG4gIC8vIHRoZSBsaXN0XG4gIGFyZ3MgPSBhcmdzLmNvbmNhdCh1cmxQYXJhbXMubWFwKCh1KSA9PiByZXF1ZXN0UGFyYW1zW3VdKSk7XG4gIHJldHVybiBhcmdzO1xufVxuXG5mdW5jdGlvbiByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24gKGRyaXZlcikge1xuICBpZiAoIWRyaXZlci5zZXNzaW9uRXhpc3RzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdEcml2ZXJzIHVzZWQgd2l0aCBNSlNPTldQIG11c3QgaW1wbGVtZW50IGBzZXNzaW9uRXhpc3RzYCcpO1xuICB9XG5cbiAgaWYgKCEoZHJpdmVyLmV4ZWN1dGVDb21tYW5kIHx8IGRyaXZlci5leGVjdXRlKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignRHJpdmVycyB1c2VkIHdpdGggTUpTT05XUCBtdXN0IGltcGxlbWVudCBgZXhlY3V0ZUNvbW1hbmRgIG9yIGBleGVjdXRlYCcpO1xuICB9XG5cbiAgLy8gcmV0dXJuIGEgZnVuY3Rpb24gd2hpY2ggd2lsbCBhZGQgYWxsIHRoZSByb3V0ZXMgdG8gdGhlIGRyaXZlclxuICByZXR1cm4gZnVuY3Rpb24gKGFwcCkge1xuICAgIGZvciAobGV0IFtwYXRoLCBtZXRob2RzXSBvZiBfLnRvUGFpcnMoTUVUSE9EX01BUCkpIHtcbiAgICAgIGZvciAobGV0IFttZXRob2QsIHNwZWNdIG9mIF8udG9QYWlycyhtZXRob2RzKSkge1xuICAgICAgICAvLyBzZXQgdXAgdGhlIGV4cHJlc3Mgcm91dGUgaGFuZGxlclxuICAgICAgICBidWlsZEhhbmRsZXIoYXBwLCBtZXRob2QsIHBhdGgsIHNwZWMsIGRyaXZlciwgaXNTZXNzaW9uQ29tbWFuZChzcGVjLmNvbW1hbmQpKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG59XG5cbmZ1bmN0aW9uIGJ1aWxkSGFuZGxlciAoYXBwLCBtZXRob2QsIHBhdGgsIHNwZWMsIGRyaXZlciwgaXNTZXNzQ21kKSB7XG4gIGxldCBhc3luY0hhbmRsZXIgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBsZXQganNvbk9iaiA9IHJlcS5ib2R5O1xuICAgIGxldCBodHRwUmVzQm9keSA9IHt9O1xuICAgIGxldCBodHRwU3RhdHVzID0gMjAwO1xuICAgIGxldCBuZXdTZXNzaW9uSWQ7XG4gICAgbGV0IGN1cnJlbnRQcm90b2NvbCA9IGV4dHJhY3RQcm90b2NvbChkcml2ZXIsIHJlcS5wYXJhbXMuc2Vzc2lvbklkKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBpZiB0aGlzIGlzIGEgc2Vzc2lvbiBjb21tYW5kIGJ1dCB3ZSBkb24ndCBoYXZlIGEgc2Vzc2lvbixcbiAgICAgIC8vIGVycm9yIG91dCBlYXJseSAoZXNwZWNpYWxseSBiZWZvcmUgcHJveHlpbmcpXG4gICAgICBpZiAoaXNTZXNzQ21kICYmICFkcml2ZXIuc2Vzc2lvbkV4aXN0cyhyZXEucGFyYW1zLnNlc3Npb25JZCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hEcml2ZXJFcnJvcigpO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiB0aGUgZHJpdmVyIGlzIGN1cnJlbnRseSBwcm94eWluZyBjb21tYW5kcyB0byBhbm90aGVyIEpTT05XUFxuICAgICAgLy8gc2VydmVyLCBieXBhc3MgYWxsIG91ciBjaGVja3MgYW5kIGFzc3VtZSB0aGUgdXBzdHJlYW0gc2VydmVyIGtub3dzXG4gICAgICAvLyB3aGF0IGl0J3MgZG9pbmcuIEJ1dCBrZWVwIHRoaXMgaW4gdGhlIHRyeS9jYXRjaCBibG9jayBzbyBpZiBwcm94eWluZ1xuICAgICAgLy8gaXRzZWxmIGZhaWxzLCB3ZSBnaXZlIGEgbWVzc2FnZSB0byB0aGUgY2xpZW50LiBPZiBjb3Vyc2Ugd2Ugb25seVxuICAgICAgLy8gd2FudCB0byBkbyB0aGVzZSB3aGVuIHdlIGhhdmUgYSBzZXNzaW9uIGNvbW1hbmQ7IHRoZSBBcHBpdW0gZHJpdmVyXG4gICAgICAvLyBtdXN0IGJlIHJlc3BvbnNpYmxlIGZvciBzdGFydC9zdG9wIHNlc3Npb24sIGV0Yy4uLlxuICAgICAgaWYgKGlzU2Vzc0NtZCAmJiBkcml2ZXJTaG91bGREb0p3cFByb3h5KGRyaXZlciwgcmVxLCBzcGVjLmNvbW1hbmQpKSB7XG4gICAgICAgIGF3YWl0IGRvSndwUHJveHkoZHJpdmVyLCByZXEsIHJlcyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gaWYgYSBjb21tYW5kIGlzIG5vdCBpbiBvdXIgbWV0aG9kIG1hcCwgaXQncyBiZWNhdXNlIHdlXG4gICAgICAvLyBoYXZlIG5vIHBsYW5zIHRvIGV2ZXIgaW1wbGVtZW50IGl0XG4gICAgICBpZiAoIXNwZWMuY29tbWFuZCkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoKTtcbiAgICAgIH1cblxuICAgICAgLy8gd3JhcCBwYXJhbXMgaWYgbmVjZXNzYXJ5XG4gICAgICBpZiAoc3BlYy5wYXlsb2FkUGFyYW1zICYmIHNwZWMucGF5bG9hZFBhcmFtcy53cmFwKSB7XG4gICAgICAgIGpzb25PYmogPSB3cmFwUGFyYW1zKHNwZWMucGF5bG9hZFBhcmFtcywganNvbk9iaik7XG4gICAgICB9XG5cbiAgICAgIC8vIHVud3JhcCBwYXJhbXMgaWYgbmVjZXNzYXJ5XG4gICAgICBpZiAoc3BlYy5wYXlsb2FkUGFyYW1zICYmIHNwZWMucGF5bG9hZFBhcmFtcy51bndyYXApIHtcbiAgICAgICAganNvbk9iaiA9IHVud3JhcFBhcmFtcyhzcGVjLnBheWxvYWRQYXJhbXMsIGpzb25PYmopO1xuICAgICAgfVxuXG4gICAgICBpZiAoc3BlYy5jb21tYW5kID09PSBDUkVBVEVfU0VTU0lPTl9DT01NQU5EKSB7XG4gICAgICAgIC8vIHRyeSB0byBkZXRlcm1pbmUgcHJvdG9jb2wgYnkgc2Vzc2lvbiBjcmVhdGlvbiBhcmdzLCBzbyB3ZSBjYW4gdGhyb3cgYVxuICAgICAgICAvLyBwcm9wZXJseSBmb3JtYXR0ZWQgZXJyb3IgaWYgYXJndW1lbnRzIHZhbGlkYXRpb24gZmFpbHNcbiAgICAgICAgY3VycmVudFByb3RvY29sID0gQmFzZURyaXZlci5kZXRlcm1pbmVQcm90b2NvbCguLi5tYWtlQXJncyhyZXEucGFyYW1zLCBqc29uT2JqLCBzcGVjLnBheWxvYWRQYXJhbXMgfHwge30pKTtcbiAgICAgIH1cblxuICAgICAgLy8gZW5zdXJlIHRoYXQgdGhlIGpzb24gcGF5bG9hZCBjb25mb3JtcyB0byB0aGUgc3BlY1xuICAgICAgY2hlY2tQYXJhbXMoc3BlYy5wYXlsb2FkUGFyYW1zLCBqc29uT2JqLCBjdXJyZW50UHJvdG9jb2wpO1xuXG4gICAgICAvLyB0dXJuIHRoZSBjb21tYW5kIGFuZCBqc29uIHBheWxvYWQgaW50byBhbiBhcmd1bWVudCBsaXN0IGZvclxuICAgICAgLy8gdGhlIGRyaXZlciBtZXRob2RzXG4gICAgICBsZXQgYXJncyA9IG1ha2VBcmdzKHJlcS5wYXJhbXMsIGpzb25PYmosIHNwZWMucGF5bG9hZFBhcmFtcyB8fCB7fSwgY3VycmVudFByb3RvY29sKTtcbiAgICAgIGxldCBkcml2ZXJSZXM7XG4gICAgICAvLyB2YWxpZGF0ZSBjb21tYW5kIGFyZ3MgYWNjb3JkaW5nIHRvIE1KU09OV1BcbiAgICAgIGlmICh2YWxpZGF0b3JzW3NwZWMuY29tbWFuZF0pIHtcbiAgICAgICAgdmFsaWRhdG9yc1tzcGVjLmNvbW1hbmRdKC4uLmFyZ3MpO1xuICAgICAgfVxuXG4gICAgICAvLyBydW4gdGhlIGRyaXZlciBjb21tYW5kIHdyYXBwZWQgaW5zaWRlIHRoZSBhcmd1bWVudCB2YWxpZGF0b3JzXG4gICAgICBTRVNTSU9OU19DQUNIRS5nZXRMb2dnZXIocmVxLnBhcmFtcy5zZXNzaW9uSWQsIGN1cnJlbnRQcm90b2NvbCkuZGVidWcoYENhbGxpbmcgYCArXG4gICAgICAgIGAke2RyaXZlci5jb25zdHJ1Y3Rvci5uYW1lfS4ke3NwZWMuY29tbWFuZH0oKSB3aXRoIGFyZ3M6IGAgK1xuICAgICAgICBfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KGFyZ3MpLCB7bGVuZ3RoOiBMT0dfT0JKX0xFTkdUSH0pKTtcblxuICAgICAgaWYgKGRyaXZlci5leGVjdXRlQ29tbWFuZCkge1xuICAgICAgICBkcml2ZXJSZXMgPSBhd2FpdCBkcml2ZXIuZXhlY3V0ZUNvbW1hbmQoc3BlYy5jb21tYW5kLCAuLi5hcmdzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRyaXZlclJlcyA9IGF3YWl0IGRyaXZlci5leGVjdXRlKHNwZWMuY29tbWFuZCwgLi4uYXJncyk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCB0aGUgcHJvdG9jb2wgYWZ0ZXIgZXhlY3V0ZUNvbW1hbmRcbiAgICAgIGN1cnJlbnRQcm90b2NvbCA9IGV4dHJhY3RQcm90b2NvbChkcml2ZXIsIHJlcS5wYXJhbXMuc2Vzc2lvbklkKSB8fCBjdXJyZW50UHJvdG9jb2w7XG5cbiAgICAgIC8vIElmIGBleGVjdXRlQ29tbWFuZGAgd2FzIG92ZXJyaWRkZW4gYW5kIHRoZSBtZXRob2QgcmV0dXJucyBhbiBvYmplY3RcbiAgICAgIC8vIHdpdGggYSBwcm90b2NvbCBhbmQgdmFsdWUvZXJyb3IgcHJvcGVydHksIHJlLWFzc2lnbiB0aGUgcHJvdG9jb2xcbiAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QoZHJpdmVyUmVzKSAmJiBfLmhhcyhkcml2ZXJSZXMsICdwcm90b2NvbCcpKSB7XG4gICAgICAgIGN1cnJlbnRQcm90b2NvbCA9IGRyaXZlclJlcy5wcm90b2NvbCB8fCBjdXJyZW50UHJvdG9jb2w7XG4gICAgICAgIGlmIChkcml2ZXJSZXMuZXJyb3IpIHtcbiAgICAgICAgICB0aHJvdyBkcml2ZXJSZXMuZXJyb3I7XG4gICAgICAgIH1cbiAgICAgICAgZHJpdmVyUmVzID0gZHJpdmVyUmVzLnZhbHVlO1xuICAgICAgfVxuXG4gICAgICAvLyB1bnBhY2sgY3JlYXRlU2Vzc2lvbiByZXNwb25zZVxuICAgICAgaWYgKHNwZWMuY29tbWFuZCA9PT0gQ1JFQVRFX1NFU1NJT05fQ09NTUFORCkge1xuICAgICAgICBuZXdTZXNzaW9uSWQgPSBkcml2ZXJSZXNbMF07XG4gICAgICAgIFNFU1NJT05TX0NBQ0hFLnB1dFNlc3Npb24obmV3U2Vzc2lvbklkLCBjdXJyZW50UHJvdG9jb2wpO1xuICAgICAgICBTRVNTSU9OU19DQUNIRS5nZXRMb2dnZXIobmV3U2Vzc2lvbklkLCBjdXJyZW50UHJvdG9jb2wpXG4gICAgICAgICAgLmRlYnVnKGBDYWNoZWQgdGhlIHByb3RvY29sIHZhbHVlICcke2N1cnJlbnRQcm90b2NvbH0nIGZvciB0aGUgbmV3IHNlc3Npb24gJHtuZXdTZXNzaW9uSWR9YCk7XG4gICAgICAgIGlmIChjdXJyZW50UHJvdG9jb2wgPT09IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MLk1KU09OV1ApIHtcbiAgICAgICAgICBkcml2ZXJSZXMgPSBkcml2ZXJSZXNbMV07XG4gICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFByb3RvY29sID09PSBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTC5XM0MpIHtcbiAgICAgICAgICBkcml2ZXJSZXMgPSB7XG4gICAgICAgICAgICBjYXBhYmlsaXRpZXM6IGRyaXZlclJlc1sxXSxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIElmIHRoZSBNSlNPTldQIGVsZW1lbnQga2V5IGZvcm1hdCAoRUxFTUVOVCkgd2FzIHByb3ZpZGVkLCBhZGQgYSBkdXBsaWNhdGUga2V5IChlbGVtZW50LTYwNjYtMTFlNC1hNTJlLTRmNzM1NDY2Y2VjZilcbiAgICAgIC8vIElmIHRoZSBXM0MgZWxlbWVudCBrZXkgZm9ybWF0IChlbGVtZW50LTYwNjYtMTFlNC1hNTJlLTRmNzM1NDY2Y2VjZikgd2FzIHByb3ZpZGVkLCBhZGQgYSBkdXBsaWNhdGUga2V5IChFTEVNRU5UKVxuICAgICAgaWYgKGRyaXZlclJlcykge1xuICAgICAgICBkcml2ZXJSZXMgPSBkdXBsaWNhdGVLZXlzKGRyaXZlclJlcywgTUpTT05XUF9FTEVNRU5UX0tFWSwgVzNDX0VMRU1FTlRfS0VZKTtcbiAgICAgIH1cblxuICAgICAgLy8gY29udmVydCB1bmRlZmluZWQgdG8gbnVsbCwgYnV0IGxlYXZlIGFsbCBvdGhlciB2YWx1ZXMgdGhlIHNhbWVcbiAgICAgIGlmIChfLmlzVW5kZWZpbmVkKGRyaXZlclJlcykpIHtcbiAgICAgICAgZHJpdmVyUmVzID0gbnVsbDtcbiAgICAgIH1cblxuICAgICAgLy8gZGVsZXRlIHNob3VsZCBub3QgcmV0dXJuIGFueXRoaW5nIGV2ZW4gaWYgc3VjY2Vzc2Z1bFxuICAgICAgaWYgKHNwZWMuY29tbWFuZCA9PT0gREVMRVRFX1NFU1NJT05fQ09NTUFORCkge1xuICAgICAgICBTRVNTSU9OU19DQUNIRS5nZXRMb2dnZXIocmVxLnBhcmFtcy5zZXNzaW9uSWQsIGN1cnJlbnRQcm90b2NvbClcbiAgICAgICAgICAuZGVidWcoYFJlY2VpdmVkIHJlc3BvbnNlOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoZHJpdmVyUmVzKSwge2xlbmd0aDogTE9HX09CSl9MRU5HVEh9KX1gKTtcbiAgICAgICAgU0VTU0lPTlNfQ0FDSEUuZ2V0TG9nZ2VyKHJlcS5wYXJhbXMuc2Vzc2lvbklkLCBjdXJyZW50UHJvdG9jb2wpLmRlYnVnKCdCdXQgZGVsZXRpbmcgc2Vzc2lvbiwgc28gbm90IHJldHVybmluZycpO1xuICAgICAgICBkcml2ZXJSZXMgPSBudWxsO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiB0aGUgc3RhdHVzIGlzIG5vdCAwLCAgdGhyb3cgdGhlIGFwcHJvcHJpYXRlIGVycm9yIGZvciBzdGF0dXMgY29kZS5cbiAgICAgIGlmICh1dGlsLmhhc1ZhbHVlKGRyaXZlclJlcykpIHtcbiAgICAgICAgaWYgKHV0aWwuaGFzVmFsdWUoZHJpdmVyUmVzLnN0YXR1cykgJiYgIWlzTmFOKGRyaXZlclJlcy5zdGF0dXMpICYmIHBhcnNlSW50KGRyaXZlclJlcy5zdGF0dXMsIDEwKSAhPT0gMCkge1xuICAgICAgICAgIHRocm93IGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlKGRyaXZlclJlcy5zdGF0dXMsIGRyaXZlclJlcy52YWx1ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoXy5pc1BsYWluT2JqZWN0KGRyaXZlclJlcy52YWx1ZSkgJiYgZHJpdmVyUmVzLnZhbHVlLmVycm9yKSB7XG4gICAgICAgICAgdGhyb3cgZXJyb3JGcm9tVzNDSnNvbkNvZGUoZHJpdmVyUmVzLnZhbHVlLmVycm9yLCBkcml2ZXJSZXMudmFsdWUubWVzc2FnZSwgZHJpdmVyUmVzLnZhbHVlLnN0YWNrdHJhY2UpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFJlc3BvbnNlIHN0YXR1cyBzaG91bGQgYmUgdGhlIHN0YXR1cyBzZXQgYnkgdGhlIGRyaXZlciByZXNwb25zZS5cbiAgICAgIGlmIChjdXJyZW50UHJvdG9jb2wgIT09IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MLlczQykge1xuICAgICAgICBodHRwUmVzQm9keS5zdGF0dXMgPSAoXy5pc05pbChkcml2ZXJSZXMpIHx8IF8uaXNVbmRlZmluZWQoZHJpdmVyUmVzLnN0YXR1cykpID8gSlNPTldQX1NVQ0NFU1NfU1RBVFVTX0NPREUgOiBkcml2ZXJSZXMuc3RhdHVzO1xuICAgICAgfVxuICAgICAgaHR0cFJlc0JvZHkudmFsdWUgPSBkcml2ZXJSZXM7XG4gICAgICBTRVNTSU9OU19DQUNIRS5nZXRMb2dnZXIocmVxLnBhcmFtcy5zZXNzaW9uSWQgfHwgbmV3U2Vzc2lvbklkLCBjdXJyZW50UHJvdG9jb2wpLmRlYnVnKGBSZXNwb25kaW5nIGAgK1xuICAgICAgICBgdG8gY2xpZW50IHdpdGggZHJpdmVyLiR7c3BlYy5jb21tYW5kfSgpIHJlc3VsdDogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KGRyaXZlclJlcyksIHtsZW5ndGg6IExPR19PQkpfTEVOR1RIfSl9YCk7XG5cbiAgICAgIGlmIChzcGVjLmNvbW1hbmQgPT09IERFTEVURV9TRVNTSU9OX0NPTU1BTkQpIHtcbiAgICAgICAgLy8gV2UgZG9uJ3Qgd2FudCB0byBrZWVwIHRoZSBsb2dnZXIgaW5zdGFuY2UgaW4gdGhlIGNhY2hlXG4gICAgICAgIC8vIGFmdGVyIHRoZSBzZXNzaW9uIGlzIGRlbGV0ZWQsIGJlY2F1c2UgaXQgY29udGFpbnMgdGhlIGxvZ2dpbmcgaGlzdG9yeVxuICAgICAgICAvLyBhbmQgY29uc3VtZXMgdGhlIG1lbW9yeVxuICAgICAgICBTRVNTSU9OU19DQUNIRS5yZXNldExvZ2dlcihyZXEucGFyYW1zLnNlc3Npb25JZCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBpZiBhbnl0aGluZyBnb2VzIHdyb25nLCBmaWd1cmUgb3V0IHdoYXQgb3VyIHJlc3BvbnNlIHNob3VsZCBiZVxuICAgICAgLy8gYmFzZWQgb24gdGhlIHR5cGUgb2YgZXJyb3IgdGhhdCB3ZSBlbmNvdW50ZXJlZFxuICAgICAgbGV0IGFjdHVhbEVyciA9IGVycjtcblxuICAgICAgY3VycmVudFByb3RvY29sID0gY3VycmVudFByb3RvY29sIHx8IGV4dHJhY3RQcm90b2NvbChkcml2ZXIsIHJlcS5wYXJhbXMuc2Vzc2lvbklkIHx8IG5ld1Nlc3Npb25JZCk7XG5cbiAgICAgIGxldCBlcnJNc2cgPSBlcnIuc3RhY2t0cmFjZSB8fCBlcnIuc3RhY2s7XG4gICAgICBpZiAoIV8uaW5jbHVkZXMoZXJyTXNnLCBlcnIubWVzc2FnZSkpIHtcbiAgICAgICAgLy8gaWYgdGhlIG1lc3NhZ2UgaGFzIG1vcmUgaW5mb3JtYXRpb24sIGFkZCBpdC4gYnV0IG9mdGVuIHRoZSBtZXNzYWdlXG4gICAgICAgIC8vIGlzIHRoZSBmaXJzdCBwYXJ0IG9mIHRoZSBzdGFjayB0cmFjZVxuICAgICAgICBlcnJNc2cgPSBgJHtlcnIubWVzc2FnZX0ke2Vyck1zZyA/ICgnXFxuJyArIGVyck1zZykgOiAnJ31gO1xuICAgICAgfVxuICAgICAgU0VTU0lPTlNfQ0FDSEUuZ2V0TG9nZ2VyKHJlcS5wYXJhbXMuc2Vzc2lvbklkIHx8IG5ld1Nlc3Npb25JZCwgY3VycmVudFByb3RvY29sKS5kZWJ1ZyhgRW5jb3VudGVyZWQgYCArXG4gICAgICAgIGBpbnRlcm5hbCBlcnJvciBydW5uaW5nIGNvbW1hbmQ6ICR7ZXJyTXNnfWApO1xuICAgICAgaWYgKGlzRXJyb3JUeXBlKGVyciwgZXJyb3JzLlByb3h5UmVxdWVzdEVycm9yKSkge1xuICAgICAgICBhY3R1YWxFcnIgPSBlcnIuZ2V0QWN0dWFsRXJyb3IoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGN1cnJlbnRQcm90b2NvbCA9PT0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuVzNDKSB7XG4gICAgICAgIFtodHRwU3RhdHVzLCBodHRwUmVzQm9keV0gPSBnZXRSZXNwb25zZUZvclczQ0Vycm9yKGFjdHVhbEVycik7XG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRQcm90b2NvbCA9PT0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuTUpTT05XUCkge1xuICAgICAgICBbaHR0cFN0YXR1cywgaHR0cFJlc0JvZHldID0gZ2V0UmVzcG9uc2VGb3JKc29ud3BFcnJvcihhY3R1YWxFcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gSWYgaXQncyB1bmtub3duIHdoYXQgdGhlIHByb3RvY29sIGlzIChsaWtlIGlmIGl0J3MgYGdldFN0YXR1c2AgcHJpb3IgdG8gYGNyZWF0ZVNlc3Npb25gKSwgbWVyZ2UgdGhlIHJlc3BvbnNlc1xuICAgICAgICAvLyB0b2dldGhlciB0byBiZSBwcm90b2NvbC1hZ25vc3RpY1xuICAgICAgICBsZXQganNvbndwUmVzID0gZ2V0UmVzcG9uc2VGb3JKc29ud3BFcnJvcihhY3R1YWxFcnIpO1xuICAgICAgICBsZXQgdzNjUmVzID0gZ2V0UmVzcG9uc2VGb3JXM0NFcnJvcihhY3R1YWxFcnIpO1xuXG4gICAgICAgIGh0dHBSZXNCb2R5ID0ge1xuICAgICAgICAgIC4uLmpzb253cFJlc1sxXSxcbiAgICAgICAgICAuLi53M2NSZXNbMV0sXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gVXNlIHRoZSBKU09OV1Agc3RhdHVzIGNvZGUgKHdoaWNoIGlzIHVzdWFsbHkgNTAwKVxuICAgICAgICBodHRwU3RhdHVzID0ganNvbndwUmVzWzBdO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGRlY29kZSB0aGUgcmVzcG9uc2UsIHdoaWNoIGlzIGVpdGhlciBhIHN0cmluZyBvciBqc29uXG4gICAgaWYgKF8uaXNTdHJpbmcoaHR0cFJlc0JvZHkpKSB7XG4gICAgICByZXMuc3RhdHVzKGh0dHBTdGF0dXMpLnNlbmQoaHR0cFJlc0JvZHkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAobmV3U2Vzc2lvbklkKSB7XG4gICAgICAgIGlmIChjdXJyZW50UHJvdG9jb2wgPT09IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MLlczQykge1xuICAgICAgICAgIGh0dHBSZXNCb2R5LnZhbHVlLnNlc3Npb25JZCA9IG5ld1Nlc3Npb25JZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBodHRwUmVzQm9keS5zZXNzaW9uSWQgPSBuZXdTZXNzaW9uSWQ7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGh0dHBSZXNCb2R5LnNlc3Npb25JZCA9IHJlcS5wYXJhbXMuc2Vzc2lvbklkIHx8IG51bGw7XG4gICAgICB9XG5cbiAgICAgIC8vIERvbid0IGluY2x1ZGUgc2Vzc2lvbklkIGluIFczQyByZXNwb25zZXNcbiAgICAgIGlmIChjdXJyZW50UHJvdG9jb2wgPT09IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MLlczQykge1xuICAgICAgICBkZWxldGUgaHR0cFJlc0JvZHkuc2Vzc2lvbklkO1xuICAgICAgfVxuICAgICAgcmVzLnN0YXR1cyhodHRwU3RhdHVzKS5qc29uKGh0dHBSZXNCb2R5KTtcbiAgICB9XG4gIH07XG4gIC8vIGFkZCB0aGUgbWV0aG9kIHRvIHRoZSBhcHBcbiAgYXBwW21ldGhvZC50b0xvd2VyQ2FzZSgpXShwYXRoLCAocmVxLCByZXMpID0+IHtcbiAgICBCLnJlc29sdmUoYXN5bmNIYW5kbGVyKHJlcSwgcmVzKSkuZG9uZSgpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZHJpdmVyU2hvdWxkRG9Kd3BQcm94eSAoZHJpdmVyLCByZXEsIGNvbW1hbmQpIHtcbiAgLy8gZHJpdmVycyBuZWVkIHRvIGV4cGxpY2l0bHkgc2F5IHdoZW4gdGhlIHByb3h5IGlzIGFjdGl2ZVxuICBpZiAoIWRyaXZlci5wcm94eUFjdGl2ZShyZXEucGFyYW1zLnNlc3Npb25JZCkpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyB3ZSBzaG91bGQgbmV2ZXIgcHJveHkgZGVsZXRlU2Vzc2lvbiBiZWNhdXNlIHdlIG5lZWQgdG8gZ2l2ZSB0aGUgY29udGFpbmluZ1xuICAvLyBkcml2ZXIgYW4gb3Bwb3J0dW5pdHkgdG8gY2xlYW4gaXRzZWxmIHVwXG4gIGlmIChjb21tYW5kID09PSAnZGVsZXRlU2Vzc2lvbicpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyB2YWxpZGF0ZSBhdm9pZGFuY2Ugc2NoZW1hLCBhbmQgc2F5IHdlIHNob3VsZG4ndCBwcm94eSBpZiBhbnl0aGluZyBpbiB0aGVcbiAgLy8gYXZvaWQgbGlzdCBtYXRjaGVzIG91ciByZXFcbiAgaWYgKGRyaXZlci5wcm94eVJvdXRlSXNBdm9pZGVkKHJlcS5wYXJhbXMuc2Vzc2lvbklkLCByZXEubWV0aG9kLCByZXEub3JpZ2luYWxVcmwpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8gaWYgaXQgbG9va3MgbGlrZSB3ZSBoYXZlIGFuIGltYWdlIGVsZW1lbnQgaW4gdGhlIHVybCAoYXMgYSByb3V0ZVxuICAvLyBwYXJhbWV0ZXIpLCBuZXZlciBwcm94eS4gSnVzdCBsb29rIGZvciBvdXIgaW1hZ2UgZWxlbWVudCBwcmVmaXggaW4gYWxsb3dlZFxuICAvLyBwb3NpdGlvbnMgKGVpdGhlciBhZnRlciBhbiAnZWxlbWVudCcgb3IgJ3NjcmVlbnNob3QnIHBhdGggc2VnbWVudCksIGFuZFxuICAvLyBlbnN1cmUgdGhlIHByZWZpeCBpcyBmb2xsb3dlZCBieSBzb21ldGhpbmdcbiAgaWYgKElNR19FTF9VUkxfUkUudGVzdChyZXEub3JpZ2luYWxVcmwpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cblxuICAvLyBhbHNvIGlmIGl0IGxvb2tzIGxpa2Ugd2UgaGF2ZSBhbiBpbWFnZSBlbGVtZW50IGluIHRoZSByZXF1ZXN0IGJvZHkgKGFzXG4gIC8vIGEgSlNPTiBwYXJhbWV0ZXIpLCBuZXZlciBwcm94eS4gQmFzaWNhbGx5IGNoZWNrIGFnYWluc3QgYSByZWdleHAgb2YgdGhlXG4gIC8vIGpzb24gc3RyaW5nIG9mIHRoZSBib2R5LCB3aGVyZSB3ZSBrbm93IHdoYXQgdGhlIGZvcm0gb2YgYW4gaW1hZ2UgZWxlbWVudFxuICAvLyBtdXN0IGJlXG4gIGNvbnN0IHN0cmluZ0JvZHkgPSBKU09OLnN0cmluZ2lmeShyZXEuYm9keSk7XG4gIGlmIChzdHJpbmdCb2R5ICYmIElNR19FTF9CT0RZX1JFLnRlc3Qoc3RyaW5nQm9keSkpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gdHJ1ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZG9Kd3BQcm94eSAoZHJpdmVyLCByZXEsIHJlcykge1xuICBTRVNTSU9OU19DQUNIRS5nZXRMb2dnZXIocmVxLnBhcmFtcy5zZXNzaW9uSWQsIGV4dHJhY3RQcm90b2NvbChkcml2ZXIsIHJlcS5wYXJhbXMuc2Vzc2lvbklkKSlcbiAgICAuaW5mbygnRHJpdmVyIHByb3h5IGFjdGl2ZSwgcGFzc2luZyByZXF1ZXN0IG9uIHZpYSBIVFRQIHByb3h5Jyk7XG5cbiAgLy8gY2hlY2sgdGhhdCB0aGUgaW5uZXIgZHJpdmVyIGhhcyBhIHByb3h5IGZ1bmN0aW9uXG4gIGlmICghZHJpdmVyLmNhblByb3h5KHJlcS5wYXJhbXMuc2Vzc2lvbklkKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHByb3h5IHRvIGEgSlNPTldQIHNlcnZlciBidXQgZHJpdmVyIGlzIHVuYWJsZSB0byBwcm94eScpO1xuICB9XG4gIHRyeSB7XG4gICAgY29uc3QgcHJveGllZFJlcyA9IGF3YWl0IGRyaXZlci5leGVjdXRlQ29tbWFuZCgncHJveHlSZXFSZXMnLCByZXEsIHJlcywgcmVxLnBhcmFtcy5zZXNzaW9uSWQpO1xuICAgIGlmIChwcm94aWVkUmVzICYmIHByb3hpZWRSZXMuZXJyb3IpIHRocm93IHByb3hpZWRSZXMuZXJyb3I7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGlzRXJyb3JUeXBlKGVyciwgZXJyb3JzLlByb3h5UmVxdWVzdEVycm9yKSkge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBwcm94eS4gUHJveHkgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG59XG5cblxuZXhwb3J0IHtcbiAgUHJvdG9jb2wsIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbiwgaXNTZXNzaW9uQ29tbWFuZCxcbiAgTUpTT05XUF9FTEVNRU5UX0tFWSwgVzNDX0VMRU1FTlRfS0VZLCBJTUFHRV9FTEVNRU5UX1BSRUZJWCxcbiAgZHJpdmVyU2hvdWxkRG9Kd3BQcm94eSxcbn07XG4iXSwiZmlsZSI6ImxpYi9wcm90b2NvbC9wcm90b2NvbC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
