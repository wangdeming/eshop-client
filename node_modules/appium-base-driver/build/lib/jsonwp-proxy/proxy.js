"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.JWProxy = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _status = require("../jsonwp-status/status");

var _errors = require("../protocol/errors");

var _driver = _interopRequireDefault(require("../basedriver/driver"));

var _routes = require("../protocol/routes");

var _protocolConverter = _interopRequireDefault(require("./protocol-converter"));

const log = _appiumSupport.logger.getLogger('WD Proxy');

const LOG_OBJ_LENGTH = 1024;
const DEFAULT_REQUEST_TIMEOUT = 240000;
const {
  MJSONWP,
  W3C
} = _driver.default.DRIVER_PROTOCOL;

class JWProxy {
  constructor(opts = {}) {
    Object.assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: '/wd/hub',
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT
    }, opts);
    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
    this._downstreamProtocol = null;
    this.protocolConverter = new _protocolConverter.default(this.proxy.bind(this));
  }

  async request(...args) {
    const currentRequest = (0, _requestPromise.default)(...args);

    this._activeRequests.push(currentRequest);

    return await currentRequest.finally(() => _lodash.default.pull(this._activeRequests, currentRequest));
  }

  getActiveRequestsCount() {
    return this._activeRequests.length;
  }

  cancelActiveRequests() {
    try {
      for (let r of this._activeRequests) {
        r.cancel();
      }
    } finally {
      this._activeRequests = [];
    }
  }

  endpointRequiresSessionId(endpoint) {
    return !_lodash.default.includes(['/session', '/sessions', '/status'], endpoint);
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
    this.protocolConverter.downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getUrlForProxy(url) {
    if (url === '') {
      url = '/';
    }

    const proxyBase = `${this.scheme}://${this.server}:${this.port}${this.base}`;
    const endpointRe = '(/(session|status))';
    let remainingUrl = '';

    if (/^http/.test(url)) {
      const first = new RegExp(`(https?://.+)${endpointRe}`).exec(url);

      if (!first) {
        throw new Error('Got a complete url but could not extract JWP endpoint');
      }

      remainingUrl = url.replace(first[1], '');
    } else if (new RegExp('^/').test(url)) {
      remainingUrl = url;
    } else {
      throw new Error(`Did not know what to do with url '${url}'`);
    }

    const stripPrefixRe = new RegExp('^.*?(/(session|status).*)$');

    if (stripPrefixRe.test(remainingUrl)) {
      remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
    }

    if (!new RegExp(endpointRe).test(remainingUrl)) {
      remainingUrl = `/session/${this.sessionId}${remainingUrl}`;
    }

    const requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

    if (requiresSessionId && this.sessionId === null) {
      throw new Error('Trying to proxy a session command without session id');
    }

    const sessionBaseRe = new RegExp('^/session/([^/]+)');

    if (sessionBaseRe.test(remainingUrl)) {
      const match = sessionBaseRe.exec(remainingUrl);
      remainingUrl = remainingUrl.replace(match[1], this.sessionId);
    } else if (requiresSessionId) {
      throw new Error(`Could not find :session section for url: ${remainingUrl}`);
    }

    remainingUrl = remainingUrl.replace(/\/$/, '');
    return proxyBase + remainingUrl;
  }

  async proxy(url, method, body = null) {
    method = method.toUpperCase();
    const newUrl = this.getUrlForProxy(url);
    const reqOpts = {
      agent: false,
      url: newUrl,
      method,
      headers: {
        'content-type': 'application/json; charset=utf-8',
        'user-agent': 'appium',
        accept: 'application/json, */*'
      },
      resolveWithFullResponse: true,
      timeout: this.timeout
    };

    if (body !== null) {
      if (typeof body !== 'object') {
        body = JSON.parse(body);
      }

      reqOpts.json = body;
    }

    if (method === 'GET') {
      reqOpts.json = null;
    }

    log.debug(`Proxying [${method} ${url || '/'}] to [${method} ${newUrl}] ` + (body ? `with body: ${_lodash.default.truncate(JSON.stringify(body), {
      length: LOG_OBJ_LENGTH
    })}` : 'with no body'));
    let res, resBody;

    try {
      res = await this.request(reqOpts);
      resBody = res.body;
      log.debug(`Got response with status ${res.statusCode}: ${_lodash.default.truncate(JSON.stringify(resBody), {
        length: LOG_OBJ_LENGTH
      })}`);

      if (/\/session$/.test(url) && method === 'POST') {
        if (res.statusCode === 200) {
          this.sessionId = resBody.sessionId;
        } else if (res.statusCode === 303) {
          this.sessionId = /\/session\/([^/]+)/.exec(resBody)[1];
        }
      }

      const resBodyObj = _appiumSupport.util.safeJsonParse(resBody);

      if (!this.downstreamProtocol) {
        this.downstreamProtocol = this.getProtocolFromResBody(resBodyObj);
      }

      if (res.statusCode < 400 && this.downstreamProtocol === MJSONWP && parseInt(resBodyObj.status, 10) !== 0) {
        const message = `The request to ${url} has failed`;
        const err = new Error(message);
        err.message = message;
        err.error = resBody;
        err.statusCode = 500;
        throw err;
      }
    } catch (e) {
      let responseError = e.error;

      try {
        responseError = JSON.parse(responseError);
      } catch (e1) {
        log.warn(`Got an unexpected response: ` + _lodash.default.truncate(_lodash.default.isString(responseError) ? responseError : JSON.stringify(responseError), {
          length: 300
        }));
      }

      throw new _errors.errors.ProxyRequestError(`Could not proxy command to remote server. ` + `Original error: ${e.message}`, responseError, e.statusCode);
    }

    return [res, resBody];
  }

  getProtocolFromResBody(resBody) {
    if (!_lodash.default.isPlainObject(resBody)) {
      try {
        resBody = JSON.parse(resBody);
      } catch (err) {
        return;
      }
    }

    if (_appiumSupport.util.hasValue(resBody.status)) {
      return MJSONWP;
    }

    if (_appiumSupport.util.hasValue(resBody.value)) {
      return W3C;
    }
  }

  requestToCommandName(url, method) {
    const extractCommandName = pattern => {
      const pathMatch = pattern.exec(url);
      return pathMatch ? (0, _routes.routeToCommandName)(pathMatch[1], method) : null;
    };

    let commandName = (0, _routes.routeToCommandName)(url, method);

    if (!commandName && _lodash.default.includes(url, '/wd/hub/session/')) {
      commandName = extractCommandName(/\/wd\/hub\/session\/[^/]+(.+)/);
    }

    if (!commandName && _lodash.default.includes(url, '/wd/hub/')) {
      commandName = extractCommandName(/\/wd\/hub(\/.+)/);
    }

    return commandName;
  }

  async proxyCommand(url, method, body = null) {
    const commandName = this.requestToCommandName(url, method);

    if (!commandName) {
      return await this.proxy(url, method, body);
    }

    log.debug(`Matched '${url}' to command name '${commandName}'`);
    return await this.protocolConverter.convertAndProxy(commandName, url, method, body);
  }

  async command(url, method, body = null) {
    let response;
    let resBody;

    try {
      [response, resBody] = await this.proxyCommand(url, method, body);
    } catch (err) {
      if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
        throw err.getActualError();
      }

      throw new _errors.errors.UnknownError(err.message);
    }

    resBody = _appiumSupport.util.safeJsonParse(resBody);
    let protocol = this.getProtocolFromResBody(resBody);

    if (protocol === MJSONWP) {
      if (response.statusCode === 200 && resBody.status === 0) {
        return resBody.value;
      }

      const status = parseInt(resBody.status, 10);

      if (!isNaN(status) && status !== 0) {
        let message = resBody.value;

        if (_lodash.default.has(resBody.value, 'message')) {
          message = _lodash.default.isEmpty(message) ? resBody.value.message : `${message} ${resBody.value.message}`;
        }

        throw (0, _errors.errorFromMJSONWPStatusCode)(status, _lodash.default.isEmpty(message) ? (0, _status.getSummaryByCode)(status) : message);
      }
    } else if (protocol === W3C) {
      if (response.statusCode < 300) {
        return resBody.value;
      }

      if (_lodash.default.isPlainObject(resBody.value) && resBody.value.error) {
        throw (0, _errors.errorFromW3CJsonCode)(resBody.value.error, resBody.value.message, resBody.value.stacktrace);
      }
    } else if (response.statusCode === 200) {
      return resBody;
    }

    throw new _errors.errors.UnknownError(`Did not know what to do with response code '${response.statusCode}' ` + `and response body '${_lodash.default.truncate(JSON.stringify(resBody), {
      length: 300
    })}'`);
  }

  getSessionIdFromUrl(url) {
    const match = url.match(/\/session\/([^/]+)/);
    return match ? match[1] : null;
  }

  async proxyReqRes(req, res) {
    let [response, body] = await this.proxyCommand(req.originalUrl, req.method, req.body);
    res.headers = response.headers;
    res.set('content-type', response.headers['content-type']);
    body = _appiumSupport.util.safeJsonParse(body);

    if (body && body.sessionId) {
      const reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

      if (reqSessionId) {
        log.info(`Replacing sessionId ${body.sessionId} with ${reqSessionId}`);
        body.sessionId = reqSessionId;
      } else if (this.sessionId) {
        log.info(`Replacing sessionId ${body.sessionId} with ${this.sessionId}`);
        body.sessionId = this.sessionId;
      }
    }

    res.status(response.statusCode).send(JSON.stringify(body));
  }

}

exports.JWProxy = JWProxy;
var _default = JWProxy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwibmFtZXMiOlsibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiTE9HX09CSl9MRU5HVEgiLCJERUZBVUxUX1JFUVVFU1RfVElNRU9VVCIsIk1KU09OV1AiLCJXM0MiLCJCYXNlRHJpdmVyIiwiRFJJVkVSX1BST1RPQ09MIiwiSldQcm94eSIsImNvbnN0cnVjdG9yIiwib3B0cyIsIk9iamVjdCIsImFzc2lnbiIsInNjaGVtZSIsInNlcnZlciIsInBvcnQiLCJiYXNlIiwic2Vzc2lvbklkIiwidGltZW91dCIsInRvTG93ZXJDYXNlIiwiX2FjdGl2ZVJlcXVlc3RzIiwiX2Rvd25zdHJlYW1Qcm90b2NvbCIsInByb3RvY29sQ29udmVydGVyIiwiUHJvdG9jb2xDb252ZXJ0ZXIiLCJwcm94eSIsImJpbmQiLCJyZXF1ZXN0IiwiYXJncyIsImN1cnJlbnRSZXF1ZXN0IiwicHVzaCIsImZpbmFsbHkiLCJfIiwicHVsbCIsImdldEFjdGl2ZVJlcXVlc3RzQ291bnQiLCJsZW5ndGgiLCJjYW5jZWxBY3RpdmVSZXF1ZXN0cyIsInIiLCJjYW5jZWwiLCJlbmRwb2ludFJlcXVpcmVzU2Vzc2lvbklkIiwiZW5kcG9pbnQiLCJpbmNsdWRlcyIsImRvd25zdHJlYW1Qcm90b2NvbCIsInZhbHVlIiwiZ2V0VXJsRm9yUHJveHkiLCJ1cmwiLCJwcm94eUJhc2UiLCJlbmRwb2ludFJlIiwicmVtYWluaW5nVXJsIiwidGVzdCIsImZpcnN0IiwiUmVnRXhwIiwiZXhlYyIsIkVycm9yIiwicmVwbGFjZSIsInN0cmlwUHJlZml4UmUiLCJyZXF1aXJlc1Nlc3Npb25JZCIsInNlc3Npb25CYXNlUmUiLCJtYXRjaCIsIm1ldGhvZCIsImJvZHkiLCJ0b1VwcGVyQ2FzZSIsIm5ld1VybCIsInJlcU9wdHMiLCJhZ2VudCIsImhlYWRlcnMiLCJhY2NlcHQiLCJyZXNvbHZlV2l0aEZ1bGxSZXNwb25zZSIsIkpTT04iLCJwYXJzZSIsImpzb24iLCJkZWJ1ZyIsInRydW5jYXRlIiwic3RyaW5naWZ5IiwicmVzIiwicmVzQm9keSIsInN0YXR1c0NvZGUiLCJyZXNCb2R5T2JqIiwidXRpbCIsInNhZmVKc29uUGFyc2UiLCJnZXRQcm90b2NvbEZyb21SZXNCb2R5IiwicGFyc2VJbnQiLCJzdGF0dXMiLCJtZXNzYWdlIiwiZXJyIiwiZXJyb3IiLCJlIiwicmVzcG9uc2VFcnJvciIsImUxIiwid2FybiIsImlzU3RyaW5nIiwiZXJyb3JzIiwiUHJveHlSZXF1ZXN0RXJyb3IiLCJpc1BsYWluT2JqZWN0IiwiaGFzVmFsdWUiLCJyZXF1ZXN0VG9Db21tYW5kTmFtZSIsImV4dHJhY3RDb21tYW5kTmFtZSIsInBhdHRlcm4iLCJwYXRoTWF0Y2giLCJjb21tYW5kTmFtZSIsInByb3h5Q29tbWFuZCIsImNvbnZlcnRBbmRQcm94eSIsImNvbW1hbmQiLCJyZXNwb25zZSIsImdldEFjdHVhbEVycm9yIiwiVW5rbm93bkVycm9yIiwicHJvdG9jb2wiLCJpc05hTiIsImhhcyIsImlzRW1wdHkiLCJzdGFja3RyYWNlIiwiZ2V0U2Vzc2lvbklkRnJvbVVybCIsInByb3h5UmVxUmVzIiwicmVxIiwib3JpZ2luYWxVcmwiLCJzZXQiLCJyZXFTZXNzaW9uSWQiLCJpbmZvIiwic2VuZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxHQUFHLEdBQUdDLHNCQUFPQyxTQUFQLENBQWlCLFVBQWpCLENBQVo7O0FBRUEsTUFBTUMsY0FBYyxHQUFHLElBQXZCO0FBQ0EsTUFBTUMsdUJBQXVCLEdBQUcsTUFBaEM7QUFFQSxNQUFNO0FBQUNDLEVBQUFBLE9BQUQ7QUFBVUMsRUFBQUE7QUFBVixJQUFpQkMsZ0JBQVdDLGVBQWxDOztBQUVBLE1BQU1DLE9BQU4sQ0FBYztBQUNaQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEJDLElBQUFBLE1BQU0sQ0FBQ0Ms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QUFRLENBQUN0QyxPQUFULENBQWlCLGNBQWpCLENBQXhCO0FBSUFMLElBQUFBLElBQUksR0FBR2tCLG9CQUFLQyxhQUFMLENBQW1CbkIsSUFBbkIsQ0FBUDs7QUFDQSxRQUFJQSxJQUFJLElBQUlBLElBQUksQ0FBQzFDLFNBQWpCLEVBQTRCO0FBQzFCLFlBQU1rRyxZQUFZLEdBQUcsS0FBS0wsbUJBQUwsQ0FBeUJFLEdBQUcsQ0FBQ0MsV0FBN0IsQ0FBckI7O0FBQ0EsVUFBSUUsWUFBSixFQUFrQjtBQUNoQnBILFFBQUFBLEdBQUcsQ0FBQ3FILElBQUosQ0FBVSx1QkFBc0J6RCxJQUFJLENBQUMxQyxTQUFVLFNBQVFrRyxZQUFhLEVBQXBFO0FBQ0F4RCxRQUFBQSxJQUFJLENBQUMxQyxTQUFMLEdBQWlCa0csWUFBakI7QUFDRCxPQUhELE1BR08sSUFBSSxLQUFLbEcsU0FBVCxFQUFvQjtBQUN6QmxCLFFBQUFBLEdBQUcsQ0FBQ3FILElBQUosQ0FBVSx1QkFBc0J6RCxJQUFJLENBQUMxQyxTQUFVLFNBQVEsS0FBS0EsU0FBVSxFQUF0RTtBQUNBMEMsUUFBQUEsSUFBSSxDQUFDMUMsU0FBTCxHQUFpQixLQUFLQSxTQUF0QjtBQUNEO0FBQ0Y7O0FBQ0R3RCxJQUFBQSxHQUFHLENBQUNRLE1BQUosQ0FBV3FCLFFBQVEsQ0FBQzNCLFVBQXBCLEVBQWdDMEMsSUFBaEMsQ0FBcUNsRCxJQUFJLENBQUNLLFNBQUwsQ0FBZWIsSUFBZixDQUFyQztBQUNEOztBQXBSVzs7O2VBd1JDbkQsTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBsb2dnZXIsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHsgZ2V0U3VtbWFyeUJ5Q29kZSB9IGZyb20gJy4uL2pzb253cC1zdGF0dXMvc3RhdHVzJztcbmltcG9ydCB7IGVycm9ycywgaXNFcnJvclR5cGUsIGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlLCBlcnJvckZyb21XM0NKc29uQ29kZSB9IGZyb20gJy4uL3Byb3RvY29sL2Vycm9ycyc7XG5pbXBvcnQgQmFzZURyaXZlciBmcm9tICcuLi9iYXNlZHJpdmVyL2RyaXZlcic7XG5pbXBvcnQgeyByb3V0ZVRvQ29tbWFuZE5hbWUgfSBmcm9tICcuLi9wcm90b2NvbC9yb3V0ZXMnO1xuaW1wb3J0IFByb3RvY29sQ29udmVydGVyIGZyb20gJy4vcHJvdG9jb2wtY29udmVydGVyJztcblxuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdXRCBQcm94eScpO1xuLy8gVE9ETzogTWFrZSB0aGlzIHZhbHVlIGNvbmZpZ3VyYWJsZSBhcyBhIHNlcnZlciBzaWRlIGNhcGFiaWxpdHlcbmNvbnN0IExPR19PQkpfTEVOR1RIID0gMTAyNDsgLy8gTUFYIExFTkdUSCBMb2dnZWQgdG8gZmlsZSAvIGNvbnNvbGVcbmNvbnN0IERFRkFVTFRfUkVRVUVTVF9USU1FT1VUID0gMjQwMDAwO1xuXG5jb25zdCB7TUpTT05XUCwgVzNDfSA9IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MO1xuXG5jbGFzcyBKV1Byb3h5IHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIE9iamVjdC5hc3NpZ24odGhpcywge1xuICAgICAgc2NoZW1lOiAnaHR0cCcsXG4gICAgICBzZXJ2ZXI6ICdsb2NhbGhvc3QnLFxuICAgICAgcG9ydDogNDQ0NCxcbiAgICAgIGJhc2U6ICcvd2QvaHViJyxcbiAgICAgIHNlc3Npb25JZDogbnVsbCxcbiAgICAgIHRpbWVvdXQ6IERFRkFVTFRfUkVRVUVTVF9USU1FT1VULFxuICAgIH0sIG9wdHMpO1xuICAgIHRoaXMuc2NoZW1lID0gdGhpcy5zY2hlbWUudG9Mb3dlckNhc2UoKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IG51bGw7XG4gICAgdGhpcy5wcm90b2NvbENvbnZlcnRlciA9IG5ldyBQcm90b2NvbENvbnZlcnRlcih0aGlzLnByb3h5LmJpbmQodGhpcykpO1xuICB9XG5cbiAgLy8gYWJzdHJhY3QgdGhlIGNhbGwgYmVoaW5kIGEgbWVtYmVyIGZ1bmN0aW9uXG4gIC8vIHNvIHRoYXQgd2UgY2FuIG1vY2sgaXQgaW4gdGVzdHNcbiAgYXN5bmMgcmVxdWVzdCAoLi4uYXJncykge1xuICAgIGNvbnN0IGN1cnJlbnRSZXF1ZXN0ID0gcmVxdWVzdCguLi5hcmdzKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cy5wdXNoKGN1cnJlbnRSZXF1ZXN0KTtcbiAgICByZXR1cm4gYXdhaXQgY3VycmVudFJlcXVlc3QuZmluYWxseSgoKSA9PiBfLnB1bGwodGhpcy5fYWN0aXZlUmVxdWVzdHMsIGN1cnJlbnRSZXF1ZXN0KSk7XG4gIH1cblxuICBnZXRBY3RpdmVSZXF1ZXN0c0NvdW50ICgpIHtcbiAgICByZXR1cm4gdGhpcy5fYWN0aXZlUmVxdWVzdHMubGVuZ3RoO1xuICB9XG5cbiAgY2FuY2VsQWN0aXZlUmVxdWVzdHMgKCkge1xuICAgIHRyeSB7XG4gICAgICBmb3IgKGxldCByIG9mIHRoaXMuX2FjdGl2ZVJlcXVlc3RzKSB7XG4gICAgICAgIHIuY2FuY2VsKCk7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzID0gW107XG4gICAgfVxuICB9XG5cbiAgZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZCAoZW5kcG9pbnQpIHtcbiAgICByZXR1cm4gIV8uaW5jbHVkZXMoWycvc2Vzc2lvbicsICcvc2Vzc2lvbnMnLCAnL3N0YXR1cyddLCBlbmRwb2ludCk7XG4gIH1cblxuICBzZXQgZG93bnN0cmVhbVByb3RvY29sICh2YWx1ZSkge1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IHZhbHVlO1xuICAgIHRoaXMucHJvdG9jb2xDb252ZXJ0ZXIuZG93bnN0cmVhbVByb3RvY29sID0gdmFsdWU7XG4gIH1cblxuICBnZXQgZG93bnN0cmVhbVByb3RvY29sICgpIHtcbiAgICByZXR1cm4gdGhpcy5fZG93bnN0cmVhbVByb3RvY29sO1xuICB9XG5cbiAgZ2V0VXJsRm9yUHJveHkgKHVybCkge1xuICAgIGlmICh1cmwgPT09ICcnKSB7XG4gICAgICB1cmwgPSAnLyc7XG4gICAgfVxuICAgIGNvbnN0IHByb3h5QmFzZSA9IGAke3RoaXMuc2NoZW1lfTovLyR7dGhpcy5zZXJ2ZXJ9OiR7dGhpcy5wb3J0fSR7dGhpcy5iYXNlfWA7XG4gICAgY29uc3QgZW5kcG9pbnRSZSA9ICcoLyhzZXNzaW9ufHN0YXR1cykpJztcbiAgICBsZXQgcmVtYWluaW5nVXJsID0gJyc7XG4gICAgaWYgKC9eaHR0cC8udGVzdCh1cmwpKSB7XG4gICAgICBjb25zdCBmaXJzdCA9IChuZXcgUmVnRXhwKGAoaHR0cHM/Oi8vLispJHtlbmRwb2ludFJlfWApKS5leGVjKHVybCk7XG4gICAgICBpZiAoIWZpcnN0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignR290IGEgY29tcGxldGUgdXJsIGJ1dCBjb3VsZCBub3QgZXh0cmFjdCBKV1AgZW5kcG9pbnQnKTtcbiAgICAgIH1cbiAgICAgIHJlbWFpbmluZ1VybCA9IHVybC5yZXBsYWNlKGZpcnN0WzFdLCAnJyk7XG4gICAgfSBlbHNlIGlmICgobmV3IFJlZ0V4cCgnXi8nKSkudGVzdCh1cmwpKSB7XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCB1cmwgJyR7dXJsfSdgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJpcFByZWZpeFJlID0gbmV3IFJlZ0V4cCgnXi4qPygvKHNlc3Npb258c3RhdHVzKS4qKSQnKTtcbiAgICBpZiAoc3RyaXBQcmVmaXhSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHN0cmlwUHJlZml4UmUuZXhlYyhyZW1haW5pbmdVcmwpWzFdO1xuICAgIH1cblxuICAgIGlmICghKG5ldyBSZWdFeHAoZW5kcG9pbnRSZSkpLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9JHtyZW1haW5pbmdVcmx9YDtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1aXJlc1Nlc3Npb25JZCA9IHRoaXMuZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZChyZW1haW5pbmdVcmwpO1xuXG4gICAgaWYgKHJlcXVpcmVzU2Vzc2lvbklkICYmIHRoaXMuc2Vzc2lvbklkID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byBwcm94eSBhIHNlc3Npb24gY29tbWFuZCB3aXRob3V0IHNlc3Npb24gaWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uQmFzZVJlID0gbmV3IFJlZ0V4cCgnXi9zZXNzaW9uLyhbXi9dKyknKTtcbiAgICBpZiAoc2Vzc2lvbkJhc2VSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIC8vIHdlIGhhdmUgc29tZXRoaW5nIGxpa2UgL3Nlc3Npb24vOmlkL2Zvb2Jhciwgc28gd2UgbmVlZCB0byByZXBsYWNlXG4gICAgICAvLyB0aGUgc2Vzc2lvbiBpZFxuICAgICAgY29uc3QgbWF0Y2ggPSBzZXNzaW9uQmFzZVJlLmV4ZWMocmVtYWluaW5nVXJsKTtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHJlbWFpbmluZ1VybC5yZXBsYWNlKG1hdGNoWzFdLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlc1Nlc3Npb25JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCA6c2Vzc2lvbiBzZWN0aW9uIGZvciB1cmw6ICR7cmVtYWluaW5nVXJsfWApO1xuICAgIH1cbiAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZSgvXFwvJC8sICcnKTsgLy8gY2FuJ3QgaGF2ZSB0cmFpbGluZyBzbGFzaGVzXG5cbiAgICByZXR1cm4gcHJveHlCYXNlICsgcmVtYWluaW5nVXJsO1xuICB9XG5cbiAgYXN5bmMgcHJveHkgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIG1ldGhvZCA9IG1ldGhvZC50b1VwcGVyQ2FzZSgpO1xuICAgIGNvbnN0IG5ld1VybCA9IHRoaXMuZ2V0VXJsRm9yUHJveHkodXJsKTtcbiAgICBjb25zdCByZXFPcHRzID0ge1xuICAgICAgYWdlbnQ6IGZhbHNlLFxuICAgICAgdXJsOiBuZXdVcmwsXG4gICAgICBtZXRob2QsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcsXG4gICAgICAgICd1c2VyLWFnZW50JzogJ2FwcGl1bScsXG4gICAgICAgIGFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24sICovKicsXG4gICAgICB9LFxuICAgICAgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWUsXG4gICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgfTtcbiAgICBpZiAoYm9keSAhPT0gbnVsbCkge1xuICAgICAgaWYgKHR5cGVvZiBib2R5ICE9PSAnb2JqZWN0Jykge1xuICAgICAgICBib2R5ID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgIH1cbiAgICAgIHJlcU9wdHMuanNvbiA9IGJvZHk7XG4gICAgfVxuXG4gICAgLy8gR0VUIG1ldGhvZHMgc2hvdWxkbid0IGhhdmUgYW55IGJvZHkuIE1vc3Qgc2VydmVycyBhcmUgT0sgd2l0aCB0aGlzLCBidXQgV2ViRHJpdmVyQWdlbnQgdGhyb3dzIDQwMCBlcnJvcnNcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcmVxT3B0cy5qc29uID0gbnVsbDtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFByb3h5aW5nIFske21ldGhvZH0gJHt1cmwgfHwgJy8nfV0gdG8gWyR7bWV0aG9kfSAke25ld1VybH1dIGAgK1xuICAgICAgICAgICAgIChib2R5ID8gYHdpdGggYm9keTogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KGJvZHkpLCB7bGVuZ3RoOiBMT0dfT0JKX0xFTkdUSH0pfWAgOiAnd2l0aCBubyBib2R5JykpO1xuXG4gICAgbGV0IHJlcywgcmVzQm9keTtcbiAgICB0cnkge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5yZXF1ZXN0KHJlcU9wdHMpO1xuICAgICAgcmVzQm9keSA9IHJlcy5ib2R5O1xuICAgICAgbG9nLmRlYnVnKGBHb3QgcmVzcG9uc2Ugd2l0aCBzdGF0dXMgJHtyZXMuc3RhdHVzQ29kZX06ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShyZXNCb2R5KSwge2xlbmd0aDogTE9HX09CSl9MRU5HVEh9KX1gKTtcbiAgICAgIGlmICgvXFwvc2Vzc2lvbiQvLnRlc3QodXJsKSAmJiBtZXRob2QgPT09ICdQT1NUJykge1xuICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gcmVzQm9keS5zZXNzaW9uSWQ7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDMwMykge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gL1xcL3Nlc3Npb25cXC8oW14vXSspLy5leGVjKHJlc0JvZHkpWzFdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCByZXNCb2R5T2JqID0gdXRpbC5zYWZlSnNvblBhcnNlKHJlc0JvZHkpO1xuICAgICAgaWYgKCF0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCkge1xuICAgICAgICB0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCA9IHRoaXMuZ2V0UHJvdG9jb2xGcm9tUmVzQm9keShyZXNCb2R5T2JqKTtcbiAgICAgIH1cbiAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA8IDQwMCAmJiB0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCA9PT0gTUpTT05XUCAmJiBwYXJzZUludChyZXNCb2R5T2JqLnN0YXR1cywgMTApICE9PSAwKSB7XG4gICAgICAgIC8vIFNvbWUgc2VydmVycywgbGlrZSBjaHJvbWVkcml2ZXIgbWF5IHJldHVybiByZXNwb25zZSBjb2RlIDIwMCBmb3Igbm9uLXplcm8gSlNPTldQIHN0YXR1c2VzXG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgVGhlIHJlcXVlc3QgdG8gJHt1cmx9IGhhcyBmYWlsZWRgO1xuICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgICAgIGVyci5tZXNzYWdlID0gbWVzc2FnZTtcbiAgICAgICAgZXJyLmVycm9yID0gcmVzQm9keTtcbiAgICAgICAgZXJyLnN0YXR1c0NvZGUgPSA1MDA7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsZXQgcmVzcG9uc2VFcnJvciA9IGUuZXJyb3I7XG4gICAgICB0cnkge1xuICAgICAgICByZXNwb25zZUVycm9yID0gSlNPTi5wYXJzZShyZXNwb25zZUVycm9yKTtcbiAgICAgIH0gY2F0Y2ggKGUxKSB7XG4gICAgICAgIGxvZy53YXJuKGBHb3QgYW4gdW5leHBlY3RlZCByZXNwb25zZTogYCArXG4gICAgICAgICAgXy50cnVuY2F0ZShfLmlzU3RyaW5nKHJlc3BvbnNlRXJyb3IpID8gcmVzcG9uc2VFcnJvciA6IEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlRXJyb3IpLCB7bGVuZ3RoOiAzMDB9KSk7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlByb3h5UmVxdWVzdEVycm9yKGBDb3VsZCBub3QgcHJveHkgY29tbWFuZCB0byByZW1vdGUgc2VydmVyLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWAsIHJlc3BvbnNlRXJyb3IsIGUuc3RhdHVzQ29kZSk7XG4gICAgfVxuICAgIHJldHVybiBbcmVzLCByZXNCb2R5XTtcbiAgfVxuXG4gIGdldFByb3RvY29sRnJvbVJlc0JvZHkgKHJlc0JvZHkpIHtcbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChyZXNCb2R5KSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmVzQm9keSA9IEpTT04ucGFyc2UocmVzQm9keSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodXRpbC5oYXNWYWx1ZShyZXNCb2R5LnN0YXR1cykpIHtcbiAgICAgIHJldHVybiBNSlNPTldQO1xuICAgIH1cbiAgICBpZiAodXRpbC5oYXNWYWx1ZShyZXNCb2R5LnZhbHVlKSkge1xuICAgICAgcmV0dXJuIFczQztcbiAgICB9XG4gIH1cblxuICByZXF1ZXN0VG9Db21tYW5kTmFtZSAodXJsLCBtZXRob2QpIHtcbiAgICBjb25zdCBleHRyYWN0Q29tbWFuZE5hbWUgPSAocGF0dGVybikgPT4ge1xuICAgICAgY29uc3QgcGF0aE1hdGNoID0gcGF0dGVybi5leGVjKHVybCk7XG4gICAgICByZXR1cm4gcGF0aE1hdGNoID8gcm91dGVUb0NvbW1hbmROYW1lKHBhdGhNYXRjaFsxXSwgbWV0aG9kKSA6IG51bGw7XG4gICAgfTtcbiAgICBsZXQgY29tbWFuZE5hbWUgPSByb3V0ZVRvQ29tbWFuZE5hbWUodXJsLCBtZXRob2QpO1xuICAgIGlmICghY29tbWFuZE5hbWUgJiYgXy5pbmNsdWRlcyh1cmwsICcvd2QvaHViL3Nlc3Npb24vJykpIHtcbiAgICAgIGNvbW1hbmROYW1lID0gZXh0cmFjdENvbW1hbmROYW1lKC9cXC93ZFxcL2h1YlxcL3Nlc3Npb25cXC9bXi9dKyguKykvKTtcbiAgICB9XG4gICAgaWYgKCFjb21tYW5kTmFtZSAmJiBfLmluY2x1ZGVzKHVybCwgJy93ZC9odWIvJykpIHtcbiAgICAgIGNvbW1hbmROYW1lID0gZXh0cmFjdENvbW1hbmROYW1lKC9cXC93ZFxcL2h1YihcXC8uKykvKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbW1hbmROYW1lO1xuICB9XG5cbiAgYXN5bmMgcHJveHlDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBjb25zdCBjb21tYW5kTmFtZSA9IHRoaXMucmVxdWVzdFRvQ29tbWFuZE5hbWUodXJsLCBtZXRob2QpO1xuICAgIGlmICghY29tbWFuZE5hbWUpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5KHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBNYXRjaGVkICcke3VybH0nIHRvIGNvbW1hbmQgbmFtZSAnJHtjb21tYW5kTmFtZX0nYCk7XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm90b2NvbENvbnZlcnRlci5jb252ZXJ0QW5kUHJveHkoY29tbWFuZE5hbWUsIHVybCwgbWV0aG9kLCBib2R5KTtcbiAgfVxuXG4gIGFzeW5jIGNvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIGxldCByZXNwb25zZTtcbiAgICBsZXQgcmVzQm9keTtcbiAgICB0cnkge1xuICAgICAgW3Jlc3BvbnNlLCByZXNCb2R5XSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChpc0Vycm9yVHlwZShlcnIsIGVycm9ycy5Qcm94eVJlcXVlc3RFcnJvcikpIHtcbiAgICAgICAgdGhyb3cgZXJyLmdldEFjdHVhbEVycm9yKCk7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihlcnIubWVzc2FnZSk7XG4gICAgfVxuICAgIHJlc0JvZHkgPSB1dGlsLnNhZmVKc29uUGFyc2UocmVzQm9keSk7XG4gICAgbGV0IHByb3RvY29sID0gdGhpcy5nZXRQcm90b2NvbEZyb21SZXNCb2R5KHJlc0JvZHkpO1xuICAgIGlmIChwcm90b2NvbCA9PT0gTUpTT05XUCkge1xuICAgICAgLy8gR290IHJlc3BvbnNlIGluIE1KU09OV1AgZm9ybWF0XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwICYmIHJlc0JvZHkuc3RhdHVzID09PSAwKSB7XG4gICAgICAgIHJldHVybiByZXNCb2R5LnZhbHVlO1xuICAgICAgfVxuICAgICAgY29uc3Qgc3RhdHVzID0gcGFyc2VJbnQocmVzQm9keS5zdGF0dXMsIDEwKTtcbiAgICAgIGlmICghaXNOYU4oc3RhdHVzKSAmJiBzdGF0dXMgIT09IDApIHtcbiAgICAgICAgbGV0IG1lc3NhZ2UgPSByZXNCb2R5LnZhbHVlO1xuICAgICAgICBpZiAoXy5oYXMocmVzQm9keS52YWx1ZSwgJ21lc3NhZ2UnKSkge1xuICAgICAgICAgIG1lc3NhZ2UgPSBfLmlzRW1wdHkobWVzc2FnZSkgPyByZXNCb2R5LnZhbHVlLm1lc3NhZ2UgOiBgJHttZXNzYWdlfSAke3Jlc0JvZHkudmFsdWUubWVzc2FnZX1gO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlKHN0YXR1cywgXy5pc0VtcHR5KG1lc3NhZ2UpID8gZ2V0U3VtbWFyeUJ5Q29kZShzdGF0dXMpIDogbWVzc2FnZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwcm90b2NvbCA9PT0gVzNDKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gVzNDIGZvcm1hdFxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDApIHtcbiAgICAgICAgcmV0dXJuIHJlc0JvZHkudmFsdWU7XG4gICAgICB9XG4gICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHJlc0JvZHkudmFsdWUpICYmIHJlc0JvZHkudmFsdWUuZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3JGcm9tVzNDSnNvbkNvZGUocmVzQm9keS52YWx1ZS5lcnJvciwgcmVzQm9keS52YWx1ZS5tZXNzYWdlLCByZXNCb2R5LnZhbHVlLnN0YWNrdHJhY2UpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAvLyBVbmtub3duIHByb3RvY29sLiBLZWVwaW5nIGl0IGJlY2F1c2Ugb2YgdGhlIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICAgIHJldHVybiByZXNCb2R5O1xuICAgIH1cbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCByZXNwb25zZSBjb2RlICcke3Jlc3BvbnNlLnN0YXR1c0NvZGV9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgYW5kIHJlc3BvbnNlIGJvZHkgJyR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShyZXNCb2R5KSwge2xlbmd0aDogMzAwfSl9J2ApO1xuICB9XG5cbiAgZ2V0U2Vzc2lvbklkRnJvbVVybCAodXJsKSB7XG4gICAgY29uc3QgbWF0Y2ggPSB1cmwubWF0Y2goL1xcL3Nlc3Npb25cXC8oW14vXSspLyk7XG4gICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsO1xuICB9XG5cbiAgYXN5bmMgcHJveHlSZXFSZXMgKHJlcSwgcmVzKSB7XG4gICAgbGV0IFtyZXNwb25zZSwgYm9keV0gPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChyZXEub3JpZ2luYWxVcmwsIHJlcS5tZXRob2QsIHJlcS5ib2R5KTtcblxuICAgIHJlcy5oZWFkZXJzID0gcmVzcG9uc2UuaGVhZGVycztcbiAgICByZXMuc2V0KCdjb250ZW50LXR5cGUnLCByZXNwb25zZS5oZWFkZXJzWydjb250ZW50LXR5cGUnXSk7XG4gICAgLy8gaWYgdGhlIHByb3hpZWQgcmVzcG9uc2UgY29udGFpbnMgYSBzZXNzaW9uSWQgdGhhdCB0aGUgZG93bnN0cmVhbVxuICAgIC8vIGRyaXZlciBoYXMgZ2VuZXJhdGVkLCB3ZSBkb24ndCB3YW50IHRvIHJldHVybiB0aGF0IHRvIHRoZSBjbGllbnQuXG4gICAgLy8gSW5zdGVhZCwgcmV0dXJuIHRoZSBpZCBmcm9tIHRoZSByZXF1ZXN0IG9yIGZyb20gY3VycmVudCBzZXNzaW9uXG4gICAgYm9keSA9IHV0aWwuc2FmZUpzb25QYXJzZShib2R5KTtcbiAgICBpZiAoYm9keSAmJiBib2R5LnNlc3Npb25JZCkge1xuICAgICAgY29uc3QgcmVxU2Vzc2lvbklkID0gdGhpcy5nZXRTZXNzaW9uSWRGcm9tVXJsKHJlcS5vcmlnaW5hbFVybCk7XG4gICAgICBpZiAocmVxU2Vzc2lvbklkKSB7XG4gICAgICAgIGxvZy5pbmZvKGBSZXBsYWNpbmcgc2Vzc2lvbklkICR7Ym9keS5zZXNzaW9uSWR9IHdpdGggJHtyZXFTZXNzaW9uSWR9YCk7XG4gICAgICAgIGJvZHkuc2Vzc2lvbklkID0gcmVxU2Vzc2lvbklkO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLnNlc3Npb25JZCkge1xuICAgICAgICBsb2cuaW5mbyhgUmVwbGFjaW5nIHNlc3Npb25JZCAke2JvZHkuc2Vzc2lvbklkfSB3aXRoICR7dGhpcy5zZXNzaW9uSWR9YCk7XG4gICAgICAgIGJvZHkuc2Vzc2lvbklkID0gdGhpcy5zZXNzaW9uSWQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJlcy5zdGF0dXMocmVzcG9uc2Uuc3RhdHVzQ29kZSkuc2VuZChKU09OLnN0cmluZ2lmeShib2R5KSk7XG4gIH1cbn1cblxuZXhwb3J0IHsgSldQcm94eSB9O1xuZXhwb3J0IGRlZmF1bHQgSldQcm94eTtcbiJdLCJmaWxlIjoibGliL2pzb253cC1wcm94eS9wcm94eS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
