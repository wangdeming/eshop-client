"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.CUSTOM_STRATEGY = exports.IMAGE_STRATEGY = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../../..");

var _images = require("./images");

var _protocol = require("../../protocol/protocol");

var _imageElement = require("../image-element");

const commands = {},
      helpers = {},
      extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const IMAGE_STRATEGY = '-image';
exports.IMAGE_STRATEGY = IMAGE_STRATEGY;
const CUSTOM_STRATEGY = '-custom';
exports.CUSTOM_STRATEGY = CUSTOM_STRATEGY;

helpers.findElOrElsWithProcessing = async function (strategy, selector, mult, context) {
  this.validateLocatorStrategy(strategy);

  try {
    return await this.findElOrEls(strategy, selector, mult, context);
  } catch (err) {
    if (this.opts.printPageSourceOnFindFailure) {
      const src = await this.getPageSource();

      _logger.default.debug(`Error finding element${mult ? 's' : ''}: ${err.message}`);

      _logger.default.debug(`Page source requested through 'printPageSourceOnFindFailure':`);

      _logger.default.debug(src);
    }

    throw err;
  }
};

commands.findElement = async function (strategy, selector) {
  if (strategy === IMAGE_STRATEGY) {
    return await this.findByImage(selector, {
      multiple: false
    });
  } else if (strategy === CUSTOM_STRATEGY) {
    return await this.findByCustom(selector, false);
  }

  return await this.findElOrElsWithProcessing(strategy, selector, false);
};

commands.findElements = async function (strategy, selector) {
  if (strategy === IMAGE_STRATEGY) {
    return await this.findByImage(selector, {
      multiple: true
    });
  } else if (strategy === CUSTOM_STRATEGY) {
    return await this.findByCustom(selector, true);
  }

  return await this.findElOrElsWithProcessing(strategy, selector, true);
};

commands.findElementFromElement = async function (strategy, selector, elementId) {
  return await this.findElOrElsWithProcessing(strategy, selector, false, elementId);
};

commands.findElementsFromElement = async function (strategy, selector, elementId) {
  return await this.findElOrElsWithProcessing(strategy, selector, true, elementId);
};

commands.findByCustom = async function (selector, multiple) {
  const plugins = this.opts.customFindModules;

  if (!plugins) {
    throw new Error('Finding an element using a plugin is currently an ' + 'incubating feature. To use it you must manually install one or more ' + 'plugin modules in a way that they can be required by Appium, for ' + 'example installing them from the Appium directory, installing them ' + 'globally, or installing them elsewhere and passing an absolute path as ' + 'the capability. Then construct an object where the key is the shortcut ' + 'name for this plugin and the value is the module name or absolute path, ' + 'for example: {"p1": "my-find-plugin"}, and pass this in as the ' + "'customFindModules' capability.");
  }

  if (!_lodash.default.isPlainObject(plugins)) {
    throw new Error("Invalid format for the 'customFindModules' capability. " + 'It should be an object with keys corresponding to the short names and ' + 'values corresponding to the full names of the element finding plugins');
  }

  let [plugin, realSelector] = selector.split(':');

  if (_lodash.default.size(plugins) > 1 && !realSelector) {
    throw new Error(`Multiple element finding plugins were registered ` + `(${_lodash.default.keys(plugins)}), but your selector did not indicate which plugin ` + `to use. Ensure you put the short name of the plugin followed by ':' as ` + `the initial part of the selector string.`);
  }

  if (_lodash.default.size(plugins) === 1 && !realSelector) {
    realSelector = plugin;
    plugin = _lodash.default.keys(plugins)[0];
  }

  if (!plugins[plugin]) {
    throw new Error(`Selector specified use of element finding plugin ` + `'${plugin}' but it was not registered in the 'customFindModules' ` + `capability.`);
  }

  let finder;

  try {
    _logger.default.debug(`Find plugin '${plugin}' requested; will attempt to use it ` + `from '${plugins[plugin]}'`);

    finder = require(plugins[plugin]);
  } catch (err) {
    throw new Error(`Could not load your custom find module '${plugin}'. Did ` + `you put it somewhere Appium can 'require' it? Original error: ${err}`);
  }

  if (!finder || !_lodash.default.isFunction(finder.find)) {
    throw new Error('Your custom find module did not appear to be constructed ' + 'correctly. It needs to export an object with a `find` method.');
  }

  const customFinderLog = _appiumSupport.logger.getLogger(plugin);

  let elements;

  const condition = async () => {
    elements = await finder.find(this, customFinderLog, realSelector, multiple);

    if (!_lodash.default.isEmpty(elements) || multiple) {
      return true;
    }

    return false;
  };

  try {
    await this.implicitWaitForCondition(condition);
  } catch (err) {
    if (err.message.match(/Condition unmet/)) {
      throw new _2.errors.NoSuchElementError();
    }

    throw err;
  }

  return multiple ? elements : elements[0];
};

helpers.findByImage = async function (b64Template, {
  shouldCheckStaleness = false,
  multiple = false
}) {
  const {
    imageMatchThreshold: threshold,
    fixImageTemplateSize,
    fixImageTemplateScale
  } = this.settings.getSettings();

  _logger.default.info(`Finding image element with match threshold ${threshold}`);

  if (!this.getWindowSize) {
    throw new Error("This driver does not support the required 'getWindowSize' command");
  }

  const {
    width: screenWidth,
    height: screenHeight
  } = await this.getWindowSize();

  if (fixImageTemplateSize) {
    b64Template = await this.ensureTemplateSize(b64Template, screenWidth, screenHeight);
  }

  let rect = null;

  const condition = async () => {
    try {
      const {
        b64Screenshot,
        scale
      } = await this.getScreenshotForImageFind(screenWidth, screenHeight);

      if (fixImageTemplateScale) {
        b64Template = await this.fixImageTemplateScale(b64Template, scale);
      }

      rect = (await this.compareImages(_images.MATCH_TEMPLATE_MODE, b64Screenshot, b64Template, {
        threshold
      })).rect;
      return true;
    } catch (err) {
      if (err.message.match(/Cannot find any occurrences/)) {
        return false;
      }

      throw err;
    }
  };

  try {
    await this.implicitWaitForCondition(condition);
  } catch (err) {
    if (!err.message.match(/Condition unmet/)) {
      throw err;
    }
  }

  if (!rect) {
    if (multiple) {
      return [];
    }

    throw new _2.errors.NoSuchElementError();
  }

  _logger.default.info(`Image template matched: ${JSON.stringify(rect)}`);

  const imgEl = new _imageElement.ImageElement(b64Template, rect);

  if (shouldCheckStaleness) {
    return imgEl;
  }

  this._imgElCache.set(imgEl.id, imgEl);

  const protoKey = this.isW3CProtocol() ? _protocol.W3C_ELEMENT_KEY : _protocol.MJSONWP_ELEMENT_KEY;
  const protocolEl = imgEl.asElement(protoKey);
  return multiple ? [protocolEl] : protocolEl;
};

helpers.ensureTemplateSize = async function (b64Template, screenWidth, screenHeight) {
  let imgObj = await _appiumSupport.imageUtil.getJimpImage(b64Template);
  let {
    width: tplWidth,
    height: tplHeight
  } = imgObj.bitmap;

  _logger.default.info(`Template image is ${tplWidth}x${tplHeight}. Screen size is ${screenWidth}x${screenHeight}`);

  if (tplWidth <= screenWidth && tplHeight <= screenHeight) {
    return b64Template;
  }

  _logger.default.info(`Scaling template image from ${tplWidth}x${tplHeight} to match ` + `screen at ${screenWidth}x${screenHeight}`);

  imgObj = imgObj.scaleToFit(screenWidth, screenHeight);
  return (await imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
};

helpers.getScreenshotForImageFind = async function (screenWidth, screenHeight) {
  if (!this.getScreenshot) {
    throw new Error("This driver does not support the required 'getScreenshot' command");
  }

  let b64Screenshot = await this.getScreenshot();

  if (!this.settings.getSettings().fixImageFindScreenshotDims) {
    _logger.default.info(`Not verifying screenshot dimensions match screen`);

    return {
      b64Screenshot
    };
  }

  _logger.default.info('Verifying screenshot size and aspect ratio');

  let imgObj = await _appiumSupport.imageUtil.getJimpImage(b64Screenshot);
  let {
    width: shotWidth,
    height: shotHeight
  } = imgObj.bitmap;

  if (screenWidth === shotWidth && screenHeight === shotHeight) {
    _logger.default.info('Screenshot size matched screen size');

    return {
      b64Screenshot
    };
  }

  let scale;

  if (screenWidth !== shotWidth && screenHeight !== shotHeight) {
    _logger.default.info(`Scaling screenshot from ${shotWidth}x${shotHeight} to match ` + `screen at ${screenWidth}x${screenHeight}`);

    imgObj = imgObj.resize(screenWidth, screenHeight);
    scale = {
      xScale: 1.0 * screenWidth / shotWidth,
      yScale: 1.0 * screenHeight / shotHeight
    };
  }

  b64Screenshot = (await imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
  return {
    b64Screenshot,
    scale
  };
};

helpers.fixImageTemplateScale = async function (b64Template, scale = {}) {
  if (!scale) {
    return b64Template;
  }

  const {
    xScale,
    yScale
  } = scale;

  if (!xScale || !yScale) {
    return b64Template;
  }

  let imgTempObj = await _appiumSupport.imageUtil.getJimpImage(b64Template);
  let {
    width: baseTempWidth,
    height: baseTempHeigh
  } = imgTempObj.bitmap;
  const scaledWidth = baseTempWidth * xScale;
  const scaledHeight = baseTempHeigh * yScale;

  _logger.default.info(`Scaling template image from ${baseTempWidth}x${baseTempHeigh}` + ` to ${scaledWidth}x${scaledHeight}`);

  _logger.default.info(`The ratio is ${xScale} and ${yScale}`);

  imgTempObj = await imgTempObj.resize(scaledWidth, scaledHeight);
  return (await imgTempObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL2ZpbmQuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIklNQUdFX1NUUkFURUdZIiwiQ1VTVE9NX1NUUkFURUdZIiwiZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsInZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5IiwiZmluZEVsT3JFbHMiLCJlcnIiLCJvcHRzIiwicHJpbnRQYWdlU291cmNlT25GaW5kRmFpbHVyZSIsInNyYyIsImdldFBhZ2VTb3VyY2UiLCJsb2ciLCJkZWJ1ZyIsIm1lc3NhZ2UiLCJmaW5kRWxlbWVudCIsImZpbmRCeUltYWdlIiwibXVsdGlwbGUiLCJmaW5kQnlDdXN0b20iLCJmaW5kRWxlbWVudHMiLCJmaW5kRWxlbWVudEZyb21FbGVtZW50IiwiZWxlbWVudElkIiwiZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQiLCJwbHVnaW5zIiwiY3VzdG9tRmluZE1vZHVsZXMiLCJFcnJvciIsIl8iLCJpc1BsYWluT2JqZWN0IiwicGx1Z2luIiwicmVhbFNlbGVjdG9yIiwic3BsaXQiLCJzaXplIiwia2V5cyIsImZpbmRlciIsInJlcXVpcmUiLCJpc0Z1bmN0aW9uIiwiZmluZCIsImN1c3RvbUZpbmRlckxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsImVsZW1lbnRzIiwiY29uZGl0aW9uIiwiaXNFbXB0eSIsImltcGxpY2l0V2FpdEZvckNvbmRpdGlvbiIsIm1hdGNoIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiYjY0VGVtcGxhdGUiLCJzaG91bGRDaGVja1N0YWxlbmVzcyIsImltYWdlTWF0Y2hUaHJlc2hvbGQiLCJ0aHJlc2hvbGQiLCJmaXhJbWFnZVRlbXBsYXRlU2l6ZSIsImZpeEltYWdlVGVtcGxhdGVTY2FsZSIsInNldHRpbmdzIiwiZ2V0U2V0dGluZ3MiLCJpbmZvIiwiZ2V0V2luZG93U2l6ZSIsIndpZHRoIiwic2NyZWVuV2lkdGgiLCJoZWlnaHQiLCJzY3JlZW5IZWlnaHQiLCJlbnN1cmVUZW1wbGF0ZVNpemUiLCJyZWN0IiwiYjY0U2NyZWVuc2hvdCIsInNjYWxlIiwiZ2V0U2NyZWVuc2hvdEZvckltYWdlRmluZCIsImNvbXBhcmVJbWFnZXMiLCJNQVRDSF9URU1QTEFURV9NT0RFIiwiSlNPTiIsInN0cmluZ2lmeSIsImltZ0VsIiwiSW1hZ2VFbGVtZW50IiwiX2ltZ0VsQ2FjaGUiLCJzZXQiLCJpZCIsInByb3RvS2V5IiwiaXNXM0NQcm90b2NvbCIsIlczQ19FTEVNRU5UX0tFWSIsIk1KU09OV1BfRUxFTUVOVF9LRVkiLCJwcm90b2NvbEVsIiwiYXNFbGVtZW50IiwiaW1nT2JqIiwiaW1hZ2VVdGlsIiwiZ2V0SmltcEltYWdlIiwidHBsV2lkdGgiLCJ0cGxIZWlnaHQiLCJiaXRtYXAiLCJzY2FsZVRvRml0IiwiZ2V0QnVmZmVyIiwiTUlNRV9QTkciLCJ0b1N0cmluZyIsImdldFNjcmVlbnNob3QiLCJmaXhJbWFnZUZpbmRTY3JlZW5zaG90RGltcyIsInNob3RXaWR0aCIsInNob3RIZWlnaHQiLCJyZXNpemUiLCJ4U2NhbGUiLCJ5U2NhbGUiLCJpbWdUZW1wT2JqIiwiYmFzZVRlbXBXaWR0aCIsImJhc2VUZW1wSGVpZ2giLCJzY2FsZWRXaWR0aCIsInNjYWxlZEhlaWdodCIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxRQUFRLEdBQUcsRUFBakI7QUFBQSxNQUFxQkMsT0FBTyxHQUFHLEVBQS9CO0FBQUEsTUFBbUNDLFVBQVUsR0FBRyxFQUFoRDs7O0FBRUEsTUFBTUMsY0FBYyxHQUFHLFFBQXZCOztBQUNBLE1BQU1DLGVBQWUsR0FBRyxTQUF4Qjs7O0FBY0FILE9BQU8sQ0FBQ0kseUJBQVIsR0FBb0MsZ0JBQWdCQyxRQUFoQixFQUEwQkMsUUFB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b2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGxvZ2dlciwgaW1hZ2VVdGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJy4uLy4uLy4uJztcbmltcG9ydCB7IE1BVENIX1RFTVBMQVRFX01PREUgfSBmcm9tICcuL2ltYWdlcyc7XG5pbXBvcnQgeyBXM0NfRUxFTUVOVF9LRVksIE1KU09OV1BfRUxFTUVOVF9LRVkgfSBmcm9tICcuLi8uLi9wcm90b2NvbC9wcm90b2NvbCc7XG5pbXBvcnQgeyBJbWFnZUVsZW1lbnQgfSBmcm9tICcuLi9pbWFnZS1lbGVtZW50JztcblxuXG5jb25zdCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgSU1BR0VfU1RSQVRFR1kgPSAnLWltYWdlJztcbmNvbnN0IENVU1RPTV9TVFJBVEVHWSA9ICctY3VzdG9tJztcblxuLy8gT3ZlcnJpZGUgdGhlIGZvbGxvd2luZyBmdW5jdGlvbiBmb3IgeW91ciBvd24gZHJpdmVyLCBhbmQgdGhlIHJlc3QgaXMgdGFrZW5cbi8vIGNhcmUgb2YhXG5cbi8vIGhlbHBlcnMuZmluZEVsT3JFbHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7fVxuLy8gICBzdHJhdGVneTogbG9jYXRvciBzdHJhdGVneVxuLy8gICBzZWxlY3RvcjogdGhlIGFjdHVhbCBzZWxlY3RvciBmb3IgZmluZGluZyBhbiBlbGVtZW50XG4vLyAgIG11bHQ6IG11bHRpcGxlIGVsZW1lbnRzIG9yIGp1c3Qgb25lP1xuLy8gICBjb250ZXh0OiBmaW5kaW5nIGFuIGVsZW1lbnQgZnJvbSB0aGUgcm9vdCBjb250ZXh0PyBvciBzdGFydGluZyBmcm9tIGFub3RoZXIgZWxlbWVudFxuLy9cbi8vIFJldHVybnMgYW4gb2JqZWN0IHdoaWNoIGFkaGVyZXMgdG8gdGhlIHdheSB0aGUgSlNPTiBXaXJlIFByb3RvY29sIHJlcHJlc2VudHMgZWxlbWVudHM6XG4vLyB7IEVMRU1FTlQ6ICMgfSAgICBlZzogeyBFTEVNRU5UOiAzIH0gIG9yIHsgRUxFTUVOVDogMS4wMjMgfVxuXG5oZWxwZXJzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3NpbmcgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gIHRoaXMudmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3koc3RyYXRlZ3kpO1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICh0aGlzLm9wdHMucHJpbnRQYWdlU291cmNlT25GaW5kRmFpbHVyZSkge1xuICAgICAgY29uc3Qgc3JjID0gYXdhaXQgdGhpcy5nZXRQYWdlU291cmNlKCk7XG4gICAgICBsb2cuZGVidWcoYEVycm9yIGZpbmRpbmcgZWxlbWVudCR7bXVsdCA/ICdzJyA6ICcnfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIGxvZy5kZWJ1ZyhgUGFnZSBzb3VyY2UgcmVxdWVzdGVkIHRocm91Z2ggJ3ByaW50UGFnZVNvdXJjZU9uRmluZEZhaWx1cmUnOmApO1xuICAgICAgbG9nLmRlYnVnKHNyYyk7XG4gICAgfVxuICAgIC8vIHN0aWxsIHdhbnQgdGhlIGVycm9yIHRvIG9jY3VyXG4gICAgdGhyb3cgZXJyO1xuICB9XG59O1xuXG5jb21tYW5kcy5maW5kRWxlbWVudCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IpIHtcbiAgaWYgKHN0cmF0ZWd5ID09PSBJTUFHRV9TVFJBVEVHWSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRCeUltYWdlKHNlbGVjdG9yLCB7bXVsdGlwbGU6IGZhbHNlfSk7XG4gIH0gZWxzZSBpZiAoc3RyYXRlZ3kgPT09IENVU1RPTV9TVFJBVEVHWSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRCeUN1c3RvbShzZWxlY3RvciwgZmFsc2UpO1xuICB9XG5cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyhzdHJhdGVneSwgc2VsZWN0b3IsIGZhbHNlKTtcbn07XG5cbmNvbW1hbmRzLmZpbmRFbGVtZW50cyA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IpIHtcbiAgaWYgKHN0cmF0ZWd5ID09PSBJTUFHRV9TVFJBVEVHWSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRCeUltYWdlKHNlbGVjdG9yLCB7bXVsdGlwbGU6IHRydWV9KTtcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gQ1VTVE9NX1NUUkFURUdZKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEJ5Q3VzdG9tKHNlbGVjdG9yLCB0cnVlKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3Npbmcoc3RyYXRlZ3ksIHNlbGVjdG9yLCB0cnVlKTtcbn07XG5cbmNvbW1hbmRzLmZpbmRFbGVtZW50RnJvbUVsZW1lbnQgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBlbGVtZW50SWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyhzdHJhdGVneSwgc2VsZWN0b3IsIGZhbHNlLCBlbGVtZW50SWQpO1xufTtcblxuY29tbWFuZHMuZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBlbGVtZW50SWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyhzdHJhdGVneSwgc2VsZWN0b3IsIHRydWUsIGVsZW1lbnRJZCk7XG59O1xuXG4vKipcbiAqIEZpbmQgYW4gZWxlbWVudCB1c2luZyBhIGN1c3RvbSBwbHVnaW4gc3BlY2lmaWVkIGJ5IHRoZSBjdXN0b21GaW5kTW9kdWxlcyBjYXAuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHNlbGVjdG9yIC0gdGhlIHNlbGVjdG9yIHdoaWNoIHRoZSBwbHVnaW4gd2lsbCB1c2UgdG8gZmluZFxuICogZWxlbWVudHNcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gbXVsdGlwbGUgLSB3aGV0aGVyIHdlIHdhbnQgb25lIGVsZW1lbnQgb3IgbXVsdGlwbGVcbiAqXG4gKiBAcmV0dXJucyB7V2ViRWxlbWVudH0gLSBXZWJEcml2ZXIgZWxlbWVudCBvciBsaXN0IG9mIGVsZW1lbnRzXG4gKi9cbmNvbW1hbmRzLmZpbmRCeUN1c3RvbSA9IGFzeW5jIGZ1bmN0aW9uIChzZWxlY3RvciwgbXVsdGlwbGUpIHtcbiAgY29uc3QgcGx1Z2lucyA9IHRoaXMub3B0cy5jdXN0b21GaW5kTW9kdWxlcztcblxuICAvLyBmaXJzdCBlbnN1cmUgdGhlIHVzZXIgaGFzIHJlZ2lzdGVyZWQgb25lIG9yIG1vcmUgZmluZCBwbHVnaW5zXG4gIGlmICghcGx1Z2lucykge1xuICAgIC8vIFRPRE8gdGhpcyBpbmZvIHNob3VsZCBnbyBpbiBkb2NzIGluc3RlYWQ7IHVwZGF0ZSB3aGVuIGRvY3MgZm9yIHRoaXNcbiAgICAvLyBmZWF0dXJlIGV4aXN0XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGaW5kaW5nIGFuIGVsZW1lbnQgdXNpbmcgYSBwbHVnaW4gaXMgY3VycmVudGx5IGFuICcgK1xuICAgICAgJ2luY3ViYXRpbmcgZmVhdHVyZS4gVG8gdXNlIGl0IHlvdSBtdXN0IG1hbnVhbGx5IGluc3RhbGwgb25lIG9yIG1vcmUgJyArXG4gICAgICAncGx1Z2luIG1vZHVsZXMgaW4gYSB3YXkgdGhhdCB0aGV5IGNhbiBiZSByZXF1aXJlZCBieSBBcHBpdW0sIGZvciAnICtcbiAgICAgICdleGFtcGxlIGluc3RhbGxpbmcgdGhlbSBmcm9tIHRoZSBBcHBpdW0gZGlyZWN0b3J5LCBpbnN0YWxsaW5nIHRoZW0gJyArXG4gICAgICAnZ2xvYmFsbHksIG9yIGluc3RhbGxpbmcgdGhlbSBlbHNld2hlcmUgYW5kIHBhc3NpbmcgYW4gYWJzb2x1dGUgcGF0aCBhcyAnICtcbiAgICAgICd0aGUgY2FwYWJpbGl0eS4gVGhlbiBjb25zdHJ1Y3QgYW4gb2JqZWN0IHdoZXJlIHRoZSBrZXkgaXMgdGhlIHNob3J0Y3V0ICcgK1xuICAgICAgJ25hbWUgZm9yIHRoaXMgcGx1Z2luIGFuZCB0aGUgdmFsdWUgaXMgdGhlIG1vZHVsZSBuYW1lIG9yIGFic29sdXRlIHBhdGgsICcgK1xuICAgICAgJ2ZvciBleGFtcGxlOiB7XCJwMVwiOiBcIm15LWZpbmQtcGx1Z2luXCJ9LCBhbmQgcGFzcyB0aGlzIGluIGFzIHRoZSAnICtcbiAgICAgIFwiJ2N1c3RvbUZpbmRNb2R1bGVzJyBjYXBhYmlsaXR5LlwiKTtcbiAgfVxuXG4gIC8vIHRoZW4gZG8gc29tZSBiYXNpYyBjaGVja2luZyBvZiB0aGUgdHlwZSBvZiB0aGUgY2FwYWJpbGl0eVxuICBpZiAoIV8uaXNQbGFpbk9iamVjdChwbHVnaW5zKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgZm9ybWF0IGZvciB0aGUgJ2N1c3RvbUZpbmRNb2R1bGVzJyBjYXBhYmlsaXR5LiBcIiArXG4gICAgICAnSXQgc2hvdWxkIGJlIGFuIG9iamVjdCB3aXRoIGtleXMgY29ycmVzcG9uZGluZyB0byB0aGUgc2hvcnQgbmFtZXMgYW5kICcgK1xuICAgICAgJ3ZhbHVlcyBjb3JyZXNwb25kaW5nIHRvIHRoZSBmdWxsIG5hbWVzIG9mIHRoZSBlbGVtZW50IGZpbmRpbmcgcGx1Z2lucycpO1xuICB9XG5cbiAgLy8gZ2V0IHRoZSBuYW1lIG9mIHRoZSBwYXJ0aWN1bGFyIHBsdWdpbiB1c2VkIGZvciB0aGlzIGludm9jYXRpb24gb2YgZmluZCxcbiAgLy8gYW5kIHNlcGFyYXRlIGl0IGZyb20gdGhlIHNlbGVjdG9yIHdlIHdpbGwgcGFzcyB0byB0aGUgcGx1Z2luXG4gIGxldCBbcGx1Z2luLCByZWFsU2VsZWN0b3JdID0gc2VsZWN0b3Iuc3BsaXQoJzonKTtcblxuICAvLyBpZiB0aGUgdXNlciBkaWRuJ3Qgc3BlY2lmeSBhIHBsdWdpbiBmb3IgdGhpcyBmaW5kIGludm9jYXRpb24sIGFuZCB3ZSBoYWRcbiAgLy8gbXVsdGlwbGUgcGx1Z2lucyByZWdpc3RlcmVkLCB0aGF0J3MgYSBwcm9ibGVtXG4gIGlmIChfLnNpemUocGx1Z2lucykgPiAxICYmICFyZWFsU2VsZWN0b3IpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE11bHRpcGxlIGVsZW1lbnQgZmluZGluZyBwbHVnaW5zIHdlcmUgcmVnaXN0ZXJlZCBgICtcbiAgICAgIGAoJHtfLmtleXMocGx1Z2lucyl9KSwgYnV0IHlvdXIgc2VsZWN0b3IgZGlkIG5vdCBpbmRpY2F0ZSB3aGljaCBwbHVnaW4gYCArXG4gICAgICBgdG8gdXNlLiBFbnN1cmUgeW91IHB1dCB0aGUgc2hvcnQgbmFtZSBvZiB0aGUgcGx1Z2luIGZvbGxvd2VkIGJ5ICc6JyBhcyBgICtcbiAgICAgIGB0aGUgaW5pdGlhbCBwYXJ0IG9mIHRoZSBzZWxlY3RvciBzdHJpbmcuYCk7XG4gIH1cblxuICAvLyBidXQgaWYgdGhleSBkaWQgbm90IHNwZWNpZnkgYSBwbHVnaW4gYW5kIHdlIG9ubHkgaGF2ZSBvbmUgcGx1Z2luLCBqdXN0IHVzZVxuICAvLyB0aGF0IG9uZVxuICBpZiAoXy5zaXplKHBsdWdpbnMpID09PSAxICYmICFyZWFsU2VsZWN0b3IpIHtcbiAgICByZWFsU2VsZWN0b3IgPSBwbHVnaW47XG4gICAgcGx1Z2luID0gXy5rZXlzKHBsdWdpbnMpWzBdO1xuICB9XG5cbiAgaWYgKCFwbHVnaW5zW3BsdWdpbl0pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFNlbGVjdG9yIHNwZWNpZmllZCB1c2Ugb2YgZWxlbWVudCBmaW5kaW5nIHBsdWdpbiBgICtcbiAgICAgIGAnJHtwbHVnaW59JyBidXQgaXQgd2FzIG5vdCByZWdpc3RlcmVkIGluIHRoZSAnY3VzdG9tRmluZE1vZHVsZXMnIGAgK1xuICAgICAgYGNhcGFiaWxpdHkuYCk7XG4gIH1cblxuICBsZXQgZmluZGVyO1xuICB0cnkge1xuICAgIGxvZy5kZWJ1ZyhgRmluZCBwbHVnaW4gJyR7cGx1Z2lufScgcmVxdWVzdGVkOyB3aWxsIGF0dGVtcHQgdG8gdXNlIGl0IGAgK1xuICAgICAgYGZyb20gJyR7cGx1Z2luc1twbHVnaW5dfSdgKTtcbiAgICBmaW5kZXIgPSByZXF1aXJlKHBsdWdpbnNbcGx1Z2luXSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGxvYWQgeW91ciBjdXN0b20gZmluZCBtb2R1bGUgJyR7cGx1Z2lufScuIERpZCBgICtcbiAgICAgIGB5b3UgcHV0IGl0IHNvbWV3aGVyZSBBcHBpdW0gY2FuICdyZXF1aXJlJyBpdD8gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyfWApO1xuICB9XG5cbiAgaWYgKCFmaW5kZXIgfHwgIV8uaXNGdW5jdGlvbihmaW5kZXIuZmluZCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdXIgY3VzdG9tIGZpbmQgbW9kdWxlIGRpZCBub3QgYXBwZWFyIHRvIGJlIGNvbnN0cnVjdGVkICcgK1xuICAgICAgICAnY29ycmVjdGx5LiBJdCBuZWVkcyB0byBleHBvcnQgYW4gb2JqZWN0IHdpdGggYSBgZmluZGAgbWV0aG9kLicpO1xuICB9XG5cbiAgY29uc3QgY3VzdG9tRmluZGVyTG9nID0gbG9nZ2VyLmdldExvZ2dlcihwbHVnaW4pO1xuXG4gIGxldCBlbGVtZW50cztcbiAgY29uc3QgY29uZGl0aW9uID0gYXN5bmMgKCkgPT4ge1xuICAgIC8vIGdldCBhIGxpc3Qgb2YgbWF0Y2hlZCBlbGVtZW50cyBmcm9tIHRoZSBjdXN0b20gZmluZGVyLCB3aGljaCBjYW5cbiAgICAvLyBwb3RlbnRpYWxseSB1c2UgdGhlIGVudGlyZSBzdWl0ZSBvZiBtZXRob2RzIHRoZSBjdXJyZW50IGRyaXZlciBwcm92aWRlcy5cbiAgICAvLyB0aGUgZmluZGVyIHNob3VsZCBhbHdheXMgcmV0dXJuIGEgbGlzdCBvZiBlbGVtZW50cywgYnV0IG1heSB1c2UgdGhlXG4gICAgLy8ga25vd2xlZGdlIG9mIHdoZXRoZXIgd2UgYXJlIGxvb2tpbmcgZm9yIG9uZSBvciBtYW55IHRvIHBlcmZvcm0gaW50ZXJuYWxcbiAgICAvLyBvcHRpbWl6YXRpb25zXG4gICAgZWxlbWVudHMgPSBhd2FpdCBmaW5kZXIuZmluZCh0aGlzLCBjdXN0b21GaW5kZXJMb2csIHJlYWxTZWxlY3RvciwgbXVsdGlwbGUpO1xuXG4gICAgLy8gaWYgd2UncmUgbG9va2luZyBmb3IgbXVsdGlwbGUgZWxlbWVudHMsIG9yIGlmIHdlJ3JlIGxvb2tpbmcgZm9yIG9ubHlcbiAgICAvLyBvbmUgYW5kIGZvdW5kIGl0LCB3ZSdyZSBkb25lXG4gICAgaWYgKCFfLmlzRW1wdHkoZWxlbWVudHMpIHx8IG11bHRpcGxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBvdGhlcndpc2Ugd2Ugc2hvdWxkIHJldHJ5LCBzbyByZXR1cm4gZmFsc2UgdG8gdHJpZ2dlciB0aGUgcmV0cnkgbG9vcFxuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcblxuICB0cnkge1xuICAgIC8vIG1ha2Ugc3VyZSB3ZSByZXNwZWN0IGltcGxpY2l0IHdhaXRcbiAgICBhd2FpdCB0aGlzLmltcGxpY2l0V2FpdEZvckNvbmRpdGlvbihjb25kaXRpb24pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLm1lc3NhZ2UubWF0Y2goL0NvbmRpdGlvbiB1bm1ldC8pKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cblxuICByZXR1cm4gbXVsdGlwbGUgPyBlbGVtZW50cyA6IGVsZW1lbnRzWzBdO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBGaW5kQnlJbWFnZU9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW3Nob3VsZENoZWNrU3RhbGVuZXNzPWZhbHNlXSAtIHdoZXRoZXIgdGhpcyBjYWxsIHRvIGZpbmQgYW5cbiAqIGltYWdlIGlzIG1lcmVseSB0byBjaGVjayBzdGFsZW5lc3MuIElmIHNvIHdlIGNhbiBieXBhc3MgYSBsb3Qgb2YgbG9naWNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW211bHRpcGxlPWZhbHNlXSAtIFdoZXRoZXIgd2UgYXJlIGZpbmRpbmcgb25lIGVsZW1lbnQgb3JcbiAqIG11bHRpcGxlXG4gKi9cblxuLyoqXG4gKiBGaW5kIGEgc2NyZWVuIHJlY3QgcmVwcmVzZW50ZWQgYnkgYW4gSW1hZ2VFbGVtZW50IGNvcnJlc3BvbmRpbmcgdG8gYW4gaW1hZ2VcbiAqIHRlbXBsYXRlIHNlbnQgaW4gYnkgdGhlIGNsaWVudFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBiNjRUZW1wbGF0ZSAtIGJhc2U2NC1lbmNvZGVkIGltYWdlIHVzZWQgYXMgYSB0ZW1wbGF0ZSB0byBiZVxuICogbWF0Y2hlZCBpbiB0aGUgc2NyZWVuc2hvdFxuICogQHBhcmFtIHtGaW5kQnlJbWFnZU9wdGlvbnN9IC0gYWRkaXRpb25hbCBvcHRpb25zXG4gKlxuICogQHJldHVybnMge1dlYkVsZW1lbnR9IC0gV2ViRHJpdmVyIGVsZW1lbnQgd2l0aCBhIHNwZWNpYWwgaWQgcHJlZml4XG4gKi9cbmhlbHBlcnMuZmluZEJ5SW1hZ2UgPSBhc3luYyBmdW5jdGlvbiAoYjY0VGVtcGxhdGUsIHtcbiAgc2hvdWxkQ2hlY2tTdGFsZW5lc3MgPSBmYWxzZSxcbiAgbXVsdGlwbGUgPSBmYWxzZSxcbn0pIHtcbiAgY29uc3Qge1xuICAgIGltYWdlTWF0Y2hUaHJlc2hvbGQ6IHRocmVzaG9sZCxcbiAgICBmaXhJbWFnZVRlbXBsYXRlU2l6ZSxcbiAgICBmaXhJbWFnZVRlbXBsYXRlU2NhbGVcbiAgfSA9IHRoaXMuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKTtcblxuICBsb2cuaW5mbyhgRmluZGluZyBpbWFnZSBlbGVtZW50IHdpdGggbWF0Y2ggdGhyZXNob2xkICR7dGhyZXNob2xkfWApO1xuICBpZiAoIXRoaXMuZ2V0V2luZG93U2l6ZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlRoaXMgZHJpdmVyIGRvZXMgbm90IHN1cHBvcnQgdGhlIHJlcXVpcmVkICdnZXRXaW5kb3dTaXplJyBjb21tYW5kXCIpO1xuICB9XG4gIGNvbnN0IHt3aWR0aDogc2NyZWVuV2lkdGgsIGhlaWdodDogc2NyZWVuSGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuXG4gIC8vIHNvbWVvbmUgbWlnaHQgaGF2ZSBzZW50IGluIGEgdGVtcGxhdGUgdGhhdCdzIGxhcmdlciB0aGFuIHRoZSBzY3JlZW5cbiAgLy8gZGltZW5zaW9ucy4gSWYgc28gbGV0J3MgY2hlY2sgYW5kIGN1dCBpdCBkb3duIHRvIHNpemUgc2luY2UgdGhlIGFsZ29yaXRobVxuICAvLyB3aWxsIG5vdCB3b3JrIHVubGVzcyB3ZSBkby4gQnV0IGJlY2F1c2UgaXQgcmVxdWlyZXMgc29tZSBwb3RlbnRpYWxseVxuICAvLyBleHBlbnNpdmUgY29tbWFuZHMsIG9ubHkgZG8gdGhpcyBpZiB0aGUgdXNlciBoYXMgcmVxdWVzdGVkIGl0IGluIHNldHRpbmdzLlxuICBpZiAoZml4SW1hZ2VUZW1wbGF0ZVNpemUpIHtcbiAgICBiNjRUZW1wbGF0ZSA9IGF3YWl0IHRoaXMuZW5zdXJlVGVtcGxhdGVTaXplKGI2NFRlbXBsYXRlLCBzY3JlZW5XaWR0aCxcbiAgICAgIHNjcmVlbkhlaWdodCk7XG4gIH1cblxuICBsZXQgcmVjdCA9IG51bGw7XG4gIGNvbnN0IGNvbmRpdGlvbiA9IGFzeW5jICgpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qge2I2NFNjcmVlbnNob3QsIHNjYWxlfSA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdEZvckltYWdlRmluZChzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KTtcblxuICAgICAgaWYgKGZpeEltYWdlVGVtcGxhdGVTY2FsZSkge1xuICAgICAgICBiNjRUZW1wbGF0ZSA9IGF3YWl0IHRoaXMuZml4SW1hZ2VUZW1wbGF0ZVNjYWxlKGI2NFRlbXBsYXRlLCBzY2FsZSk7XG4gICAgICB9XG5cbiAgICAgIHJlY3QgPSAoYXdhaXQgdGhpcy5jb21wYXJlSW1hZ2VzKE1BVENIX1RFTVBMQVRFX01PREUsIGI2NFNjcmVlbnNob3QsXG4gICAgICAgIGI2NFRlbXBsYXRlLCB7dGhyZXNob2xkfSkpLnJlY3Q7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGlmIGNvbXBhcmVJbWFnZXMgZmFpbHMsIHdlJ2xsIGdldCBhIHNwZWNpZmljIGVycm9yLCBidXQgd2Ugc2hvdWxkXG4gICAgICAvLyByZXRyeSwgc28gdHJhcCB0aGF0IGFuZCBqdXN0IHJldHVybiBmYWxzZSB0byB0cmlnZ2VyIHRoZSBuZXh0IHJvdW5kIG9mXG4gICAgICAvLyBpbXBsaWNpdGx5IHdhaXRpbmcuIEZvciBvdGhlciBlcnJvcnMsIHRocm93IHRoZW0gdG8gZ2V0IG91dCBvZiB0aGVcbiAgICAgIC8vIGltcGxpY2l0IHdhaXQgbG9vcFxuICAgICAgaWYgKGVyci5tZXNzYWdlLm1hdGNoKC9DYW5ub3QgZmluZCBhbnkgb2NjdXJyZW5jZXMvKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9O1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24oY29uZGl0aW9uKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gdGhpcyBgaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uYCBtZXRob2Qgd2lsbCB0aHJvdyBhICdDb25kaXRpb24gdW5tZXQnXG4gICAgLy8gZXJyb3IgaWYgYW4gZWxlbWVudCBpcyBub3QgZm91bmQgZXZlbnR1YWxseS4gSW4gdGhhdCBjYXNlLCB3ZSB3aWxsXG4gICAgLy8gaGFuZGxlIHRoZSBlbGVtZW50IG5vdCBmb3VuZCByZXNwb25zZSBiZWxvdy4gSW4gdGhlIGNhc2Ugd2hlcmUgZ2V0IHNvbWVcbiAgICAvLyBfb3RoZXJfIGtpbmQgb2YgZXJyb3IsIGl0IG1lYW5zIHNvbWV0aGluZyBibGV3IHVwIHRvdGFsbHkgYXBhcnQgZnJvbSB0aGVcbiAgICAvLyBpbXBsaWNpdCB3YWl0IHRpbWVvdXQuIFdlIHNob3VsZCBub3QgbWFzayB0aGF0IGVycm9yIGFuZCBpbnN0ZWFkIHRocm93XG4gICAgLy8gaXQgc3RyYWlnaHRhd2F5XG4gICAgaWYgKCFlcnIubWVzc2FnZS5tYXRjaCgvQ29uZGl0aW9uIHVubWV0LykpIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cblxuICBpZiAoIXJlY3QpIHtcbiAgICBpZiAobXVsdGlwbGUpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgfVxuXG4gIGxvZy5pbmZvKGBJbWFnZSB0ZW1wbGF0ZSBtYXRjaGVkOiAke0pTT04uc3RyaW5naWZ5KHJlY3QpfWApO1xuICBjb25zdCBpbWdFbCA9IG5ldyBJbWFnZUVsZW1lbnQoYjY0VGVtcGxhdGUsIHJlY3QpO1xuXG4gIC8vIGlmIHdlJ3JlIGp1c3QgY2hlY2tpbmcgc3RhbGVuZXNzLCByZXR1cm4gc3RyYWlnaHRhd2F5IHNvIHdlIGRvbid0IGFkZFxuICAvLyBhIG5ldyBlbGVtZW50IHRvIHRoZSBjYWNoZS4gc2hvdWxkQ2hlY2tTdGFsZW5lc3MgZG9lcyBub3Qgc3VwcG9ydCBtdWx0aXBsZVxuICAvLyBlbGVtZW50cywgc2luY2UgaXQgaXMgYSBwdXJlbHkgaW50ZXJuYWwgbWVjaGFuaXNtXG4gIGlmIChzaG91bGRDaGVja1N0YWxlbmVzcykge1xuICAgIHJldHVybiBpbWdFbDtcbiAgfVxuXG4gIHRoaXMuX2ltZ0VsQ2FjaGUuc2V0KGltZ0VsLmlkLCBpbWdFbCk7XG4gIGNvbnN0IHByb3RvS2V5ID0gdGhpcy5pc1czQ1Byb3RvY29sKCkgPyBXM0NfRUxFTUVOVF9LRVkgOiBNSlNPTldQX0VMRU1FTlRfS0VZO1xuICBjb25zdCBwcm90b2NvbEVsID0gaW1nRWwuYXNFbGVtZW50KHByb3RvS2V5KTtcbiAgcmV0dXJuIG11bHRpcGxlID8gW3Byb3RvY29sRWxdIDogcHJvdG9jb2xFbDtcbn07XG5cbi8qKlxuICogRW5zdXJlIHRoYXQgdGhlIGltYWdlIHRlbXBsYXRlIHNlbnQgaW4gZm9yIGEgZmluZCBpcyBvZiBhIHN1aXRhYmxlIHNpemVcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYjY0VGVtcGxhdGUgLSBiYXNlNjQtZW5jb2RlZCBpbWFnZVxuICogQHBhcmFtIHtpbnR9IHNjcmVlbldpZHRoIC0gd2lkdGggb2Ygc2NyZWVuXG4gKiBAcGFyYW0ge2ludH0gc2NyZWVuSGVpZ2h0IC0gaGVpZ2h0IG9mIHNjcmVlblxuICpcbiAqIEByZXR1cm5zIHtzdHJpbmd9IGJhc2U2NC1lbmNvZGVkIGltYWdlLCBwb3RlbnRpYWxseSByZXNpemVkXG4gKi9cbmhlbHBlcnMuZW5zdXJlVGVtcGxhdGVTaXplID0gYXN5bmMgZnVuY3Rpb24gKGI2NFRlbXBsYXRlLCBzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KSB7XG4gIGxldCBpbWdPYmogPSBhd2FpdCBpbWFnZVV0aWwuZ2V0SmltcEltYWdlKGI2NFRlbXBsYXRlKTtcbiAgbGV0IHt3aWR0aDogdHBsV2lkdGgsIGhlaWdodDogdHBsSGVpZ2h0fSA9IGltZ09iai5iaXRtYXA7XG5cbiAgbG9nLmluZm8oYFRlbXBsYXRlIGltYWdlIGlzICR7dHBsV2lkdGh9eCR7dHBsSGVpZ2h0fS4gU2NyZWVuIHNpemUgaXMgJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9YCk7XG4gIC8vIGlmIHRoZSB0ZW1wbGF0ZSBmaXRzIGluc2lkZSB0aGUgc2NyZWVuIGRpbWVuc2lvbnMsIHdlJ3JlIGdvb2RcbiAgaWYgKHRwbFdpZHRoIDw9IHNjcmVlbldpZHRoICYmIHRwbEhlaWdodCA8PSBzY3JlZW5IZWlnaHQpIHtcbiAgICByZXR1cm4gYjY0VGVtcGxhdGU7XG4gIH1cblxuICBsb2cuaW5mbyhgU2NhbGluZyB0ZW1wbGF0ZSBpbWFnZSBmcm9tICR7dHBsV2lkdGh9eCR7dHBsSGVpZ2h0fSB0byBtYXRjaCBgICtcbiAgICAgICAgICAgYHNjcmVlbiBhdCAke3NjcmVlbldpZHRofXgke3NjcmVlbkhlaWdodH1gKTtcbiAgLy8gb3RoZXJ3aXNlLCBzY2FsZSBpdCB0byBmaXQgaW5zaWRlIHRoZSBzY3JlZW4gZGltZW5zaW9uc1xuICBpbWdPYmogPSBpbWdPYmouc2NhbGVUb0ZpdChzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KTtcbiAgcmV0dXJuIChhd2FpdCBpbWdPYmouZ2V0QnVmZmVyKGltYWdlVXRpbC5NSU1FX1BORykpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU2NyZWVuc2hvdFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGI2NFNjcmVlbnNob3QgLSBiYXNlNjQgYmFzZWQgc2NyZWVuc2hvdCBzdHJpbmdcbiAqL1xuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTY3JlZW5zaG90U2NhbGVcbiAqIEBwcm9wZXJ0eSB7ZmxvYXR9IHhTY2FsZSAtIFNjYWxlIHJhdGlvIGZvciB3aWR0aFxuICogQHByb3BlcnR5IHtmbG9hdH0geVNjYWxlIC0gU2NhbGUgcmF0aW8gZm9yIGhlaWdodFxuICovXG4vKipcbiAqIEdldCB0aGUgc2NyZWVuc2hvdCBpbWFnZSB0aGF0IHdpbGwgYmUgdXNlZCBmb3IgZmluZCBieSBlbGVtZW50LCBwb3RlbnRpYWxseVxuICogYWx0ZXJpbmcgaXQgaW4gdmFyaW91cyB3YXlzIGJhc2VkIG9uIHVzZXItcmVxdWVzdGVkIHNldHRpbmdzXG4gKlxuICogQHBhcmFtIHtpbnR9IHNjcmVlbldpZHRoIC0gd2lkdGggb2Ygc2NyZWVuXG4gKiBAcGFyYW0ge2ludH0gc2NyZWVuSGVpZ2h0IC0gaGVpZ2h0IG9mIHNjcmVlblxuICpcbiAqIEByZXR1cm5zIHtTY3JlZW5zaG90LCA/U2NyZWVuc2hvdFNjYWxlfSBiYXNlNjQtZW5jb2RlZCBzY3JlZW5zaG90IGFuZCBTY3JlZW5zaG90U2NhbGVcbiAqL1xuaGVscGVycy5nZXRTY3JlZW5zaG90Rm9ySW1hZ2VGaW5kID0gYXN5bmMgZnVuY3Rpb24gKHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQpIHtcbiAgaWYgKCF0aGlzLmdldFNjcmVlbnNob3QpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGlzIGRyaXZlciBkb2VzIG5vdCBzdXBwb3J0IHRoZSByZXF1aXJlZCAnZ2V0U2NyZWVuc2hvdCcgY29tbWFuZFwiKTtcbiAgfVxuXG4gIGxldCBiNjRTY3JlZW5zaG90ID0gYXdhaXQgdGhpcy5nZXRTY3JlZW5zaG90KCk7XG5cbiAgLy8gaWYgdGhlIHVzZXIgaGFzIHJlcXVlc3RlZCBub3QgdG8gY29ycmVjdCBmb3IgYXNwZWN0IG9yIHNpemUgZGlmZmVyZW5jZXNcbiAgLy8gYmV0d2VlbiB0aGUgc2NyZWVuc2hvdCBhbmQgdGhlIHNjcmVlbiwganVzdCByZXR1cm4gdGhlIHNjcmVlbnNob3Qgbm93XG4gIGlmICghdGhpcy5zZXR0aW5ncy5nZXRTZXR0aW5ncygpLmZpeEltYWdlRmluZFNjcmVlbnNob3REaW1zKSB7XG4gICAgbG9nLmluZm8oYE5vdCB2ZXJpZnlpbmcgc2NyZWVuc2hvdCBkaW1lbnNpb25zIG1hdGNoIHNjcmVlbmApO1xuICAgIHJldHVybiB7YjY0U2NyZWVuc2hvdH07XG4gIH1cblxuICAvLyBvdGhlcndpc2UsIGRvIHNvbWUgdmVyaWZpY2F0aW9uIG9uIHRoZSBzY3JlZW5zaG90IHRvIG1ha2Ugc3VyZSBpdCBtYXRjaGVzXG4gIC8vIHRoZSBzY3JlZW4gc2l6ZSBhbmQgYXNwZWN0IHJhdGlvXG4gIGxvZy5pbmZvKCdWZXJpZnlpbmcgc2NyZWVuc2hvdCBzaXplIGFuZCBhc3BlY3QgcmF0aW8nKTtcblxuICBsZXQgaW1nT2JqID0gYXdhaXQgaW1hZ2VVdGlsLmdldEppbXBJbWFnZShiNjRTY3JlZW5zaG90KTtcbiAgbGV0IHt3aWR0aDogc2hvdFdpZHRoLCBoZWlnaHQ6IHNob3RIZWlnaHR9ID0gaW1nT2JqLmJpdG1hcDtcblxuICBpZiAoc2NyZWVuV2lkdGggPT09IHNob3RXaWR0aCAmJiBzY3JlZW5IZWlnaHQgPT09IHNob3RIZWlnaHQpIHtcbiAgICAvLyB0aGUgaGVpZ2h0IGFuZCB3aWR0aCBvZiB0aGUgc2NyZWVuc2hvdCBhbmQgdGhlIGRldmljZSBzY3JlZW4gbWF0Y2gsIHdoaWNoXG4gICAgLy8gbWVhbnMgd2Ugc2hvdWxkIGJlIHNhZmUgd2hlbiBkb2luZyB0ZW1wbGF0ZSBtYXRjaGVzXG4gICAgbG9nLmluZm8oJ1NjcmVlbnNob3Qgc2l6ZSBtYXRjaGVkIHNjcmVlbiBzaXplJyk7XG4gICAgcmV0dXJuIHtiNjRTY3JlZW5zaG90fTtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSwgaWYgdGhleSBkb24ndCBtYXRjaCwgaXQgY291bGQgc3BlbGwgcHJvYmxlbXMgZm9yIHRoZSBhY2N1cmFjeVxuICAvLyBvZiBjb29yZGluYXRlcyByZXR1cm5lZCBieSB0aGUgaW1hZ2UgbWF0Y2ggYWxnb3JpdGhtLCBzaW5jZSB3ZSBtYXRjaCBiYXNlZFxuICAvLyBvbiB0aGUgc2NyZWVuc2hvdCBjb29yZGluYXRlcyBub3QgdGhlIGRldmljZSBjb29yZGluYXRlcyB0aGVtc2VsdmVzLiBUaGVyZVxuICAvLyBhcmUgdHdvIHBvdGVudGlhbCB0eXBlcyBvZiBtaXNtYXRjaDogYXNwZWN0IHJhdGlvIG1pc21hdGNoIGFuZCBzY2FsZVxuICAvLyBtaXNtYXRjaC5cblxuICAvLyBSZXNpemUgYmFzZWQgb24gdGhlIHNjcmVlbiBkaW1lbnNpb25zIG9ubHkgaWYgYm90aCB3aWR0aCBhbmQgaGVpZ2h0IGFyZSBtaXNtYXRjaGVkXG4gIC8vIHNpbmNlIGV4Y2VwdCBmb3IgdGhhdCwgaXQgbWlnaHQgYmUgYSBzaXR1YXRpb24gd2hpY2ggaXMgZGlmZmVyZW50IHdpbmRvdyByZWN0IGFuZFxuICAvLyBzY3JlZW5zaG90IHNpemUgbGlrZSBgQGRyaXZlci53aW5kb3dfcmVjdCAjPT54PTAsIHk9MCwgd2lkdGg9MTA4MCwgaGVpZ2h0PTE3OTRgIGFuZFxuICAvLyBgXCJkZXZpY2VTY3JlZW5TaXplXCI9PlwiMTA4MHgxOTIwXCJgXG4gIGxldCBzY2FsZTtcbiAgaWYgKHNjcmVlbldpZHRoICE9PSBzaG90V2lkdGggJiYgc2NyZWVuSGVpZ2h0ICE9PSBzaG90SGVpZ2h0KSB7XG4gICAgbG9nLmluZm8oYFNjYWxpbmcgc2NyZWVuc2hvdCBmcm9tICR7c2hvdFdpZHRofXgke3Nob3RIZWlnaHR9IHRvIG1hdGNoIGAgK1xuICAgICAgICAgICAgIGBzY3JlZW4gYXQgJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9YCk7XG4gICAgaW1nT2JqID0gaW1nT2JqLnJlc2l6ZShzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KTtcblxuICAgIHNjYWxlID0ge3hTY2FsZTogKDEuMCAqIHNjcmVlbldpZHRoKSAvIHNob3RXaWR0aCwgeVNjYWxlOiAoMS4wICogc2NyZWVuSGVpZ2h0KSAvIHNob3RIZWlnaHR9O1xuICB9XG5cbiAgYjY0U2NyZWVuc2hvdCA9IChhd2FpdCBpbWdPYmouZ2V0QnVmZmVyKGltYWdlVXRpbC5NSU1FX1BORykpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgcmV0dXJuIHtiNjRTY3JlZW5zaG90LCBzY2FsZX07XG59O1xuXG4vKipcbiAqIEdldCBhIGltYWdlIHRoYXQgd2lsbCBiZSB1c2VkIGZvciB0ZW1wbGF0ZSBtYWNoaW5nLlxuICogUmV0dXJucyBzY2FsZWQgaW1hZ2UgaWYgc2NhbGUgcmF0aW8gaXMgcHJvdmlkZWQuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGI2NFRlbXBsYXRlIC0gYmFzZTY0LWVuY29kZWQgaW1hZ2UgdXNlZCBhcyBhIHRlbXBsYXRlIHRvIGJlXG4gKiBtYXRjaGVkIGluIHRoZSBzY3JlZW5zaG90XG4gKiBAcGFyYW0ge1NjcmVlbnNob3RTY2FsZX0gc2NhbGUgLSBzY2FsZSBvZiBzY3JlZW4uIERlZmF1bHQgdG8gYHt9YFxuICpcbiAqIEByZXR1cm5zIHtzdHJpbmd9IGJhc2U2NC1lbmNvZGVkIHNjYWxlZCB0ZW1wbGF0ZSBzY3JlZW5zaG90XG4gKi9cbmhlbHBlcnMuZml4SW1hZ2VUZW1wbGF0ZVNjYWxlID0gYXN5bmMgZnVuY3Rpb24gKGI2NFRlbXBsYXRlLCBzY2FsZSA9IHt9KSB7XG4gIGlmICghc2NhbGUpIHtcbiAgICByZXR1cm4gYjY0VGVtcGxhdGU7XG4gIH1cblxuICBjb25zdCB7eFNjYWxlLCB5U2NhbGV9ID0gc2NhbGU7XG4gIGlmICgheFNjYWxlIHx8ICF5U2NhbGUpIHtcbiAgICByZXR1cm4gYjY0VGVtcGxhdGU7XG4gIH1cblxuICBsZXQgaW1nVGVtcE9iaiA9IGF3YWl0IGltYWdlVXRpbC5nZXRKaW1wSW1hZ2UoYjY0VGVtcGxhdGUpO1xuICBsZXQge3dpZHRoOiBiYXNlVGVtcFdpZHRoLCBoZWlnaHQ6IGJhc2VUZW1wSGVpZ2h9ID0gaW1nVGVtcE9iai5iaXRtYXA7XG5cbiAgY29uc3Qgc2NhbGVkV2lkdGggPSBiYXNlVGVtcFdpZHRoICogeFNjYWxlO1xuICBjb25zdCBzY2FsZWRIZWlnaHQgPSBiYXNlVGVtcEhlaWdoICogeVNjYWxlO1xuICBsb2cuaW5mbyhgU2NhbGluZyB0ZW1wbGF0ZSBpbWFnZSBmcm9tICR7YmFzZVRlbXBXaWR0aH14JHtiYXNlVGVtcEhlaWdofWAgK1xuICAgICAgICAgICAgYCB0byAke3NjYWxlZFdpZHRofXgke3NjYWxlZEhlaWdodH1gKTtcbiAgbG9nLmluZm8oYFRoZSByYXRpbyBpcyAke3hTY2FsZX0gYW5kICR7eVNjYWxlfWApO1xuICBpbWdUZW1wT2JqID0gYXdhaXQgaW1nVGVtcE9iai5yZXNpemUoc2NhbGVkV2lkdGgsIHNjYWxlZEhlaWdodCk7XG4gIHJldHVybiAoYXdhaXQgaW1nVGVtcE9iai5nZXRCdWZmZXIoaW1hZ2VVdGlsLk1JTUVfUE5HKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycywgSU1BR0VfU1RSQVRFR1ksIENVU1RPTV9TVFJBVEVHWSB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvY29tbWFuZHMvZmluZC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
