"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

var _protocol = require("../../protocol");

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _capabilities = require("../capabilities");

let commands = {};

commands.createSession = async function (jsonwpDesiredCapabilities, jsonwpRequiredCaps, w3cCapabilities) {
  if (this.sessionId !== null) {
    throw new _protocol.errors.SessionNotCreatedError('Cannot create a new session ' + 'while one is in progress');
  }

  _logger.default.debug();

  let caps;

  if (w3cCapabilities) {
    this.setProtocolW3C();

    if (jsonwpDesiredCapabilities) {
      _logger.default.debug(`W3C capabilities ${_lodash.default.truncate(JSON.stringify(w3cCapabilities))} and MJSONWP desired capabilities ${_lodash.default.truncate(JSON.stringify(jsonwpDesiredCapabilities))} were provided`);
    }

    if (jsonwpDesiredCapabilities && !_lodash.default.isPlainObject(w3cCapabilities)) {
      if (!_lodash.default.isEmpty(w3cCapabilities)) {
        _logger.default.warn(`Expected W3C "capabilities" to be a JSON Object but was provided with: ${JSON.stringify(w3cCapabilities)}`);
      }

      _logger.default.warn(`Falling back to MJSONWP desired capabilities`);

      this.setProtocolMJSONWP();
      caps = jsonwpDesiredCapabilities;
    } else {
      _logger.default.debug(`Creating session with W3C capabilities: ${_lodash.default.truncate(JSON.stringify(w3cCapabilities))}`);

      caps = (0, _capabilities.processCapabilities)(w3cCapabilities, this.desiredCapConstraints, this.shouldValidateCaps);
    }
  } else {
    this.setProtocolMJSONWP();

    _logger.default.debug(`Creating session with MJSONWP desired capabilities: ${_lodash.default.truncate(JSON.stringify(jsonwpDesiredCapabilities))}`);

    caps = jsonwpDesiredCapabilities || {};
  }

  caps = fixCaps(caps, this.desiredCapConstraints);
  this.validateDesiredCaps(caps);
  this.sessionId = _uuidJs.default.create().hex;
  this.caps = caps;
  this.opts = _lodash.default.cloneDeep(this.initialOpts);
  Object.assign(this.opts, this.caps);

  if (this.opts.noReset && this.opts.fullReset) {
    throw new Error("The 'noReset' and 'fullReset' capabilities are mutually " + 'exclusive and should not both be set to true. You ' + "probably meant to just use 'fullReset' on its own");
  }

  if (this.opts.noReset === true) {
    this.opts.fullReset = false;
  }

  if (this.opts.fullReset === true) {
    this.opts.noReset = false;
  }

  this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
  this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;

  if (typeof this.opts.app === 'string' && this.opts.app.trim() === '') {
    this.opts.app = null;
  }

  if (!_lodash.default.isUndefined(this.caps.newCommandTimeout)) {
    this.newCommandTimeoutMs = this.caps.newCommandTimeout * 1000;
  }

  this.resetOnUnexpectedShutdown();

  _logger.default.info(`Session created with session id: ${this.sessionId}`);

  return [this.sessionId, caps];
};

commands.getSessions = async function () {
  let ret = [];

  if (this.sessionId) {
    ret.push({
      id: this.sessionId,
      capabilities: this.caps
    });
  }

  return ret;
};

commands.getSession = async function () {
  if (this.caps.eventTimings) {
    return Object.assign({}, this.caps, {
      events: this.eventHistory
    });
  }

  return this.caps;
};

commands.deleteSession = async function () {
  this.clearNewCommandTimeout();
  this.sessionId = null;
};

function fixCaps(originalCaps, desiredCapConstraints = {}) {
  let caps = _lodash.default.clone(originalCaps);

  let booleanCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isBoolean === true));

  for (let cap of booleanCaps) {
    let value = originalCaps[cap];

    if (_lodash.default.isString(value)) {
      value = value.toLowerCase();

      if (value === 'true' || value === 'false') {
        _logger.default.warn(`Capability '${cap}' changed from string to boolean. This may cause unexpected behavior`);

        caps[cap] = value === 'true';
      }
    }
  }

  let intCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isNumber === true));

  for (let cap of intCaps) {
    let value = originalCaps[cap];

    if (_lodash.default.isString(value) && !isNaN(value)) {
      value = value.trim();
      let newValue = parseInt(value, 10);

      if (value !== `${newValue}`) {
        newValue = parseFloat(value);
      }

      _logger.default.warn(`Capability '${cap}' changed from string ('${value}') to integer (${newValue}). This may cause unexpected behavior`);

      caps[cap] = newValue;
    }
  }

  return caps;
}

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3Nlc3Npb24uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJjcmVhdGVTZXNzaW9uIiwianNvbndwRGVzaXJlZENhcGFiaWxpdGllcyIsImpzb253cFJlcXVpcmVkQ2FwcyIsInczY0NhcGFiaWxpdGllcyIsInNlc3Npb25JZCIsImVycm9ycyIsIlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IiLCJsb2ciLCJkZWJ1ZyIsImNhcHMiLCJzZXRQcm90b2NvbFczQyIsIl8iLCJ0cnVuY2F0ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJpc1BsYWluT2JqZWN0IiwiaXNFbXB0eSIsIndhcm4iLCJzZXRQcm90b2NvbE1KU09OV1AiLCJkZXNpcmVkQ2FwQ29uc3RyYWludHMiLCJzaG91bGRWYWxpZGF0ZUNhcHMiLCJmaXhDYXBzIiwidmFsaWRhdGVEZXNpcmVkQ2FwcyIsIlVVSUQiLCJjcmVhdGUiLCJoZXgiLCJvcHRzIiwiY2xvbmVEZWVwIiwiaW5pdGlhbE9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJub1Jlc2V0IiwiZnVsbFJlc2V0IiwiRXJyb3IiLCJmYXN0UmVzZXQiLCJza2lwVW5pbnN0YWxsIiwiYXBwIiwidHJpbSIsImlzVW5kZWZpbmVkIiwibmV3Q29tbWFuZFRpbWVvdXQiLCJuZXdDb21tYW5kVGltZW91dE1zIiwicmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93biIsImluZm8iLCJnZXRTZXNzaW9ucyIsInJldCIsInB1c2giLCJpZCIsImNhcGFiaWxpdGllcyIsImdldFNlc3Npb24iLCJldmVudFRpbWluZ3MiLCJldmVudHMiLCJldmVudEhpc3RvcnkiLCJkZWxldGVTZXNzaW9uIiwiY2xlYXJOZXdDb21tYW5kVGltZW91dCIsIm9yaWdpbmFsQ2FwcyIsImNsb25lIiwiYm9vbGVhbkNhcHMiLCJrZXlzIiwicGlja0J5IiwiayIsImlzQm9vbGVhbiIsImNhcCIsInZhbHVlIiwiaXNTdHJpbmciLCJ0b0xvd2VyQ2FzZSIsImlu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QUFHdEQsZ0JBQUU4QyxJQUFGLENBQU85QyxnQkFBRStDLE1BQUYsQ0FBU3ZDLHFCQUFULEVBQWlDd0MsQ0FBRCxJQUFPQSxDQUFDLENBQUNPLFFBQUYsS0FBZSxJQUF0RCxDQUFQLENBQWQ7O0FBQ0EsT0FBSyxJQUFJTCxHQUFULElBQWdCSSxPQUFoQixFQUF5QjtBQUN2QixRQUFJSCxLQUFLLEdBQUdSLFlBQVksQ0FBQ08sR0FBRCxDQUF4Qjs7QUFDQSxRQUFJbEQsZ0JBQUVvRCxRQUFGLENBQVdELEtBQVgsS0FBcUIsQ0FBQ0ssS0FBSyxDQUFDTCxLQUFELENBQS9CLEVBQXdDO0FBQ3RDQSxNQUFBQSxLQUFLLEdBQUdBLEtBQUssQ0FBQ3pCLElBQU4sRUFBUjtBQUNBLFVBQUkrQixRQUFRLEdBQUdDLFFBQVEsQ0FBQ1AsS0FBRCxFQUFRLEVBQVIsQ0FBdkI7O0FBQ0EsVUFBSUEsS0FBSyxLQUFNLEdBQUVNLFFBQVMsRUFBMUIsRUFBNkI7QUFDM0JBLFFBQUFBLFFBQVEsR0FBR0UsVUFBVSxDQUFDUixLQUFELENBQXJCO0FBQ0Q7O0FBQ0R2RCxzQkFBSVUsSUFBSixDQUFVLGVBQWM0QyxHQUFJLDJCQUEwQkMsS0FBTSxrQkFBaUJNLFFBQVMsdUNBQXRGOztBQUNBM0QsTUFBQUEsSUFBSSxDQUFDb0QsR0FBRCxDQUFKLEdBQVlPLFFBQVo7QUFDRDtBQUNGOztBQUVELFNBQU8zRCxJQUFQO0FBQ0Q7O2VBRWNWLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnLi4vLi4vcHJvdG9jb2wnO1xuaW1wb3J0IFVVSUQgZnJvbSAndXVpZC1qcyc7XG5pbXBvcnQgeyBwcm9jZXNzQ2FwYWJpbGl0aWVzIH0gZnJvbSAnLi4vY2FwYWJpbGl0aWVzJztcblxubGV0IGNvbW1hbmRzID0ge307XG5cbmNvbW1hbmRzLmNyZWF0ZVNlc3Npb24gPSBhc3luYyBmdW5jdGlvbiAoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcywganNvbndwUmVxdWlyZWRDYXBzLCB3M2NDYXBhYmlsaXRpZXMpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIGlmICh0aGlzLnNlc3Npb25JZCAhPT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuU2Vzc2lvbk5vdENyZWF0ZWRFcnJvcignQ2Fubm90IGNyZWF0ZSBhIG5ldyBzZXNzaW9uICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnd2hpbGUgb25lIGlzIGluIHByb2dyZXNzJyk7XG4gIH1cblxuICBsb2cuZGVidWcoKTtcblxuICAvLyBEZXRlcm1pbmUgd2VhdGhlciB3ZSBzaG91bGQgdXNlIGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMgb3IgdzNjQ2FwYWJpbGl0aWVzIHRvIGdldCBjYXBzIGZyb21cbiAgbGV0IGNhcHM7XG4gIGlmICh3M2NDYXBhYmlsaXRpZXMpIHtcbiAgICB0aGlzLnNldFByb3RvY29sVzNDKCk7XG4gICAgaWYgKGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVzNDIGNhcGFiaWxpdGllcyAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkodzNjQ2FwYWJpbGl0aWVzKSl9IGFuZCBNSlNPTldQIGRlc2lyZWQgY2FwYWJpbGl0aWVzICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzKSl9IHdlcmUgcHJvdmlkZWRgKTtcbiAgICB9XG5cbiAgICBpZiAoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcyAmJiAhXy5pc1BsYWluT2JqZWN0KHczY0NhcGFiaWxpdGllcykpIHtcbiAgICAgIC8vIElmIFczQyBDYXBhYmlsaXRpZXMgYW5kIE1KU09OV1AgQ2FwYWJpbGl0aWVzIHdlcmUgcHJvdmlkZWQgYW5kIFczQyBjYXBzIGFyZW4ndCBhIHBsYWluIG9iamVjdCxcbiAgICAgIC8vIGxvZyBhIHdhcm5pbmcgYW5kIGZhbGwgYmFjayB0byBNSlNPTldQXG4gICAgICBpZiAoIV8uaXNFbXB0eSh3M2NDYXBhYmlsaXRpZXMpKSB7XG4gICAgICAgIGxvZy53YXJuKGBFeHBlY3RlZCBXM0MgXCJjYXBhYmlsaXRpZXNcIiB0byBiZSBhIEpTT04gT2JqZWN0IGJ1dCB3YXMgcHJvdmlkZWQgd2l0aDogJHtKU09OLnN0cmluZ2lmeSh3M2NDYXBhYmlsaXRpZXMpfWApO1xuICAgICAgfVxuICAgICAgbG9nLndhcm4oYEZhbGxpbmcgYmFjayB0byBNSlNPTldQIGRlc2lyZWQgY2FwYWJpbGl0aWVzYCk7XG4gICAgICB0aGlzLnNldFByb3RvY29sTUpTT05XUCgpO1xuICAgICAgY2FwcyA9IGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQ3JlYXRpbmcgc2Vzc2lvbiB3aXRoIFczQyBjYXBhYmlsaXRpZXM6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeSh3M2NDYXBhYmlsaXRpZXMpKX1gKTtcbiAgICAgIGNhcHMgPSBwcm9jZXNzQ2FwYWJpbGl0aWVzKHczY0NhcGFiaWxpdGllcywgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMsIHRoaXMuc2hvdWxkVmFsaWRhdGVDYXBzKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgdGhpcy5zZXRQcm90b2NvbE1KU09OV1AoKTtcbiAgICBsb2cuZGVidWcoYENyZWF0aW5nIHNlc3Npb24gd2l0aCBNSlNPTldQIGRlc2lyZWQgY2FwYWJpbGl0aWVzOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcykpfWApO1xuICAgIGNhcHMgPSBqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzIHx8IHt9O1xuICB9XG5cbiAgY2FwcyA9IGZpeENhcHMoY2FwcywgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMpO1xuICB0aGlzLnZhbGlkYXRlRGVzaXJlZENhcHMoY2Fwcyk7XG5cbiAgdGhpcy5zZXNzaW9uSWQgPSBVVUlELmNyZWF0ZSgpLmhleDtcbiAgdGhpcy5jYXBzID0gY2FwcztcbiAgdGhpcy5vcHRzID0gXy5jbG9uZURlZXAodGhpcy5pbml0aWFsT3B0cyk7XG5cbiAgLy8gbWVyZ2UgY2FwcyBvbnRvIG9wdHMgc28gd2UgZG9uJ3QgbmVlZCB0byB3b3JyeSBhYm91dCB3aGF0J3Mgd2hlcmVcbiAgT2JqZWN0LmFzc2lnbih0aGlzLm9wdHMsIHRoaXMuY2Fwcyk7XG5cbiAgLy8gZGVhbCB3aXRoIHJlc2V0c1xuICAvLyBzb21lIHBlb3BsZSBsaWtlIHRvIGRvIHdlaXJkIHRoaW5ncyBieSBzZXR0aW5nIG5vUmVzZXQgYW5kIGZ1bGxSZXNldFxuICAvLyBib3RoIHRvIHRydWUsIGJ1dCB0aGlzIGlzIG1pc2d1aWRlZCBhbmQgc3RyYW5nZSwgc28gZXJyb3IgaGVyZSBpbnN0ZWFkXG4gIGlmICh0aGlzLm9wdHMubm9SZXNldCAmJiB0aGlzLm9wdHMuZnVsbFJlc2V0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVGhlICdub1Jlc2V0JyBhbmQgJ2Z1bGxSZXNldCcgY2FwYWJpbGl0aWVzIGFyZSBtdXR1YWxseSBcIiArXG4gICAgICAgICAgICAgICAgICAgICdleGNsdXNpdmUgYW5kIHNob3VsZCBub3QgYm90aCBiZSBzZXQgdG8gdHJ1ZS4gWW91ICcgK1xuICAgICAgICAgICAgICAgICAgICBcInByb2JhYmx5IG1lYW50IHRvIGp1c3QgdXNlICdmdWxsUmVzZXQnIG9uIGl0cyBvd25cIik7XG4gIH1cbiAgaWYgKHRoaXMub3B0cy5ub1Jlc2V0ID09PSB0cnVlKSB7XG4gICAgdGhpcy5vcHRzLmZ1bGxSZXNldCA9IGZhbHNlO1xuICB9XG4gIGlmICh0aGlzLm9wdHMuZnVsbFJlc2V0ID09PSB0cnVlKSB7XG4gICAgdGhpcy5vcHRzLm5vUmVzZXQgPSBmYWxzZTtcbiAgfVxuICB0aGlzLm9wdHMuZmFzdFJlc2V0ID0gIXRoaXMub3B0cy5mdWxsUmVzZXQgJiYgIXRoaXMub3B0cy5ub1Jlc2V0O1xuICB0aGlzLm9wdHMuc2tpcFVuaW5zdGFsbCA9IHRoaXMub3B0cy5mYXN0UmVzZXQgfHwgdGhpcy5vcHRzLm5vUmVzZXQ7XG5cbiAgLy8gUHJldmVudHMgZW1wdHkgc3RyaW5nIGNhcHMgc28gd2UgZG9uJ3QgbmVlZCB0byB0ZXN0IGl0IGV2ZXJ5d2hlcmVcbiAgaWYgKHR5cGVvZiB0aGlzLm9wdHMuYXBwID09PSAnc3RyaW5nJyAmJiB0aGlzLm9wdHMuYXBwLnRyaW0oKSA9PT0gJycpIHtcbiAgICB0aGlzLm9wdHMuYXBwID0gbnVsbDtcbiAgfVxuXG4gIGlmICghXy5pc1VuZGVmaW5lZCh0aGlzLmNhcHMubmV3Q29tbWFuZFRpbWVvdXQpKSB7XG4gICAgdGhpcy5uZXdDb21tYW5kVGltZW91dE1zID0gKHRoaXMuY2Fwcy5uZXdDb21tYW5kVGltZW91dCAqIDEwMDApO1xuICB9XG5cbiAgLy8gV2UgbmVlZCB0byBpbmluaXRpYWxpemUgb25lIG9uVW5leHBlY3RlZFNodXRkb3cgcHJvbWlzZSBwZXIgc2Vzc2lvblxuICAvLyB0byBhdm9pZCB0aGUgcHJvbWlzZSBmdWxmaWxtZW50IGJlaW5nIHByb3BhZ2F0ZWQgYmV0d2VlbiBzZXNzaW9ucy5cbiAgdGhpcy5yZXNldE9uVW5leHBlY3RlZFNodXRkb3duKCk7XG5cbiAgbG9nLmluZm8oYFNlc3Npb24gY3JlYXRlZCB3aXRoIHNlc3Npb24gaWQ6ICR7dGhpcy5zZXNzaW9uSWR9YCk7XG5cbiAgcmV0dXJuIFt0aGlzLnNlc3Npb25JZCwgY2Fwc107XG59O1xuXG5jb21tYW5kcy5nZXRTZXNzaW9ucyA9IGFzeW5jIGZ1bmN0aW9uICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIGxldCByZXQgPSBbXTtcblxuICBpZiAodGhpcy5zZXNzaW9uSWQpIHtcbiAgICByZXQucHVzaCh7XG4gICAgICBpZDogdGhpcy5zZXNzaW9uSWQsXG4gICAgICBjYXBhYmlsaXRpZXM6IHRoaXMuY2Fwc1xuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHJldDtcbn07XG5cbmNvbW1hbmRzLmdldFNlc3Npb24gPSBhc3luYyBmdW5jdGlvbiAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICBpZiAodGhpcy5jYXBzLmV2ZW50VGltaW5ncykge1xuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmNhcHMsIHtldmVudHM6IHRoaXMuZXZlbnRIaXN0b3J5fSk7XG4gIH1cbiAgcmV0dXJuIHRoaXMuY2Fwcztcbn07XG5cbmNvbW1hbmRzLmRlbGV0ZVNlc3Npb24gPSBhc3luYyBmdW5jdGlvbiAoLyogc2Vzc2lvbklkICovKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICB0aGlzLmNsZWFyTmV3Q29tbWFuZFRpbWVvdXQoKTtcbiAgdGhpcy5zZXNzaW9uSWQgPSBudWxsO1xufTtcblxuZnVuY3Rpb24gZml4Q2FwcyAob3JpZ2luYWxDYXBzLCBkZXNpcmVkQ2FwQ29uc3RyYWludHMgPSB7fSkge1xuICBsZXQgY2FwcyA9IF8uY2xvbmUob3JpZ2luYWxDYXBzKTtcblxuICAvLyBib29sZWFuIGNhcGFiaWxpdGllcyBjYW4gYmUgcGFzc2VkIGluIGFzIHN0cmluZ3MgJ2ZhbHNlJyBhbmQgJ3RydWUnXG4gIC8vIHdoaWNoIHdlIHdhbnQgdG8gdHJhbnNsYXRlIGludG8gYm9vbGVhbiB2YWx1ZXNcbiAgbGV0IGJvb2xlYW5DYXBzID0gXy5rZXlzKF8ucGlja0J5KGRlc2lyZWRDYXBDb25zdHJhaW50cywgKGspID0+IGsuaXNCb29sZWFuID09PSB0cnVlKSk7XG4gIGZvciAobGV0IGNhcCBvZiBib29sZWFuQ2Fwcykge1xuICAgIGxldCB2YWx1ZSA9IG9yaWdpbmFsQ2Fwc1tjYXBdO1xuICAgIGlmIChfLmlzU3RyaW5nKHZhbHVlKSkge1xuICAgICAgdmFsdWUgPSB2YWx1ZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKHZhbHVlID09PSAndHJ1ZScgfHwgdmFsdWUgPT09ICdmYWxzZScpIHtcbiAgICAgICAgbG9nLndhcm4oYENhcGFiaWxpdHkgJyR7Y2FwfScgY2hhbmdlZCBmcm9tIHN0cmluZyB0byBib29sZWFuLiBUaGlzIG1heSBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW9yYCk7XG4gICAgICAgIGNhcHNbY2FwXSA9ICh2YWx1ZSA9PT0gJ3RydWUnKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBpbnQgY2FwYWJpbGl0aWVzIGFyZSBvZnRlbiBzZW50IGluIGFzIHN0cmluZ3MgYnkgZnJhbWV3b3Jrc1xuICBsZXQgaW50Q2FwcyA9IF8ua2V5cyhfLnBpY2tCeShkZXNpcmVkQ2FwQ29uc3RyYWludHMsIChrKSA9PiBrLmlzTnVtYmVyID09PSB0cnVlKSk7XG4gIGZvciAobGV0IGNhcCBvZiBpbnRDYXBzKSB7XG4gICAgbGV0IHZhbHVlID0gb3JpZ2luYWxDYXBzW2NhcF07XG4gICAgaWYgKF8uaXNTdHJpbmcodmFsdWUpICYmICFpc05hTih2YWx1ZSkpIHtcbiAgICAgIHZhbHVlID0gdmFsdWUudHJpbSgpO1xuICAgICAgbGV0IG5ld1ZhbHVlID0gcGFyc2VJbnQodmFsdWUsIDEwKTtcbiAgICAgIGlmICh2YWx1ZSAhPT0gYCR7bmV3VmFsdWV9YCkge1xuICAgICAgICBuZXdWYWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpO1xuICAgICAgfVxuICAgICAgbG9nLndhcm4oYENhcGFiaWxpdHkgJyR7Y2FwfScgY2hhbmdlZCBmcm9tIHN0cmluZyAoJyR7dmFsdWV9JykgdG8gaW50ZWdlciAoJHtuZXdWYWx1ZX0pLiBUaGlzIG1heSBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW9yYCk7XG4gICAgICBjYXBzW2NhcF0gPSBuZXdWYWx1ZTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gY2Fwcztcbn1cblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3Nlc3Npb24uanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4ifQ==
