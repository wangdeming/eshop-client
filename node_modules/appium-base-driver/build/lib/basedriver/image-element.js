"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getImgElFromArgs = getImgElFromArgs;
exports.makeImageElementCache = makeImageElementCache;
exports.IMAGE_EL_TAP_STRATEGY_W3C = exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = exports.ImageElement = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../..");

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _protocol = require("../protocol/protocol");

var _logger = _interopRequireDefault(require("./logger"));

var _uuidJs = _interopRequireDefault(require("uuid-js"));

const MAX_CACHE_SIZE = 1024 * 1024 * 40;
const TAP_DURATION_MS = 125;
const IMAGE_EL_TAP_STRATEGY_W3C = 'w3cActions';
exports.IMAGE_EL_TAP_STRATEGY_W3C = IMAGE_EL_TAP_STRATEGY_W3C;
const IMAGE_EL_TAP_STRATEGY_MJSONWP = 'touchActions';
exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = IMAGE_EL_TAP_STRATEGY_MJSONWP;
const IMAGE_TAP_STRATEGIES = [IMAGE_EL_TAP_STRATEGY_MJSONWP, IMAGE_EL_TAP_STRATEGY_W3C];

class ImageElement {
  constructor(b64Template, rect) {
    this.template = b64Template;
    this.rect = rect;
    this.id = `${_protocol.IMAGE_ELEMENT_PREFIX}${_uuidJs.default.create().hex}`;
  }

  get size() {
    return {
      width: this.rect.width,
      height: this.rect.height
    };
  }

  get location() {
    return {
      x: this.rect.x,
      y: this.rect.y
    };
  }

  get center() {
    return {
      x: this.rect.x + this.rect.width / 2,
      y: this.rect.y + this.rect.height / 2
    };
  }

  asElement(protocolKey) {
    return {
      [protocolKey]: this.id
    };
  }

  equals(other) {
    return this.rect.x === other.rect.x && this.rect.y === other.rect.y && this.rect.width === other.rect.width && this.rect.height === other.rect.height;
  }

  async click(driver) {
    let newImgEl;
    const {
      autoUpdateImageElementPosition: updatePos,
      checkForImageElementStaleness,
      imageElementTapStrategy
    } = driver.settings.getSettings();

    if (!IMAGE_TAP_STRATEGIES.includes(imageElementTapStrategy)) {
      throw new Error(`Incorrect imageElementTapStrategy setting ` + `'${imageElementTapStrategy}'. Must be one of ` + JSON.stringify(IMAGE_TAP_STRATEGIES));
    }

    if (checkForImageElementStaleness || updatePos) {
      _logger.default.info('Checking image element for staleness before clicking');

      try {
        newImgEl = await driver.findByImage(this.template, {
          shouldCheckStaleness: true
        });
      } catch (err) {
        throw new _2.errors.StaleElementReferenceError();
      }

      if (!this.equals(newImgEl)) {
        _logger.default.warn(`When trying to click on an image element, the image changed ` + `position from where it was originally found. It is now at ` + `${JSON.stringify(newImgEl.rect)} and was originally at ` + `${JSON.stringify(this.rect)}.`);

        if (updatePos) {
          _logger.default.warn('Click will proceed at new coordinates');

          this.rect = _lodash.default.clone(newImgEl.rect);
        } else {
          _logger.default.warn('Click will take place at original coordinates. If you ' + 'would like Appium to automatically click the new ' + "coordinates, set the 'autoUpdateImageElementPosition' " + 'setting to true');
        }
      }
    }

    const {
      x,
      y
    } = this.center;

    _logger.default.info(`Will tap on image element at coordinate [${x}, ${y}]`);

    if (imageElementTapStrategy === IMAGE_EL_TAP_STRATEGY_W3C) {
      _logger.default.info('Will tap using W3C actions');

      const action = {
        type: 'pointer',
        id: 'mouse',
        parameters: {
          pointerType: 'touch'
        },
        actions: [{
          type: 'pointerMove',
          x,
          y,
          duration: 0
        }, {
          type: 'pointerDown'
        }, {
          type: 'pause',
          duration: TAP_DURATION_MS
        }, {
          type: 'pointerUp'
        }]
      };

      if (driver.performActions) {
        return await driver.performActions([action]);
      }

      _logger.default.warn('Driver does not seem to implement W3C actions, falling back ' + 'to TouchActions');
    }

    _logger.default.info('Will tap using MJSONWP TouchActions');

    const action = {
      action: 'tap',
      options: {
        x,
        y
      }
    };

    if (driver.performTouch) {
      return await driver.performTouch([action]);
    }

    throw new Error("Driver did not implement the 'performTouch' command. " + 'For drivers to support finding image elements, they ' + "should support 'performTouch' and 'performActions'");
  }

  static async execute(driver, cmd, imgElId) {
    if (!driver._imgElCache.has(imgElId)) {
      throw new _2.errors.NoSuchElementError();
    }

    const imgEl = driver._imgElCache.get(imgElId);

    switch (cmd) {
      case 'click':
        return await imgEl.click(driver);

      case 'elementDisplayed':
        return true;

      case 'getSize':
        return imgEl.size;

      case 'getLocation':
      case 'getLocationInView':
        return imgEl.location;

      case 'getElementRect':
        return imgEl.rect;

      default:
        throw new _2.errors.NotYetImplementedError();
    }
  }

}

exports.ImageElement = ImageElement;

function makeImageElementCache(max = MAX_CACHE_SIZE) {
  return new _lruCache.default({
    max,
    length: el => el.template.length
  });
}

function getImgElFromArgs(args) {
  for (let arg of args) {
    if (_lodash.default.isString(arg) && arg.startsWith(_protocol.IMAGE_ELEMENT_PREFIX)) {
      return arg;
    }
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2ltYWdlLWVsZW1lbnQuanMiXSwibmFtZXMiOlsiTUFYX0NBQ0hFX1NJWkUiLCJUQVBfRFVSQVRJT05fTVMiLCJJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDIiwiSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AiLCJJTUFHRV9UQVBfU1RSQVRFR0lFUyIsIkltYWdlRWxlbWVudCIsImNvbnN0cnVjdG9yIiwiYjY0VGVtcGxhdGUiLCJyZWN0IiwidGVtcGxhdGUiLCJpZCIsIklNQUdFX0VMRU1FTlRfUFJFRklYIiwiVVVJRCIsImNyZWF0ZSIsImhleCIsInNpemUiLCJ3aWR0aCIsImhlaWdodCIsImxvY2F0aW9uIiwieCIsInkiLCJjZW50ZXIiLCJhc0VsZW1lbnQiLCJwcm90b2NvbEtleSIsImVxdWFscyIsIm90aGVyIiwiY2xpY2siLCJkcml2ZXIiLCJuZXdJbWdFbCIsImF1dG9VcGRhdGVJbWFnZUVsZW1lbnRQb3NpdGlvbiIsInVwZGF0ZVBvcyIsImNoZWNrRm9ySW1hZ2VFbGVtZW50U3RhbGVuZXNzIiwiaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3kiLCJzZXR0aW5ncyIsImdldFNldHRpbmdzIiwiaW5jbHVkZXMiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJsb2ciLCJpbmZvIiwiZmluZEJ5SW1hZ2UiLCJzaG91bGRDaGVja1N0YWxlbmVzcyIsImVyciIsImVycm9ycyIsIlN0YWxlRWxlbWVudFJlZmVyZW5jZUVycm9yIiwid2FybiIsIl8iLCJjbG9uZSIsImFjdGlvbiIsInR5cGUiLCJwYXJhbWV0ZXJzIiwicG9pbnRlclR5cGUiLCJhY3Rpb25zIiwiZHVyYXRpb24iLCJwZXJmb3JtQWN0aW9ucyIsIm9wdGlvbnMiLCJwZXJmb3JtVG91Y2giLCJleGVjdXRlIiwiY21kIiwiaW1nRWxJZCIsIl9pbWdFbENhY2hlIiwiaGFzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiaW1nRWwiLCJnZXQiLCJOb3RZZXRJbXBsZW1lbnRlZEVycm9yIiwibWFrZUltYWdlRWxlbWVudENhY2hlIiwibWF4IiwiTFJVIiwibGVuZ3RoIiwiZWwiLCJnZXRJbWdFbEZyb21BcmdzIiwiYXJncyIsImFyZyIsImlzU3RyaW5nIiwic3RhcnRzV2l0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGNBQWMsR0FBRyxPQUFPLElBQVAsR0FBYyxFQUFyQztBQUNBLE1BQU1DLGVBQWUsR0FBRyxHQUF4QjtBQUNBLE1BQU1DLHlCQUF5QixHQUFHLFlBQWxDOztBQUNBLE1BQU1DLDZCQUE2QixHQUFHLGNBQXRDOztBQUNBLE1BQU1DLG9CQUFvQixHQUFHLENBQzNCRCw2QkFEMkIsRUFFM0JELHlCQUYyQixDQUE3Qjs7QUE2QkEsTUFBTUcsWUFBTixDQUFtQjtBQVNqQkMsRUFBQUEsV0FBVyxDQUFFQyxXQUFGLEVBQWVDLElBQWYsRUFBcUI7QUFDOUIsU0FBS0MsUUFBTCxHQUFnQkYsV0FBaEI7QUFDQSxTQUFLQyxJQUFMLEdBQVlBLElBQVo7QUFDQSxTQUFLRSxFQUFMLEdBQVcsR0FBRUMsOEJBQXFCLEdBQUVDLGdCQUFLQyxNQUFMLEdBQWNDLEdBQUksRUFBdEQ7QUFDRDs7QUFLRCxNQUFJQyxJQUFKLEdBQVk7QUFDVixXQUFPO0FBQUNDLE1BQUFBLEtBQUssRUFBRSxLQUFLUixJQUFMLENBQVVRLEtBQWxCO0FBQXlCQyxNQUFBQSxNQUFNLEVBQUUsS0FBS1QsSUFBTCxDQUFVUztBQUEzQyxLQUFQO0FBQ0Q7O0FBS0QsTUFBSUMsUUFBSixHQUFnQjtBQUNkLFdBQU87QUFBQ0MsTUFBQUEsQ0FBQyxFQUFFLEtBQUtYLElBQUwsQ0FBVVcsQ0FBZDtBQUFpQkMsTUFBQUEsQ0FBQyxFQUFFLEtBQUtaLElBQUwsQ0FBVVk7QUFBOUIsS0FBUDtBQUNEOztBQUtELE1BQUlDLE1BQUosR0FBYztBQUNaLFdBQU87QUFDTEYsTUFBQUEsQ0FBQyxFQUFFLEtBQUtYLElBQUwsQ0FB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IGVycm9ycyB9IGZyb20gJy4uLy4uJztcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcbmltcG9ydCB7IElNQUdFX0VMRU1FTlRfUFJFRklYIH0gZnJvbSAnLi4vcHJvdG9jb2wvcHJvdG9jb2wnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgVVVJRCBmcm9tICd1dWlkLWpzJztcblxuY29uc3QgTUFYX0NBQ0hFX1NJWkUgPSAxMDI0ICogMTAyNCAqIDQwOyAvLyA0MG1iXG5jb25zdCBUQVBfRFVSQVRJT05fTVMgPSAxMjU7XG5jb25zdCBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDID0gJ3czY0FjdGlvbnMnO1xuY29uc3QgSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AgPSAndG91Y2hBY3Rpb25zJztcbmNvbnN0IElNQUdFX1RBUF9TVFJBVEVHSUVTID0gW1xuICBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfTUpTT05XUCxcbiAgSU1BR0VfRUxfVEFQX1NUUkFURUdZX1czQ1xuXTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBSZWN0XG4gKiBAcHJvcGVydHkge2ludH0geCAtIHgtY29vcmRpbmF0ZSBvZiB0b3AtbGVmdCBjb3JuZXJcbiAqIEBwcm9wZXJ0eSB7aW50fSB5IC0geS1jb29yZGluYXRlIG9mIHRvcC1sZWZ0IGNvcm5lclxuICogQHByb3BlcnR5IHtpbnR9IHdpZHRoIC0gd2lkdGggb2YgcmVjdFxuICogQHByb3BlcnR5IHtpbnR9IGhlaWdodCAtIGhlaWdodCBvZiByZWN0XG4gKi9cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBEaW1lbnNpb25cbiAqIEBwcm9wZXJ0eSB7aW50fSB3aWR0aCAtIHdpZHRoIG9mIHJlY3RcbiAqIEBwcm9wZXJ0eSB7aW50fSBoZWlnaHQgLSBoZWlnaHQgb2YgcmVjdFxuICovXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUG9zaXRpb25cbiAqIEBwcm9wZXJ0eSB7aW50fSB4IC0geCBjb29yZGluYXRlXG4gKiBAcHJvcGVydHkge2ludH0geSAtIHkgY29vcmRpbmF0ZVxuICovXG5cbi8qKlxuICogUmVwcmVzZW50YXRpb24gb2YgYW4gXCJpbWFnZSBlbGVtZW50XCIsIHdoaWNoIGlzIHNpbXBseSBhIHNldCBvZiBjb29yZGluYXRlc1xuICogYW5kIG1ldGhvZHMgdGhhdCBjYW4gYmUgdXNlZCBvbiB0aGF0IHNldCBvZiBjb29yZGluYXRlcyB2aWEgdGhlIGRyaXZlclxuICovXG5jbGFzcyBJbWFnZUVsZW1lbnQge1xuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYjY0VGVtcGxhdGUgLSB0aGUgYmFzZTY0LWVuY29kZWQgaW1hZ2Ugd2hpY2ggd2FzIHVzZWQgdG9cbiAgICogZmluZCB0aGlzIEltYWdlRWxlbWVudFxuICAgKiBAcGFyYW0ge1JlY3R9IHJlY3QgLSBib3VuZHMgb2YgbWF0Y2hlZCBpbWFnZSBlbGVtZW50XG4gICAqXG4gICAqIEByZXR1cm5zIHtJbWFnZUVsZW1lbnR9XG4gICAqL1xuICBjb25zdHJ1Y3RvciAoYjY0VGVtcGxhdGUsIHJlY3QpIHtcbiAgICB0aGlzLnRlbXBsYXRlID0gYjY0VGVtcGxhdGU7XG4gICAgdGhpcy5yZWN0ID0gcmVjdDtcbiAgICB0aGlzLmlkID0gYCR7SU1BR0VfRUxFTUVOVF9QUkVGSVh9JHtVVUlELmNyZWF0ZSgpLmhleH1gO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtEaW1lbnNpb259IC0gZGltZW5zaW9uIG9mIGVsZW1lbnRcbiAgICovXG4gIGdldCBzaXplICgpIHtcbiAgICByZXR1cm4ge3dpZHRoOiB0aGlzLnJlY3Qud2lkdGgsIGhlaWdodDogdGhpcy5yZWN0LmhlaWdodH07XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge1Bvc2l0aW9ufSAtIGNvb3JkaW5hdGVzIG9mIHRvcC1sZWZ0IGNvcm5lciBvZiBlbGVtZW50XG4gICAqL1xuICBnZXQgbG9jYXRpb24gKCkge1xuICAgIHJldHVybiB7eDogdGhpcy5yZWN0LngsIHk6IHRoaXMucmVjdC55fTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7UG9zaXRpb259IC0gY29vcmRpbmF0ZXMgb2YgY2VudGVyIG9mIGVsZW1lbnRcbiAgICovXG4gIGdldCBjZW50ZXIgKCkge1xuICAgIHJldHVybiB7XG4gICAgICB4OiB0aGlzLnJlY3QueCArIHRoaXMucmVjdC53aWR0aCAvIDIsXG4gICAgICB5OiB0aGlzLnJlY3QueSArIHRoaXMucmVjdC5oZWlnaHQgLyAyLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IHByb3RvY29sS2V5IC0gdGhlIHByb3RvY29sLXNwZWNpZmljIEpTT04ga2V5IGZvclxuICAgKiBhIFdlYkVsZW1lbnRcbiAgICpcbiAgICogQHJldHVybnMge1dlYkVsZW1lbnR9IC0gdGhpcyBpbWFnZSBlbGVtZW50IGFzIGEgV2ViRWxlbWVudFxuICAgKi9cbiAgYXNFbGVtZW50IChwcm90b2NvbEtleSkge1xuICAgIHJldHVybiB7W3Byb3RvY29sS2V5XTogdGhpcy5pZH07XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtJbWFnZUVsZW1lbnR9IG90aGVyIC0gYW4gSW1hZ2VFbGVtZW50IHRvIGNvbXBhcmUgd2l0aCB0aGlzIG9uZVxuICAgKlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gLSB3aGV0aGVyIHRoZSBvdGhlciBlbGVtZW50IGFuZCB0aGlzIG9uZSBoYXZlIHRoZSBzYW1lXG4gICAqIHByb3BlcnRpZXNcbiAgICovXG4gIGVxdWFscyAob3RoZXIpIHtcbiAgICByZXR1cm4gdGhpcy5yZWN0LnggPT09IG90aGVyLnJlY3QueCAmJlxuICAgICAgICAgICB0aGlzLnJlY3QueSA9PT0gb3RoZXIucmVjdC55ICYmXG4gICAgICAgICAgIHRoaXMucmVjdC53aWR0aCA9PT0gb3RoZXIucmVjdC53aWR0aCAmJlxuICAgICAgICAgICB0aGlzLnJlY3QuaGVpZ2h0ID09PSBvdGhlci5yZWN0LmhlaWdodDtcbiAgfVxuXG4gIC8qKlxuICAgKiBVc2UgYSBkcml2ZXIgdG8gdGFwIHRoZSBzY3JlZW4gYXQgdGhlIGNlbnRlciBvZiB0aGlzIEltYWdlRWxlbWVudCdzXG4gICAqIHBvc2l0aW9uXG4gICAqXG4gICAqIEBwYXJhbSB7QmFzZURyaXZlcn0gZHJpdmVyIC0gZHJpdmVyIGZvciBjYWxsaW5nIGFjdGlvbnMgd2l0aFxuICAgKi9cbiAgYXN5bmMgY2xpY2sgKGRyaXZlcikge1xuICAgIC8vIGJlZm9yZSB3ZSBjbGljayB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgZWxlbWVudCBpcyBhY3R1YWxseSBzdGlsbCB0aGVyZVxuICAgIC8vIHdoZXJlIHdlIGV4cGVjdCBpdCB0byBiZVxuICAgIGxldCBuZXdJbWdFbDtcbiAgICBjb25zdCB7XG4gICAgICBhdXRvVXBkYXRlSW1hZ2VFbGVtZW50UG9zaXRpb246IHVwZGF0ZVBvcyxcbiAgICAgIGNoZWNrRm9ySW1hZ2VFbGVtZW50U3RhbGVuZXNzLFxuICAgICAgaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3ksXG4gICAgfSA9IGRyaXZlci5zZXR0aW5ncy5nZXRTZXR0aW5ncygpO1xuXG4gICAgLy8gdmFsaWRhdGUgdGFwIHN0cmF0ZWd5XG4gICAgaWYgKCFJTUFHRV9UQVBfU1RSQVRFR0lFUy5pbmNsdWRlcyhpbWFnZUVsZW1lbnRUYXBTdHJhdGVneSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW5jb3JyZWN0IGltYWdlRWxlbWVudFRhcFN0cmF0ZWd5IHNldHRpbmcgYCArXG4gICAgICAgICAgICAgICAgICAgICAgYCcke2ltYWdlRWxlbWVudFRhcFN0cmF0ZWd5fScuIE11c3QgYmUgb25lIG9mIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KElNQUdFX1RBUF9TVFJBVEVHSUVTKSk7XG4gICAgfVxuXG4gICAgaWYgKGNoZWNrRm9ySW1hZ2VFbGVtZW50U3RhbGVuZXNzIHx8IHVwZGF0ZVBvcykge1xuICAgICAgbG9nLmluZm8oJ0NoZWNraW5nIGltYWdlIGVsZW1lbnQgZm9yIHN0YWxlbmVzcyBiZWZvcmUgY2xpY2tpbmcnKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIG5ld0ltZ0VsID0gYXdhaXQgZHJpdmVyLmZpbmRCeUltYWdlKHRoaXMudGVtcGxhdGUsIHtcbiAgICAgICAgICBzaG91bGRDaGVja1N0YWxlbmVzczogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLlN0YWxlRWxlbWVudFJlZmVyZW5jZUVycm9yKCk7XG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5lcXVhbHMobmV3SW1nRWwpKSB7XG4gICAgICAgIGxvZy53YXJuKGBXaGVuIHRyeWluZyB0byBjbGljayBvbiBhbiBpbWFnZSBlbGVtZW50LCB0aGUgaW1hZ2UgY2hhbmdlZCBgICtcbiAgICAgICAgICAgICAgICAgYHBvc2l0aW9uIGZyb20gd2hlcmUgaXQgd2FzIG9yaWdpbmFsbHkgZm91bmQuIEl0IGlzIG5vdyBhdCBgICtcbiAgICAgICAgICAgICAgICAgYCR7SlNPTi5zdHJpbmdpZnkobmV3SW1nRWwucmVjdCl9IGFuZCB3YXMgb3JpZ2luYWxseSBhdCBgICtcbiAgICAgICAgICAgICAgICAgYCR7SlNPTi5zdHJpbmdpZnkodGhpcy5yZWN0KX0uYCk7XG4gICAgICAgIGlmICh1cGRhdGVQb3MpIHtcbiAgICAgICAgICBsb2cud2FybignQ2xpY2sgd2lsbCBwcm9jZWVkIGF0IG5ldyBjb29yZGluYXRlcycpO1xuICAgICAgICAgIHRoaXMucmVjdCA9IF8uY2xvbmUobmV3SW1nRWwucmVjdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG9nLndhcm4oJ0NsaWNrIHdpbGwgdGFrZSBwbGFjZSBhdCBvcmlnaW5hbCBjb29yZGluYXRlcy4gSWYgeW91ICcgK1xuICAgICAgICAgICAgICAgICAgICd3b3VsZCBsaWtlIEFwcGl1bSB0byBhdXRvbWF0aWNhbGx5IGNsaWNrIHRoZSBuZXcgJyArXG4gICAgICAgICAgICAgICAgICAgXCJjb29yZGluYXRlcywgc2V0IHRoZSAnYXV0b1VwZGF0ZUltYWdlRWxlbWVudFBvc2l0aW9uJyBcIiArXG4gICAgICAgICAgICAgICAgICAgJ3NldHRpbmcgdG8gdHJ1ZScpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qge3gsIHl9ID0gdGhpcy5jZW50ZXI7XG4gICAgbG9nLmluZm8oYFdpbGwgdGFwIG9uIGltYWdlIGVsZW1lbnQgYXQgY29vcmRpbmF0ZSBbJHt4fSwgJHt5fV1gKTtcblxuICAgIGlmIChpbWFnZUVsZW1lbnRUYXBTdHJhdGVneSA9PT0gSU1BR0VfRUxfVEFQX1NUUkFURUdZX1czQykge1xuICAgICAgLy8gc2V0IHVwIGEgVzNDIGFjdGlvbiB0byBjbGljayBvbiB0aGUgaW1hZ2UgYnkgcG9zaXRpb25cbiAgICAgIGxvZy5pbmZvKCdXaWxsIHRhcCB1c2luZyBXM0MgYWN0aW9ucycpO1xuICAgICAgY29uc3QgYWN0aW9uID0ge1xuICAgICAgICB0eXBlOiAncG9pbnRlcicsXG4gICAgICAgIGlkOiAnbW91c2UnLFxuICAgICAgICBwYXJhbWV0ZXJzOiB7cG9pbnRlclR5cGU6ICd0b3VjaCd9LFxuICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAge3R5cGU6ICdwb2ludGVyTW92ZScsIHgsIHksIGR1cmF0aW9uOiAwfSxcbiAgICAgICAgICB7dHlwZTogJ3BvaW50ZXJEb3duJ30sXG4gICAgICAgICAge3R5cGU6ICdwYXVzZScsIGR1cmF0aW9uOiBUQVBfRFVSQVRJT05fTVN9LFxuICAgICAgICAgIHt0eXBlOiAncG9pbnRlclVwJ30sXG4gICAgICAgIF1cbiAgICAgIH07XG5cbiAgICAgIC8vIGNoZWNrIGlmIHRoZSBkcml2ZXIgaGFzIHRoZSBhcHByb3ByaWF0ZSBwZXJmb3JtQWN0aW9ucyBtZXRob2RcbiAgICAgIGlmIChkcml2ZXIucGVyZm9ybUFjdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IGRyaXZlci5wZXJmb3JtQWN0aW9ucyhbYWN0aW9uXSk7XG4gICAgICB9XG5cbiAgICAgIC8vIGlmIG5vdCwgd2FybiBhbmQgZmFsbCBiYWNrIHRvIHRoZSBvdGhlciBtZXRob2RcbiAgICAgIGxvZy53YXJuKCdEcml2ZXIgZG9lcyBub3Qgc2VlbSB0byBpbXBsZW1lbnQgVzNDIGFjdGlvbnMsIGZhbGxpbmcgYmFjayAnICtcbiAgICAgICAgICAgICAgICd0byBUb3VjaEFjdGlvbnMnKTtcbiAgICB9XG5cbiAgICAvLyBpZiB0aGUgdzNjIHN0cmF0ZWd5IHdhcyBub3QgcmVxdWVzdGVkLCBkbyB0aGUgb25seSBvdGhlciBvcHRpb24gKG1qc29ud3BcbiAgICAvLyB0b3VjaCBhY3Rpb25zKVxuICAgIGxvZy5pbmZvKCdXaWxsIHRhcCB1c2luZyBNSlNPTldQIFRvdWNoQWN0aW9ucycpO1xuICAgIGNvbnN0IGFjdGlvbiA9IHtcbiAgICAgIGFjdGlvbjogJ3RhcCcsXG4gICAgICBvcHRpb25zOiB7eCwgeX1cbiAgICB9O1xuXG4gICAgaWYgKGRyaXZlci5wZXJmb3JtVG91Y2gpIHtcbiAgICAgIHJldHVybiBhd2FpdCBkcml2ZXIucGVyZm9ybVRvdWNoKFthY3Rpb25dKTtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJEcml2ZXIgZGlkIG5vdCBpbXBsZW1lbnQgdGhlICdwZXJmb3JtVG91Y2gnIGNvbW1hbmQuIFwiICtcbiAgICAgICAgICAgICAgICAgICAgJ0ZvciBkcml2ZXJzIHRvIHN1cHBvcnQgZmluZGluZyBpbWFnZSBlbGVtZW50cywgdGhleSAnICtcbiAgICAgICAgICAgICAgICAgICAgXCJzaG91bGQgc3VwcG9ydCAncGVyZm9ybVRvdWNoJyBhbmQgJ3BlcmZvcm1BY3Rpb25zJ1wiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgdmFyaW91cyBBcHBpdW0gY29tbWFuZHMgdGhhdCBpbnZvbHZlIGFuIGltYWdlIGVsZW1lbnRcbiAgICpcbiAgICogQHBhcmFtIHtCYXNlRHJpdmVyfSBkcml2ZXIgLSB0aGUgZHJpdmVyIHRvIHVzZSBmb3IgY29tbWFuZHNcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNtZCAtIHRoZSBuYW1lIG9mIHRoZSBkcml2ZXIgY29tbWFuZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gaW1nRWxJZCAtIHRoZSBpZCBvZiB0aGUgSW1hZ2VFbGVtZW50IHRvIHdvcmsgd2l0aFxuICAgKlxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIHRoZSByZXN1bHQgb2YgcnVubmluZyBhIGNvbW1hbmRcbiAgICovXG4gIHN0YXRpYyBhc3luYyBleGVjdXRlIChkcml2ZXIsIGNtZCwgaW1nRWxJZCkge1xuICAgIGlmICghZHJpdmVyLl9pbWdFbENhY2hlLmhhcyhpbWdFbElkKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbWdFbCA9IGRyaXZlci5faW1nRWxDYWNoZS5nZXQoaW1nRWxJZCk7XG5cbiAgICBzd2l0Y2ggKGNtZCkge1xuICAgICAgY2FzZSAnY2xpY2snOlxuICAgICAgICByZXR1cm4gYXdhaXQgaW1nRWwuY2xpY2soZHJpdmVyKTtcbiAgICAgIGNhc2UgJ2VsZW1lbnREaXNwbGF5ZWQnOlxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIGNhc2UgJ2dldFNpemUnOlxuICAgICAgICByZXR1cm4gaW1nRWwuc2l6ZTtcbiAgICAgIGNhc2UgJ2dldExvY2F0aW9uJzpcbiAgICAgIGNhc2UgJ2dldExvY2F0aW9uSW5WaWV3JzpcbiAgICAgICAgcmV0dXJuIGltZ0VsLmxvY2F0aW9uO1xuICAgICAgY2FzZSAnZ2V0RWxlbWVudFJlY3QnOlxuICAgICAgICByZXR1cm4gaW1nRWwucmVjdDtcbiAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBtYWtlSW1hZ2VFbGVtZW50Q2FjaGUgKG1heCA9IE1BWF9DQUNIRV9TSVpFKSB7XG4gIHJldHVybiBuZXcgTFJVKHtcbiAgICBtYXgsXG4gICAgbGVuZ3RoOiAoZWwpID0+IGVsLnRlbXBsYXRlLmxlbmd0aCxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldEltZ0VsRnJvbUFyZ3MgKGFyZ3MpIHtcbiAgZm9yIChsZXQgYXJnIG9mIGFyZ3MpIHtcbiAgICBpZiAoXy5pc1N0cmluZyhhcmcpICYmIGFyZy5zdGFydHNXaXRoKElNQUdFX0VMRU1FTlRfUFJFRklYKSkge1xuICAgICAgcmV0dXJuIGFyZztcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHtcbiAgSW1hZ2VFbGVtZW50LCBnZXRJbWdFbEZyb21BcmdzLCBtYWtlSW1hZ2VFbGVtZW50Q2FjaGUsXG4gIElNQUdFX0VMX1RBUF9TVFJBVEVHWV9NSlNPTldQLCBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDLFxufTtcbiJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvaW1hZ2UtZWxlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
